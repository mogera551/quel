(()=>{"use strict";const e=class{static raise(e){throw e}static isFunction=e=>{const t=Object.prototype.toString.call(e).slice(8,-1).toLowerCase();return"function"===t||"asyncfunction"===t};static isInputableElement(e){return e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement||e instanceof HTMLInputElement&&"button"!==e.type}};class t{html;css;ViewModel;#e;get template(){if(void 0===this.#e){const e=this.html?this.html.replaceAll(/\{\{([^\}]+)\}\}/g,((e,t)=>`\x3c!--@@${t}--\x3e`)):"";this.#e=document.createElement("template"),this.#e.innerHTML=(this.css?`<style>\n${this.css}\n</style>`:"")+e}return this.#e}set template(e){this.#e=e}}class n{static localeString=(e,t)=>{const n=Number(e);return isNaN(n)?"":n.toLocaleString()};static fixed=(e,t)=>{const n=Number(e);return isNaN(n)?"":n.toFixed(t[0]??0)};static styleDisplay=(e,t)=>e?t[0]??"":"none";static truthy=(e,t)=>!!e;static falsey=(e,t)=>!e;static not=this.falsey;static upperCase=(e,t)=>e?String(e).toUpperCase():"";static lowerCase=(e,t)=>e?String(e).toLowerCase():"";static eq=(e,t)=>e==t[0];static ne=(e,t)=>e!=t[0];static lt=(e,t)=>Number(e)<Number(t[0]);static le=(e,t)=>Number(e)<=Number(t[0]);static gt=(e,t)=>Number(e)>Number(t[0]);static ge=(e,t)=>Number(e)>=Number(t[0]);static embed=(e,t)=>decodeURI((t[0]??"").replaceAll("%s",e));static ifText=(e,t)=>e?t[0]??"":t[1]??"";static null=(e,t)=>null==e}class s{static number=(e,t)=>Number(e);static boolean=(e,t)=>Boolean(e)}class i{name;options;static applyForInput(e,t){return t.reduceRight(((e,t)=>t.name in s?s[t.name](e,t.options):e),e)}static applyForOutput(e,t){return t.reduce(((e,t)=>t.name in n?n[t.name](e,t.options):e),e)}static regist(t,i,o){t in n&&e.raise(`regist filter error duplicate name (${t})`),t in s&&e.raise(`regist filter error duplicate name (${t})`),i&&(n[t]=i),o&&(s[t]=o)}}class o{node;get element(){return this.node instanceof HTMLElement?this.node:e.raise("not HTMLElement")}nodeProperty;#t;get nodePropertyElements(){return this.#t}set nodePropertyElements(e){this.#t=e}component;viewModel;viewModelProperty;filters;#n;#s;get indexes(){return this.#n}set indexes(e){this.#n=e,this.#s=e.toString(),this.#i=this.viewModelProperty+"\t"+this.#s}get indexesString(){return this.#s}#i;get viewModelPropertyKey(){return this.#i}lastNodeValue;lastViewModelValue;updateNode(){}updateViewModel(){}changeIndexes(e,t){this.indexes[e]=this.indexes[e]+t}}const r=e=>Array.from(e.childNodes).flatMap((e=>r(e).concat((e=>e instanceof Comment&&"@"===e.textContent[0]&&"@"===e.textContent[1]&&"@"!==e.textContent[2])(e)?e:null))).filter((e=>e)),a=class{static listOfRouteIndexesByTemplate=new Map;static getTargetNodes(e,t){let n;return this.listOfRouteIndexesByTemplate.has(e)?n=this.listOfRouteIndexesByTemplate.get(e).map((e=>e.reduce(((e,t)=>e.childNodes[t]),t))):(n=Array.from(t.querySelectorAll("[data-bind]")).concat(r(t)),this.listOfRouteIndexesByTemplate.set(e,n.map((e=>(e=>{let t=[];for(;null!=e.parentNode;)t=[Array.from(e.parentNode.childNodes).indexOf(e)].concat(t),e=e.parentNode;return t})(e))))),n}},l=class{static bind(e,t,n){}},d="quel",p=Symbol.for(`${d}:viewModel.indexes`),c=Symbol.for(`${d}:viewModel.target`),h=Symbol.for(`${d}:viewModel.directGet`),u=Symbol.for(`${d}:viewModel.directSet`),m=Symbol.for(`${d}:viewModel.directCall`),y=Symbol.for(`${d}:viewModel.init`),f=Symbol.for(`${d}:viewModel.write`),w=Symbol.for(`${d}:viewModel.clearCache`),g=Symbol.for(`${d}:arrayHandler.isProxy`),v=Symbol.for(`${d}:arrayHandler.raw`);class P{binds;childNodes;fragment;get lastNode(){return this.childNodes[this.childNodes.length-1]}get nodesForAppend(){return this.fragment.childNodes.length>0?[this.fragment]:this.childNodes}get setOfNodes(){return new Set(this.childNodes)}removeFromParent(){this.childNodes.forEach((e=>e.parentNode.removeChild(e)))}expand(){this.binds.forEach((e=>{e instanceof x&&e.expand()}))}changeIndex(e,t){this.binds.forEach((n=>n.changeIndexes(e,t)))}static create(e,t){const{component:n,template:s}=e,i=document.importNode(s.content,!0),o=z.bind(s,i,n,t),r=Array.from(i.childNodes);return Object.assign(new P,{binds:o,childNodes:r,fragment:i})}}class x extends o{templateChildren=[];get template(){return this.node instanceof HTMLTemplateElement?this.node:utils.raise("not HTMLTemplateElement")}updateNode(){const{viewModel:e,viewModelProperty:t,indexes:n,filters:s}=this,o=i.applyForOutput(e[h](t,n),s);"loop"===this.nodeProperty?this.lastViewModelValue=(o??[]).slice():this.lastViewModelValue=o}removeFromParent(){const e=this.templateChildren.flatMap((e=>e.childNodes));if(e.length>0){const t=e[0].parentNode,n=t.cloneNode(!1);t.parentNode.replaceChild(n,t),e.forEach((e=>e.parentNode.removeChild(e))),n.parentNode.replaceChild(t,n)}}appendToParent(){const e=document.createDocumentFragment();this.templateChildren.forEach((t=>e.appendChild(...t.nodesForAppend))),this.template.after(e)}expand(){"loop"===this.nodeProperty?this.expandLoop():this.expandIf()}expandIf(){const{viewModel:e,viewModelProperty:t,indexes:n,filters:s}=this,o=this.lastViewModelValue,r=i.applyForOutput(e[h](t,n),s);o!==r&&(this.removeFromParent(),r?(this.templateChildren=[P.create(this,n)],this.appendToParent()):this.templateChildren=[])}expandLoop(){const{viewModel:e,viewModelProperty:t,indexes:n,filters:s}=this,o=this.lastViewModelValue??[],r=i.applyForOutput(e[h](t,n),s)??[],a=o.reduce(((e,t,n)=>(e.get(t)?.push(n)??e.set(t,[n]),e)),new Map),l=new Map,d=[],p=r.map(((e,t)=>{const s=a.get(e);if(void 0===s)return l.set(t,void 0),d.push(t),P.create(this,n.concat(t));{const e=s.shift();l.set(t,e);const i=this.templateChildren[e];t!==e&&i.changeIndex(n.length,t-e);const o=l.get(t-1);return(void 0===o||o>e)&&d.push(t),i}}));for(const e of a.values())for(const t of e)this.templateChildren[t].removeFromParent();d.forEach((e=>{const t=p[e];(p[e-1]?.lastNode??this.template).after(...t.nodesForAppend)})),p.forEach((e=>e.expand())),this.templateChildren=p}changeIndexes(e,t){this.indexes[e]=this.indexes[e]+t,this.templateChildren.forEach((n=>n.changeIndex(e,t)))}}class M{nodeProperty;viewModelProperty;filters}const b=e=>e.trim(),N=e=>e.length>0,E=(e,t)=>e.split(";").map(b).filter(N).map((e=>{let{nodeProperty:n,viewModelProperty:s,filters:o}=((e,t)=>{const[n,s]=["$"].concat(...e.split(":").map(b)).splice(-2),{viewModelProperty:o,filters:r}=(e=>{const[t,...n]=e.split("|").map(b);return{viewModelProperty:t,filters:n.map((e=>(e=>{const[t,...n]=e.split(",").map(b);return Object.assign(new i,{name:t,options:n})})(e)))}})(s);return{nodeProperty:n,viewModelProperty:o,filters:r}})(e);return s="@"===s?prop:s,n="$"===n?t:n,{nodeProperty:n,viewModelProperty:s,filters:o}})),S=class{static bindTextsByKey=new Map;static parse(e,t){const n=e+"\t"+t;let s=this.bindTextsByKey.get(n);return void 0===s&&(s=E(e,t).map((e=>Object.assign(new M,e))),this.bindTextsByKey.set(n,s)),s}},I=class{static getInfo(t,n){const s={type:null,nodePropertyElements:[],eventType:null};return t instanceof HTMLTemplateElement?(s.type=90,s):(s.nodePropertyElements=n.split("."),1===s.nodePropertyElements.length?s.nodePropertyElements[0].startsWith("on")?(s.type=91,s.eventType=s.nodePropertyElements[0].slice("on".length)):"radio"===s.nodePropertyElements[0]?s.type=20:"checkbox"===s.nodePropertyElements[1]?s.type=30:s.type=1:2===s.nodePropertyElements.length?"className"===s.nodePropertyElements[0]?s.type=10:s.type=2:3===s.nodePropertyElements.length?s.type=3:e.raise(`unknown property ${n}`),s)}};class V{node;property;updateFunc;constructor(e,t,n){this.node=e,this.property=t,this.updateFunc=n}}class L extends o{updateNode(){const{component:e,node:t,nodeProperty:n,viewModel:s,viewModelProperty:o,indexes:r,filters:a}=this,l=i.applyForOutput(s[h](o,r),a);this.lastViewModelValue!==l&&(e.updateSlot.addNodeUpdate(new V(t,n,(()=>{t[n]=l}))),this.lastViewModelValue=l)}updateViewModel(){const{node:e,nodeProperty:t,viewModel:n,viewModelProperty:s,indexes:o,filters:r}=this,a=i.applyForInput(e[t],r);n[u](s,o,a),this.lastViewModelValue=a}}class T extends o{get nodeProperty1(){return this.nodePropertyElements[0]}get nodeProperty2(){return this.nodePropertyElements[1]}updateNode(){const{component:e,node:t,nodeProperty:n,viewModel:s,viewModelProperty:o,indexes:r,filters:a}=this,{nodeProperty1:l,nodeProperty2:d}=this,p=i.applyForOutput(s[h](o,r),a);this.lastViewModelValue!==p&&(e.updateSlot.addNodeUpdate(new V(t,n,(()=>{t[l][d]=p}))),this.lastViewModelValue=p)}updateViewModel(){const{node:e,nodeProperty:t,viewModel:n,viewModelProperty:s,indexes:o,filters:r}=this,{nodeProperty1:a,nodeProperty2:l}=this,d=i.applyForInput(e[a][l],r);n[u](s,o,d),this.lastViewModelValue=d}}class O extends o{get nodeProperty1(){return this.nodePropertyElements[0]}get nodeProperty2(){return this.nodePropertyElements[1]}get nodeProperty3(){return this.nodePropertyElements[2]}updateNode(){const{component:e,node:t,nodeProperty:n,viewModel:s,viewModelProperty:o,indexes:r,filters:a}=this,{nodeProperty1:l,nodeProperty2:d,nodeProperty3:p}=this,c=i.applyForOutput(s[h](o,r),a);this.lastViewModelValue!==c&&(e.updateSlot.addNodeUpdate(new V(t,n,(()=>{t[l][d][p]=c}))),this.lastViewModelValue=c)}updateViewModel(){const{node:e,nodeProperty:t,viewModel:n,viewModelProperty:s,indexes:o,filters:r}=this,{nodeProperty1:a,nodeProperty2:l,nodeProperty3:d}=this,p=i.applyForInput(e[a][l][d],r);n[u](s,o,p),this.lastViewModelValue=p}}const B=e=>e instanceof HTMLElement?e:utils.raise("not HTMLElement");class C extends o{get className(){return this.nodePropertyElements[1]}updateNode(){const{component:e,node:t,nodeProperty:n,viewModel:s,viewModelProperty:o,indexes:r,filters:a,className:l}=this,d=B(t),p=i.applyForOutput(s[h](o,r),a);this.lastViewModelValue!==p&&(e.updateSlot.addNodeUpdate(new V(t,n,(()=>{p?d.classList.add(l):d.classList.remove(l)}))),this.lastViewModelValue=p)}updateViewModel(){const{node:e,nodeProperty:t,viewModel:n,viewModelProperty:s,indexes:o,filters:r,className:a}=this,l=B(e),d=i.applyForInput(l.classList.contains(a),r);n[u](s,o,d),this.lastViewModelValue=d}}const j=t=>t instanceof HTMLInputElement?t:e.raise();class k extends o{updateNode(){const{component:e,node:t,nodeProperty:n,viewModel:s,viewModelProperty:o,indexes:r,filters:a}=this,l=j(t),d=i.applyForOutput(s[h](o,r),a);this.lastViewModelValue!==d&&(e.updateSlot.addNodeUpdate(new V(t,n,(()=>{l.checked=d===l.value}))),this.lastViewModelValue=d)}updateViewModel(){const{node:e,nodeProperty:t,viewModel:n,viewModelProperty:s,indexes:o,filters:r}=this,a=j(e),l=i.applyForInput(a.value,r);a.checked&&(n[u](s,o,l),this.lastViewModelValue=l)}}const R=t=>t instanceof HTMLInputElement?t:e.raise();class F extends o{updateNode(){const{component:e,node:t,nodeProperty:n,viewModel:s,viewModelProperty:o,indexes:r,filters:a}=this,l=R(t),d=i.applyForOutput(s[h](o,r),a);this.lastViewModelValue!==d&&(e.updateSlot.addNodeUpdate(new V(t,n,(()=>{l.checked=d.find((e=>e===l.value))}))),this.lastViewModelValue=d)}updateViewModel(){const{node:e,nodeProperty:t,viewModel:n,viewModelProperty:s,indexes:o,filters:r}=bind,a=R(e),l=i.applyForInput(a.value,r),d=new Set(n[h](s,o));a.checked?d.add(l):d.delete(l);const p=Array.from(d);n[u](s,o,p),this.lastViewModelValue=p}}class A{target;thisArgument;argumentsList;constructor(e,t,n){this.target=e,this.thisArgument=t,this.argumentsList=n}}class H extends o{#o;get eventType(){return this.#o}set eventType(e){this.#o=e}addEventListener(){const{component:e,element:t,eventType:n,viewModel:s,viewModelProperty:i}=this;t.addEventListener(n,(t=>{const n=this.indexes,o=new A(s[m],s,[i,n,t]);e.updateSlot.addProcess(o)}))}}const $=new Map;$.set(1,((e,t)=>Object.assign(new L,e,t))),$.set(2,((e,t)=>Object.assign(new T,e,t))),$.set(3,((e,t)=>Object.assign(new O,e,t))),$.set(10,((e,t)=>Object.assign(new C,e,t))),$.set(20,((e,t)=>Object.assign(new k,e,t))),$.set(30,((e,t)=>Object.assign(new F,e,t))),$.set(90,((e,t)=>Object.assign(new x,e,t))),$.set(91,((e,t)=>Object.assign(new H,e,t)));class q{static create({component:e,node:t,nodeProperty:n,viewModel:s,viewModelProperty:i,filters:o,indexes:r}){const a={component:e,node:t,nodeProperty:n,viewModel:s,viewModelProperty:i,filters:o,indexes:r},l=I.getInfo(t,n);return $.get(l.type)(a,l)}}const K=class extends l{static bind(t,n,s){const i=n.viewModel,o=(t=>t instanceof HTMLTemplateElement?t:e.raise("not HTMLTemplateElement"))(t),r=o.dataset.bind,a=S.parse(r,"").map((e=>q.create(Object.assign(e,{node:t,component:n,viewModel:i,indexes:s.slice()}))));if(0===a.length)return[];const l=(e=>e instanceof x?e:void 0)(a[0]);if(l)return"if"!==l.nodeProperty&&"loop"!==l.nodeProperty&&e.raise(`unknown node property ${l.nodeProperty}`),l.expand(),l.updateNode(),[l];e.raise("not template bind")}},U="oninput",D=U.slice(2),G=class extends l{static bind(t,n,s){const i=n.viewModel,o=(t=>t instanceof HTMLElement?t:e.raise("not HTMLElement"))(t),r=o.dataset.bind,a=(e=>e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement||e instanceof HTMLOptionElement?"value":e instanceof HTMLInputElement?"radio"===e.type||"checkbox"===e.type?"checked":"value":"textContent")(o),l=S.parse(r,a).map((e=>{const o=q.create(Object.assign(e,{node:t,component:n,viewModel:i,indexes:s.slice()}));return o.updateNode(),o}));let d=!1,p=null;return l.forEach((e=>{d||=e.nodeProperty===U,p=e.nodeProperty===a?e:p;const t=(e=>e instanceof H?e:void 0)(e);t&&t.addEventListener()})),p&&!d&&o.addEventListener(D,(e=>{const t=new A(p.updateViewModel,p,[]);n.updateSlot.addProcess(t)})),l}},_=class extends l{static bind(t,n,s){const i=n.viewModel,o=(t=>t instanceof Comment?t:e.raise("not Comment"))(t),r=o.textContent.slice(2),a=document.createTextNode("");return o.parentNode.replaceChild(a,o),S.parse(r,"textContent").map((e=>{const t=q.create(Object.assign(e,{node:a,component:n,viewModel:i,indexes:s.slice()}));return t.updateNode(),t}))}},z=class{static bind(t,n,s,i=[]){return a.getTargetNodes(t,n).flatMap((t=>t instanceof HTMLTemplateElement?K.bind(t,s,i):t instanceof HTMLElement?G.bind(t,s,i):t instanceof Comment?_.bind(t,s,i):e.raise("unknown node type")))}},W=e=>e instanceof x?e:void 0;class J{template;rootElement;constructor(e,t){this.template=e,this.rootElement=t}render(e){const t=document.importNode(this.template.content,!0),n=new class{#r;#a=new Map;constructor(e){this.#r=e,this.buildMap()}buildMap(){const e=t=>{t.forEach((t=>{this.#a.get(t.viewModelPropertyKey)?.push(t)??this.#a.set(t.viewModelPropertyKey,[t]),(W(t)?.templateChildren??[]).forEach((t=>e(t.binds)))}))};this.#a.clear(),e(this.#r)}getTemplateBinds(e){const t=[],n=[{binds:this.#r,children:null,index:-1}];for(;n.length>0;){const s=n[n.length-1];if(s.index++,s.binds)if(s.index<s.binds.length){const i=W(s.binds[s.index]);i&&(e.has(i.viewModelPropertyKey)?t.push(i):i.templateChildren.length>0&&n.push({binds:null,children:i.templateChildren,index:-1}))}else n.pop();else if(s.index<s.children.length){const e=s.children[s.index];e.binds.length>0&&n.push({binds:e.binds,children:null,index:-1})}else n.pop()}return t}updateViewModel(e){const t=this.getTemplateBinds(e);t.length>0&&(t.forEach((e=>e.expand())),this.buildMap());const n=t=>{t.forEach((t=>{e.has(t.viewModelPropertyKey)&&t.updateNode(),W(t)?.templateChildren.forEach((e=>n(e.binds)))}))};n(this.#r)}}(z.bind(this.template,t,e));return this.rootElement.appendChild(t),n}}class Q{name;elements;loopLevel;parentName;lastElement;regexp;isPrimitive;privateName;isObject;isLoop;isNotPrimitive;constructor(e){this.name=e,this.elements=e.split("."),this.loopLevel=this.elements.reduce(((e,t)=>e+("*"===t?1:0)),0),this.parentName=this.elements.slice(0,-1).join("."),this.lastElement=this.elements.at(-1)??null,this.regexp=this.loopLevel>0?new RegExp("^"+e.replaceAll("*","(\\w+)").replaceAll(".","\\.")+"$"):null,this.isPrimitive=1===this.elements.length&&0===this.loopLevel,this.privateName=this.isPrimitive?"_"+e:null,this.isObject=this.elements.length>1&&0===this.loopLevel,this.isLoop=this.elements.length>1&&this.loopLevel>0,this.isNotPrimitive=!this.isPrimitive}primitiveGetter(e){return e[this.privateName]}primitiveSetter(e,t){return e[this.privateName]=t,!0}nonPrimitiveGetter(e){const{parentName:t,loopLevel:n,lastElement:s}=this,i="*"===s?e[p][n-1]:s;return e[t][i]}nonPrimitiveSetter(e,t){const{parentName:n,loopLevel:s,lastElement:i}=this,o="*"===i?e[p][s-1]:i;return e[n][o]=t,!0}createPropertyDescriptor(e){return{get:this.isPrimitive?()=>Reflect.apply(this.primitiveGetter,this,[e.viewModel]):()=>Reflect.apply(this.nonPrimitiveGetter,this,[e.viewModel]),set:this.isPrimitive?t=>Reflect.apply(this.primitiveSetter,this,[e.viewModel,t]):t=>Reflect.apply(this.nonPrimitiveSetter,this,[e.viewModel,t]),enumerable:!0,configurable:!0}}expand(e,t){if(this.loopLevel===t.length)return[t];if(this.loopLevel<t.length)return[t.slice(0,this.loopLevel)];{const n=(s,i,o)=>{const r=""!==s?s+".":s,a=this.elements[i],l=this.elements.length-1===i;return"*"===a?o.length<t.length?l?[t.slice(0,o.length+1)]:n(r+a,i+1,t.slice(0,o.length+1)):(e[h](s,o)??[]).map(((e,t)=>l?[o.concat(t)]:n(r+a,i+1,o.concat(t)))):l?[o]:n(r+a,i+1,o)};return n("",0,[])}}static#l=new Map;static create(e){let t=this.#l.get(e);return void 0===t&&(t=new Q(e),this.#l.set(e,t)),t}}const X=e=>"_"!==e[0],Y="$dependentProps",Z=class{static convert(t,n){let s=new Map;if(Y in n){const e=Object.getOwnPropertyDescriptor(n,Y);e.enumerable=!1,Object.defineProperty(n,Y,e),s=function(e){const t=new Map;return Object.entries(e).forEach((([e,n])=>{n.forEach((n=>{t.get(n)?.push(e)??t.set(n,[e])}))})),t}(e.value)}for(const[e,t]of Object.entries(Object.getOwnPropertyDescriptors(n)))X(e)||(t.enumerable=!1,Object.defineProperty(n,e,t));Object.keys(n).filter(X).map((e=>Q.create(e))).forEach((e=>{const s=n[e.name];delete n[e.name];const i=e.createPropertyDescriptor(t);if(Object.defineProperty(n,e.name,i),!(e.privateName in n)){const t={value:s,writable:!0,enumerable:!1,configurable:!0};Object.defineProperty(n,e.privateName,t)}}));for(const[t,s]of Object.entries(Object.getOwnPropertyDescriptors(Object.getPrototypeOf(n))))"constructor"!==t&&(e.isFunction(s.value)||(s.enumerable=!0,Object.defineProperty(n,t,s)));const i=Object.keys(n).map((e=>Q.create(e)));return i.forEach((e=>{if(e.isPrimitive)return;if("*"===e.lastElement)return;const t=s.get(e.parentName)?.concat(e.name)??[e.name];s.set(e.parentName,t)})),{viewModel:n,definedProperties:i,dependentMap:s}}};class ee{component;name;#n;get indexes(){return this.#n}set indexes(e){this.#n=e,this.#s=e.toString(),this.#d=this.name+"\t"+this.#s}#s;get indexesString(){return this.#s}#d;get key(){return this.#d}constructor(e,t,n){this.component=e,this.name=t,this.indexes=n}}const te=e=>e.key;class ne{#p;#c;#n;constructor(e,t,n){this.#p=e,this.#c=t,this.#n=n}get(e,t,n){return t===g||(t===v?e:Reflect.get(e,t,n))}set(e,t,n,s){return Reflect.set(e,t,n,s),"length"===t&&this.#p.updateSlot.addNotify(new ee(this.#p,this.#c.name,this.#n)),!0}}const se=new Set([...Array(8)].map(((e,t)=>"$"+(t+1)))),ie=(e,t,n,s)=>(s=s?.[g]?s[v]:s)instanceof Array?function(e,t,n,s){return new Proxy(e,new ne(t,n,s))}(s,e,t,n):s;class oe{cache=new class{#h=new Map;get(e,t){return this.#h.get(e)?.get(t.toString())}set(e,t,n){let s=this.#h.get(e);void 0===s&&(s=new Map,this.#h.set(e,s)),s.set(t.toString(),n)}has(e,t){return this.#h.get(e)?.has(t.toString())??!1}delete(e,t){const n=t.toString();let s=this.#h.get(e);s&&(s.delete(n),0===s.size&&this.#h.delete(e));const i=n+",",o=Array.from(this.#h.keys()),r=e=>o.filter((t=>!t.isPrimitive&&t.parentName===e.name)).flatMap((e=>[e].concat(r(e))));r(e).forEach((e=>{const t=this.#h.get(e);for(const e of t.keys())(""===n||e===n||e.startsWith(i))&&t.delete(e);0===t.size&&this.#h.delete(e)}))}clear(){this.#h.clear()}};propertyInfoAndIndexesByProp=new Map;stackIndexes=[];component;definedPropertyByProp=new Map;loopProperties=[];dependentMap;constructor(e,t,n){this.component=e,this.definedPropertyByProp=new Map(t.map((e=>[e.name,e]))),this.loopProperties=t.filter((e=>e.isLoop)),this.dependentMap=n}get lastIndexes(){return this.stackIndexes[this.stackIndexes.length-1]??[]}async[y](e,t){if("$oninit"in e)return await Reflect.apply(e.$oninit,t,[])}[f](e,t,n,s){if("$onwrite"in n){const{component:i}=this,o=new A(n.$onwrite,s,[e,t]);i.updateSlot.addProcess(o)}}#u(e,t,n){const{component:s,lastIndexes:i,cache:o}=this,r=i.slice(0,t.loopLevel),a=o.get(t,r);if(void 0!==a)return ie(s,t,r,a);const l=Reflect.get(e,t.name,n);return o.set(t,r,l),ie(s,t,r,l)}[h](e,t,n,s){let i;this.stackIndexes.push(t);try{i=s[e]}finally{this.stackIndexes.pop()}return i}#m(e,t,n,s){const{component:i,lastIndexes:o,cache:r}=this;n=n?.[g]?n[v]:n;const a=o.slice(0,t.loopLevel);if(Reflect.set(e,t.name,n,s),r.delete(t,a),r.set(t,a,n),i.updateSlot.addNotify(new ee(i,t.name,a)),this.dependentMap.has(t.name)){const e=t=>(this.dependentMap.get(t)??[]).flatMap((t=>[t].concat(e(t))));new Set(e(t.name)).forEach((e=>{const t=this.definedPropertyByProp.get(e);if(a.length<t.loopLevel)t.expand(s,a).forEach((e=>{r.delete(t,e),i.updateSlot.addNotify(new ee(i,t.name,e))}));else{const e=a.slice(0,t.loopLevel);r.delete(t,e),i.updateSlot.addNotify(new ee(i,t.name,e))}}))}return this[f](t.name,o,e,s),!0}[u](e,t,n,s,i){this.stackIndexes.push(t);try{i[e]=n}finally{this.stackIndexes.pop()}return!0}async[m](e,t,n,s,i){this.stackIndexes.push(t);try{await Reflect.apply(s[e],i,[n,...t])}finally{this.stackIndexes.pop()}}[w](e,t){this.cache.clear()}#y(e){let{loopProperty:t,indexes:n}=this.propertyInfoAndIndexesByProp.get(e)??{};if(void 0===t)for(const s of this.loopProperties){const i=s.regexp.exec(e);if(i){n=i.slice(1).map(Number),t=s,this.propertyInfoAndIndexesByProp.set(e,{loopProperty:t,indexes:n});break}}return{loopProperty:t,indexes:n}}get(e,t,n){const s=this.lastIndexes;if("symbol"==typeof t)switch(t){case h:return(t,s)=>Reflect.apply(this[h],this,[t,s,e,n]);case u:return(t,s,i)=>Reflect.apply(this[u],this,[t,s,i,e,n]);case p:return s;case m:return(t,s,i)=>Reflect.apply(this[m],this,[t,s,i,e,n]);case y:return()=>Reflect.apply(this[y],this,[e,n]);case f:return(t,s)=>Reflect.apply(this[f],this,[t,s,e,n]);case w:return()=>Reflect.apply(this[w],this,[e,n]);case c:return e}if(se.has(t))return s[Number(t.slice(1))-1];const i=this.definedPropertyByProp.get(t);if(i)return this.#u(e,i,n);if("_"!==t[0]){const{loopProperty:s,indexes:i}=this.#y(t);if(s&&i)return this[h](s.name,i,e,n)}return Reflect.get(e,t,n)}set(e,t,n,s){const i=this.definedPropertyByProp.get(t);if(i)return this.#m(e,i,n,s);if("_"!==t[0]){const{loopProperty:i,indexes:o}=this.#y(t);if(i&&o)return this[u](i.name,o,n,e,s),!0}return Reflect.set(e,t,n,s),!0}}class re{#f;#w;#g;#v;#P;#x;#M;constructor(e=null){this.#f=new class{queue=[];async exec(){for(;this.queue.length>0;){const e=this.queue.splice(0);for(const t of e)await Reflect.apply(t.target,t.thisArgument,t.argumentsList)}}get isEmpty(){return 0===this.queue.length}},this.#w=new class{queue=[];async exec(){for(;this.queue.length>0;){const e=this.queue.splice(0).reduce(((e,t)=>(e.get(t.component)?.push(t)??e.set(t.component,[t]),e)),new Map);for(const[t,n]of e.entries()){const e=new Set(n.map(te));t.notify(e)}}}get isEmpty(){return 0===this.queue.length}},this.#g=new class{queue=[];reorder(e){return e.sort(((e,t)=>t.node instanceof HTMLTemplateElement||e.node instanceof HTMLSelectElement&&"value"===e.property?1:-1)),e}async exec(){for(;this.queue.length>0;)this.reorder(this.queue.splice(0)).forEach((e=>Reflect.apply(e.updateFunc,e,[])))}get isEmpty(){return 0===this.queue.length}},this.#v=e,this.#P=new Promise(((e,t)=>{this.#x=e,this.#M=t}))}resolve(){this.#x&&this.#x(),this.#x=null}reject(){this.#M&&this.#M(),this.#M=null}async waiting(){return this.#P}async exec(){do{await this.#f.exec(),await this.#w.exec(),await this.#g.exec()}while(!this.#f.isEmpty||!this.#w.isEmpty||!this.#g.isEmpty)}addProcess(e){this.#f.queue.push(e),this.resolve()}addNotify(e){this.#w.queue.push(e),this.resolve()}addNodeUpdate(e){this.#g.queue.push(e),this.resolve()}callback(){this.#v&&this.#v()}static create(e){return new re(e)}}class ae{#x;#M;constructor(){this.main()}async#b(){return new Promise(((e,t)=>{this.#x=e,this.#M=t}))}stop(){this.#M()}wakeup(e){this.#x(e)}async main(){for(;;)try{const e=await this.#b();await e.waiting(),de.debug&&performance.mark("slot-exec:start");try{await e.exec(),de.debug&&(performance.mark("slot-exec:end"),performance.measure("slot-exec","slot-exec:start","slot-exec:end"),console.log(performance.getEntriesByType("measure")),performance.clearMeasures(),performance.clearMarks())}finally{e.callback()}}catch(e){if(void 0!==e&&(console.error(e),!confirm("致命的なエラーが発生しました。続行しますか？")))break}}}class le extends HTMLElement{viewModel;#N;#r;#E;#S;get updateSlot(){return void 0===this.#S&&(this.#S=re.create((()=>{this.#S=void 0})),this.#E.wakeup(this.#S)),this.#S}constructor(){super(),this.noShadowRoot||this.attachShadow({mode:"open"}),this.#I=new Promise(((e,t)=>{this.#V=e,this.#L=t})),this.#E=new ae}static get observedAttributes(){return[]}get noShadowRoot(){return this.hasAttribute("no-shadow-root")}get viewRootElement(){return this.shadowRoot??this}async build(){const t=le.componentDataByName.get(this.tagName);t||e.raise(`unknown tag name ${this.tagName}`),this.#N=new J(t.template,this.viewRootElement);const n=Reflect.construct(t.ViewModel,[]);this.viewModel=function(e,t){const{viewModel:n,definedProperties:s,dependentMap:i}=Z.convert(e,t);return new Proxy(n,new oe(e,s,i))}(this,n),await this.viewModel[y](),this.updateSlot.addProcess(new A((()=>{this.#r=this.#N.render(this)}),this,[]))}#I;#V;#L;get initialPromise(){return this.#I}#T;get parentComponent(){return void 0===this.#T&&(this.#T=(e=>{for(;;){if(null==(e=e.parentNode))return null;if(e instanceof le)return e;if(e instanceof ShadowRoot){if(e.host instanceof le)return e.host;e=e.host}}})(this)),this.#T}async connectedCallback(){try{this.parentComponent&&await this.parentComponent.initialPromise,await this.build()}finally{this.#V&&this.#V()}}disconnectedCallback(){}adoptedCallback(){}attributeChangedCallback(e,t,n){}notify(e){this.#r.updateViewModel(e)}static componentDataByName=new Map;static regist(e,n){const s=e.toUpperCase();this.componentDataByName.set(s,Object.assign(new t,n)),customElements.define(e,class extends le{})}}class de{static#O={prefix:void 0,debug:!1};static components(e){const t=this.prefix;return Object.entries(e).forEach((([e,n])=>{const s=t?t+"-"+e:e;le.regist(s,n)})),this}static filters(e){return Object.entries(e).forEach((([e,t])=>{const{input:n,output:s}=t;i.regist(e,s,n)})),this}static config({prefix:e,debug:t=!1}){return this.#O=Object.assign(this.#O,{prefix:e,debug:t}),this}static get debug(){return this.#O.debug}static get prefix(){return this.#O.prefix}}window[d]=de})();