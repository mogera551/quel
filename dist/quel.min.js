const e={debug:!1,useShadowRoot:!1,useKeyed:!0,useWebComponent:!0,useLocalTagName:!0,useLocalSelector:!0,useOverscrollBehavior:!0,useInvokerCommands:!1};function t(e){return new URL(e.url).search.slice(1)}async function n(e){return await fetch(e.url.replace(".js",".html")).then((e=>e.text()))}async function s(e){return await fetch(e.url.replace(".js",".css")).then((e=>e.text()))}class i{defaultNameType="lowerCamel";defaultPath="./";loadNames=[];prefixMap}class o{prefix;path;get matchPrefix(){return`${this.prefix}-`}constructor(e,t){this.prefix=e,this.path=t}isMatch(e){return e.startsWith(this.matchPrefix)}getNames(e){const{prefix:t,path:n}=this;if(e.startsWith(this.matchPrefix)){return{prefixName:t,subName:e.slice(this.matchPrefix.length),path:n}}}}const r=e=>"string"==typeof e?e.replaceAll(/[\._]/g,"-").replaceAll(/([A-Z])/g,((e,t,n)=>(n>0?"-":"")+t.toLowerCase())):e;function a(e){const t=r(e),n=t.replaceAll("-","_"),s=t.replaceAll("-","."),i=t.split("-").map(((e,t)=>(void 0!==e[0]&&(e=e[0].toUpperCase()+e.slice(1)),e))).join(""),o=i.length>0?i[0].toLowerCase()+i.slice(1):i;return{kebab:t,snake:n,upperCamel:i,lowerCamel:o,dotted:s}}const l=a("prefix-name"),d=a("sub-name");function u(e,t,n,s){const[i,o]=e.split("#");let r=i,u=o;const c=a(t),p=a(n);return r=r.replaceAll(`{${l.kebab}}`,c.kebab),r=r.replaceAll(`{${l.snake}}`,c.snake),r=r.replaceAll(`{${l.lowerCamel}}`,c.lowerCamel),r=r.replaceAll(`{${l.upperCamel}}`,c.upperCamel),r=r.replaceAll(`{${l.dotted}}`,c.dotted),r=r.replaceAll(`{${d.kebab}}`,p.kebab),r=r.replaceAll(`{${d.snake}}`,p.snake),r=r.replaceAll(`{${d.lowerCamel}}`,p.lowerCamel),r=r.replaceAll(`{${d.upperCamel}}`,p.upperCamel),r=r.replaceAll(`{${d.dotted}}`,p.dotted),i===r&&".js"!==r.slice(-3)&&(r=r+("/"!==e.slice(-1)?"/":"")+p[s]+".js"),u&&(u=u.replaceAll(`{${d.kebab}}`,p.kebab),u=u.replaceAll(`{${d.snake}}`,p.snake),u=u.replaceAll(`{${d.lowerCamel}}`,p.lowerCamel),u=u.replaceAll(`{${d.upperCamel}}`,p.upperCamel),u=u.replaceAll(`{${d.dotted}}`,p.dotted)),{filePath:r,exportName:u}}class c{static raise(e){throw new Error(e)}static toKebabCase=e=>"string"==typeof e?e.replaceAll(/_/g,"-").replaceAll(/([A-Z])/g,((e,t,n)=>(n>0?"-":"")+t.toLowerCase())):e;static createUUID(){return window?.crypto?.randomUUID?window.crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=((new Date).getTime()+16*Math.random())%16|0;return("x"==e?t:3&t|8).toString(16)}))}}class p{#e;#t;#n=new Map;#s;#i;constructor(e){this.#s=e,this.#i=window.location,this.#t=Object.assign(new i)}setConfig(e){this.#t=Object.assign(new i,e),"prefixMap"in e&&void 0!==e.prefixMap&&this.setPrefixMap(e.prefixMap)}getConfig(){return this.#t}setPrefixMap(e){this.#n=new Map(Object.entries(e).map((([e,t])=>[r(e),new o(e,t)])))}getPrefixMap(){return this.#n}configFile(e){return this.#e=e,this}config(e){return this.setConfig(e),this}prefixMap(e){return this.setPrefixMap(e),this}get registrar(){return this.#s}async loadConfig(e){const t=this.#i.pathname.split("/");t[t.length-1]=e;const n=this.#i.origin+t.join("/");try{const e=await fetch(n),t=await e.json();return Object.assign(new i,t)}catch(t){throw console.error(`config file load error (configFile:${e}, ${n})`,t),new Error("config file load error")}}async load(...e){if(void 0!==this.#e){const e=await this.loadConfig(this.#e);this.setConfig(e)}if(void 0===this.#n)throw new Error("prefixMap is not defined");if(void 0===this.#s)throw new Error("registrar is not defined");const t=Array.from(this.#n.values()),{defaultNameType:n,defaultPath:s}=this.#t;e=e.length>0?e:this.#t.loadNames;for(let i of e){let e;i=r(i);const o=t.find((e=>e.isMatch(i)));if(void 0!==o){const t=o.getNames(i)??c.raise(`names not found (loadName:${i})`);e=u(t.path,t.prefixName,t.subName,n)}if(void 0===e&&void 0!==s&&(e=u(s,"",i,n)),void 0===e)throw new Error(`unmatch prefix and no defaultPath (loadName:${i})`);const a=this.#i.pathname.split("/");a[a.length-1]=e.filePath;const l=this.#i.origin+a.join("/");let d,p;try{d=await import(l)}catch(e){throw console.error(`import error (loadName:${i}, ${l})`,e),new Error("import error")}if(void 0!==e.exportName){if(void 0!==d.default?e.exportName in d.default&&(p=d.default[e.exportName]):e.exportName in d&&(p=d[e.exportName]),void 0===p)throw new Error(`${e.exportName} not found in module (exportName:${e.exportName}, ${e.filePath})`)}else p=void 0!==d.default?d.default:Object.assign({},d);this.#s(i,p)}return this}static create(e){return new p(e)}}const h={objectClass:Object,prefix:"object",prefixShort:"o",prototypeFuncs:new Set(["hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]),staticFuncs:new Set(["create","defineProperties","defineProperty","entries","fromEntries","getOwnPropertyDescriptor","getOwnPropertyDescriptors","getOwnPropertyNames","getOwnPropertySymbols","getPrototypeOf","is","isExtensible","isFrozen","isSealed","keys","preventExtensions","values"])},m={objectClass:Array,prefix:"array",prefixShort:"a",prototypeFuncs:new Set(["at","concat","entries","flat","includes","indexOf","join","keys","lastIndexOf","slice","toLocaleString","toReversed","toSorted","toSpliced","values","with","toString"]),staticFuncs:new Set(["from","isArray","of"])},f={objectClass:Number,prefix:"number",prefixShort:"n",prototypeFuncs:new Set(["toExponential","toFixed","toLocaleString","toPrecision","toString","valueOf"]),staticFuncs:new Set(["isFinite","isInteger","isNaN","isSafeInteger","parseFloat","parseInt"])},g={objectClass:String,prefix:"string",prefixShort:"s",prototypeFuncs:new Set(["at","charAt","charCodeAt","codePointAt","concat","endsWith","includes","indexOf","lastIndexOf","localeCompare","match","normalize","padEnd","padStart","repeat","replace","replaceAll","search","slice","split","startsWith","substring","toLocaleLowerCase","toLocaleUpperCase","toLowerCase","toUpperCase","trim","trimEnd","trimStart","valueOf","toString"]),staticFuncs:new Set(["fromCharCode","fromCodePoint","raw"])},y={objectClass:Date,prefix:"date",prefixShort:"",prototypeFuncs:new Set(["getDate","getDay","getFullYear","getHours","getMilliseconds","getMinutes","getMonth","getSeconds","getTime","getTimezoneOffset","getUTCDate","getUTCDay","getUTCFullYear","getUTCHours","getUTCMilliseconds","getUTCMinutes","getUTCMonth","getUTCSeconds","toDateString","toISOString","toJSON","toLocaleDateString","toLocaleString","toLocaleTimeString","toTimeString","toUTCString","valueOf","toString"]),staticFuncs:new Set(["now","parse","UTC"])},b={objectClass:Set,prefix:"set",prefixShort:"",prototypeFuncs:new Set(["entries","forEach","has","keys","values"]),staticFuncs:new Set([])},x={objectClass:Map,prefix:"map",prefixShort:"",prototypeFuncs:new Set(["entries","forEach","get","has","keys","values"]),staticFuncs:new Set(["groupBy"])},v={objectClass:JSON,prefix:"json",prefixShort:"",prototypeFuncs:new Set([]),staticFuncs:new Set(["parse","stringify"])},C={objectClass:Math,prefix:"math",prefixShort:"",prototypeFuncs:new Set([]),staticFuncs:new Set(["abs","acos","acosh","asin","asinh","atan","atan2","atanh","cbrt","ceil","clz32","cos","cosh","exp","expm1","floor","fround","hypot","imul","log","log10","log1p","log2","max","min","pow","random","round","sign","sin","sinh","sqrt","tan","tanh","trunc"])},P={objectClass:RegExp,prefix:"regexp",prefixShort:"",prototypeFuncs:new Set(["exec","test","toString"]),staticFuncs:new Set([])};class w{static"truthy*"=e=>e=>!!e;static"falsey*"=e=>e=>!e;static"not*"=this["falsey*"];static eq=e=>t=>t==e[0];static ne=e=>t=>t!=e[0];static lt=e=>t=>Number(t)<Number(e[0]);static le=e=>t=>Number(t)<=Number(e[0]);static gt=e=>t=>Number(t)>Number(e[0]);static ge=e=>t=>Number(t)>=Number(e[0]);static oi=e=>t=>Number(e[0])<Number(t)&&Number(t)<Number(e[1]);static ci=e=>t=>Number(e[0])<=Number(t)&&Number(t)<=Number(e[1]);static embed=e=>t=>(e[0]??"").replaceAll("%s",t);static iftext=e=>t=>t?e[0]??null:e[1]??null;static"isnull*"=e=>e=>null==e;static offset=e=>t=>Number(t)+Number(e[0]);static unit=e=>t=>String(t)+String(e[0]);static inc=this.offset;static mul=e=>t=>Number(t)*Number(e[0]);static div=e=>t=>Number(t)/Number(e[0]);static mod=e=>t=>Number(t)%Number(e[0]);static prop=e=>t=>t[e[0]];static prefix=e=>t=>String(e[0])+String(t);static suffix=this.unit;static date=e=>t=>Date.prototype.toLocaleDateString.apply(t,["sv-SE",e[0]?e[0]:{}]);static"isnan*"=e=>e=>isNaN(e)}new Set([]);const S=new Set(["truthy*","falsey*","not*","eq","ne","lt","le","gt","ge","oi","ci","embed","iftext","isnull*","offset","unit","inc","mul","div","mod","prop","prefix","suffix","date","isnan*"]);function B(e,t){if(Reflect.has(e,"prototype")){const n=Reflect.get(e,"prototype");if(Reflect.has(n,t)){const e=Reflect.get(n,t);return t=>n=>e.apply(n,t)}}}function N(e,t){if(Reflect.has(e,t)){const n=Reflect.get(e,t);return e=>t=>n.apply(null,[t,...e])}}const I=[y,b,x,v,P,m,h,f,g,C],L=e=>t=>n=>null==n?n:e(t)(n),T=(e,t)=>t(e),q=e=>e=>e;class E{static create(e,t){const n=[];for(let s=0;s<e.length;s++){const i=e[s],o=t.getFilterFunc(i.name)(i.options);n.push(o)}return n}}class F{ambigousNames=new Set;funcByName=new Map;registerFilter(e,t){const n=e.endsWith("*"),s=n?e.slice(0,-1):e;this.funcByName.has(s)&&c.raise(`${this.constructor.name}: ${s} is already registered`);const i=n?t:L(t);this.funcByName.set(s,i)}getFilterFunc(e){return this.ambigousNames.has(e)&&c.raise(`${this.constructor.name}: ${e} is ambigous`),this.funcByName.get(e)??q}static applyFilter(e,t){return t.reduce(T,e)}}class $ extends F{constructor(){super(),this.ambigousNames=new Set($.#o),this.funcByName=new Map($.#r)}static#o=new Set;static#r=new Map;static{const e=new Set,t=new Map;for(const n of I){for(const s of n.prototypeFuncs){const i=s.endsWith("*"),o=i?s.slice(0,-1):s,r=B(n.objectClass,o);if(void 0!==r){const s=i?r:L(r);n.prefix&&t.set(`${n.prefix}.${o}`,s),n.prefixShort&&t.set(`${n.prefixShort}.${o}`,s),t.has(o)?e.add(o):t.set(o,s)}}for(const s of n.staticFuncs){const i=s.endsWith("*"),o=i?s.slice(0,-1):s,r=N(n.objectClass,o);if(void 0!==r){const s=i?r:L(r);n.prefix&&t.set(`${n.prefix}.${o}`,s),n.prefixShort&&t.set(`${n.prefixShort}.${o}`,s),t.has(o)?e.add(o):t.set(o,s)}}}for(const e of S){const n=e.endsWith("*"),s=n?e.slice(0,-1):e,i=Reflect.get(w,e);void 0===i&&c.raise(`${this.name}: ${e} is not found in defaultFilterGroup`);const o=n?i:L(i);t.set(s,o)}for(const n of e)t.delete(n);this.#o=e,this.#r=t}static registerFilter(e,t){const n=e.endsWith("*"),s=n?e.slice(0,-1):e;this.#r.has(s)&&c.raise(`${this.name}: ${s} is already registered`);const i=n?t:L(t);this.#r.set(s,i)}}class k{static date=e=>e=>""===e?null:new Date(new Date(e).setHours(0));static number=e=>e=>""===e?null:Number(e);static boolean=e=>e=>"false"!==e&&""!==e}class M extends F{constructor(){super(),this.ambigousNames=new Set(M.#o),this.funcByName=new Map(M.#r)}static#o=new Set;static#r=new Map;static{this.#r.set("date",k.date),this.#r.set("number",k.number),this.#r.set("boolean",k.boolean)}static registerFilter(e,t){this.#r.has(e)&&c.raise(`${this.name}: ${e} is already registered`),this.#r.set(e,t)}}class V{static preventDefault=e=>e=>(e.preventDefault(),e);static noStopPropagation=e=>e=>(Reflect.set(e,"noStopPropagation",!0),e);static pd=this.preventDefault;static nsp=this.noStopPropagation}class A extends F{constructor(){super(),this.ambigousNames=new Set(A.#o),this.funcByName=new Map(A.#r)}static#o=new Set;static#r=new Map;static{this.#r.set("preventDefault",V.preventDefault),this.#r.set("noStopPropagation",V.noStopPropagation),this.#r.set("pd",V.preventDefault),this.#r.set("nsp",V.noStopPropagation)}static registerFilter(e,t){this.#r.has(e)&&c.raise(`${this.name}: ${e} is already registered`),this.#r.set(e,t)}}const R="data-bind",U="data-uuid",O={};function j(e){const t=Array.from(e.childNodes);for(let e=0;e<t.length;e++){const n=t[e];n.nodeType===Node.TEXT_NODE&&(n.textContent?.match(/^\s*$/)&&n.parentNode?.removeChild(n))}}function H(e){return O[e]}function W(e,t,n){const s=document.createElement("template");return s.innerHTML=function(e,t,n){const s=[],i=e.replaceAll(/\{\{([^\}]+)\}\}/g,((e,t)=>{if((t=t.trim()).startsWith("loop:")||t.startsWith("if:"))return s.push(t),`<template data-bind="${t}">`;if(t.startsWith("else:")){const e=s[s.length-1];return void 0!==e&&e.startsWith("if:")||c.raise(`Template: endif: is not matched with if:, but {{ ${t} }} `),`</template><template data-bind="${e}|not">`}if(t.startsWith("end:"))return void 0===s.pop()&&c.raise(`Template: end: is not matched with loop: or if:, but {{ ${t} }} `),"</template>";if(t.startsWith("endif:")){const e=s.pop();return void 0!==e&&e.startsWith("if:")||c.raise(`Template: endif: is not matched with if:, but {{ ${e} }} `),"</template>"}if(t.startsWith("endloop:")){const e=s.pop();return void 0!==e&&e.startsWith("loop:")||c.raise(`Template: endloop: is not matched with loop:, but {{ ${e} }} `),"</template>"}return`\x3c!--@@:${t}--\x3e`}));s.length>0&&c.raise(`Template: loop: or if: is not matched with endloop: or endif:, but {{ ${s[s.length-1]} }} `);const o=document.createElement("template");o.innerHTML=i;const r=n.map((e=>c.toKebabCase(e))),a=e=>{for(const n of r){const s=Array.from(e.querySelectorAll(n));for(const e of s){const s=document.createElement(`${n}-${t}`);for(let t=0;t<e.attributes.length;t++){const n=e.attributes[t];s.setAttribute(n.name,n.value)}s.setAttribute("data-orig-tag-name",n),e.parentNode?.replaceChild(s,e)}const i=Array.from(e.querySelectorAll(`[is="${n}"]`));for(const e of i){const s=document.createElement(e.tagName,{is:`${n}-${t}`});for(let t=0;t<e.attributes.length;t++){const n=e.attributes[t];"is"!==n.name&&s.setAttribute(n.name,n.value)}s.setAttribute("data-orig-is",n),e.parentNode?.replaceChild(s,e)}}const n=Array.from(e.querySelectorAll("template"));for(const e of n)a(e.content)};r.length>0&&a(o.content);const l=e=>{let t;for(;t=e.querySelector("template");){const e=c.createUUID(),n=document.createComment(`@@|${e}`);if(t.parentNode?.replaceChild(n,t),t.constructor!==HTMLTemplateElement){const e=document.createElement("template");for(let n of Array.from(t.childNodes))e.content.appendChild(n);const n=t.getAttribute(R);n&&e.setAttribute(R,n),t=e}t.setAttribute(U,e),l(t.content),j(t.content),O[e]=t}};return l(o.content),o.innerHTML}(e,t,n),s.setAttribute(U,t),j(s.content),O[t]=s,s}const D=new Map;function _(e,t){const n=D.get(t);if(n)return n;const s=function(e){const t=new CSSStyleSheet;return t.replaceSync(e),t}(e);return D.set(t,s),s}class z{#a=c.createUUID();get uuid(){return this.#a}#l="";get html(){return this.#l}set html(e){this.#l=e,this.#d=void 0}#u;get css(){return this.#u}set css(e){this.#u=e,this.#c=void 0}#d;get template(){if(void 0===this.#d){const t=this.config.useLocalTagName??e.useLocalTagName?Object.keys(this.componentModules??{}):[];this.#d=W(this.html,this.uuid,t)}return this.#d}#c;get styleSheet(){return void 0===this.#c&&(this.#c=this.css?_(this.css,this.uuid):void 0),this.#c}State=class{};config={};moduleConfig={};options={};filters={};componentModules;get componentModulesForRegister(){if((this.config.useLocalTagName??e.useLocalTagName)&&void 0!==this.componentModules){const e={};for(const[t,n]of Object.entries(this.componentModules))e[`${c.toKebabCase(t)}-${this.uuid}`]=n;return e}return this.componentModules}}const K="state",Q=Symbol.for(`${K}.accessorProperties`),G=Symbol.for(`${K}.dependencies`),J=Symbol.for(`${K}.connectedEvent`),Y=Symbol.for(`${K}.disconnectedEvent`),Z=Symbol.for(`${K}.updatedEvent`),X=Symbol.for(`${K}.connectedCallback`),ee=Symbol.for(`${K}.disconnectedCallback`),te=Symbol.for(`${K}.updatedCallback`),ne=Symbol.for(`${K}.directlyCallApi`),se=Symbol.for(`${K}.notifyForDependentPropsApi`),ie=Symbol.for(`${K}.getDependentPropsApi`),oe=Symbol.for(`${K}.clearCacheApi`),re=Symbol.for(`${K}.getPropByInfo`),ae=Symbol.for(`${K}.setPropByInfo`),le=Symbol.for(`${K}.setWritable`),de=Symbol.for(`${K}.asyncSetWritable`),ue=Symbol.for(`${K}.getBaseState`),ce=new Set(["articles","aside","blockquote","body","div","footer","h1","h2","h3","h4","h5","h6","header","main","nav","p","section","span"]);const pe=new Map;function he(e,t){Array.from(e.cssRules).map((e=>{if("CSSImportRule"===e.constructor.name){const n=e;n.styleSheet?he(n.styleSheet,t):console.log(`import rule not found: ${n.href}`)}else t.insertRule(e.cssText,t.cssRules.length)}))}function me(e){const t=new CSSStyleSheet,n=Array.from(document.styleSheets).filter((t=>t.title===e));if(0!==n.length)return n.forEach((e=>he(e,t))),pe.set(e,t),t;console.log(`style sheet not found: ${e}`)}const fe=e=>pe.get(e)??me(e),ge=e=>void 0!==e;async function ye(e,t){if(void 0===t.loopContext)try{return await e.namedLoopIndexesStack.asyncSetNamedLoopIndexes({},(async()=>await Reflect.apply(t.target,t.thisArgument,t.argumentList)))}finally{}else try{return await e.loopContextStack.setLoopContext(e.namedLoopIndexesStack,t.loopContext,(async()=>await Reflect.apply(t.target,t.thisArgument,t.argumentList)))}finally{}}async function be(e,t){const n=[];for(let s=0;s<t.length;s++)n.push(ye(e,t[s]));return await Promise.all(n).then((()=>e.retrieveAllUpdatedStateProperties()))}function xe(e,t,n){const s=n.map((e=>({name:e.pattern,indexes:e.loopIndexes?.values})));e.addProcess((async()=>{await t[te](s)}),void 0,[],void 0)}async function ve(e,t){try{const n=e.retrieveAllUpdatedStateProperties(),s=t[de];return await s(e,(async()=>{try{const s=[];for(;;){const i=e.retrieveAllProcesses();if(0===i.length)break;const o=be(e,i).then((s=>{s.length>0&&(n.push(...s),xe(e,t,s))}));s.push(o)}return await Promise.all(s)}finally{}})).then((()=>n))}finally{}}const Ce=new Map;function Pe(e){let t;return Ce.get(e)??(t=function(e){const t=e.split("."),n=[],s=[];for(let e=0;e<t.length;e++){let i="";for(let n=0;n<=e;n++)i+=t[n]+(n<e?".":"");"*"===t[e]&&s.push(i),n.push(i)}return{patternElements:t,patternPaths:n,wildcardPaths:s}}(e),Ce.set(e,t),t)}class we{#p;#h;#m;#f;#g;get parentLoopIndexes(){return this.#p}get value(){return this.#h}get values(){return void 0===this.#m&&(void 0===this.parentLoopIndexes?this.#m=[this.#h]:this.#m=this.parentLoopIndexes.values.concat(this.#h)),this.#m}get index(){return void 0===this.#g&&(void 0===this.parentLoopIndexes?this.#g=0:this.#g=this.parentLoopIndexes.index+1),this.#g}get size(){return this.index+1}truncate(e){let t=this;for(;void 0!==t;){if(t.index<e)return t;t=t.parentLoopIndexes}}constructor(e,t){this.#p=e,this.#h=t}add(e){return new we(this,e)}*backward(){yield this.#h,void 0!==this.#p&&(yield*this.#p.backward())}*forward(){void 0!==this.#p&&(yield*this.#p.forward()),yield this.#h}toString(){return void 0===this.#f&&(void 0!==this.#p?this.#f=this.#p.toString()+","+this.#h:this.#f=this.#h?.toString()??""),this.#f}at(e){let t,n;for(e>=0?t=this.forward():(e=-e-1,t=this.backward());e>=0;)n=t.next(),e--;return n?.value}}function Se(e,t=e.length-1){const n=e[t];return new we(t>0?Se(e,t-1):void 0,n)}function Be(e,t){return void 0===e?Se([t]):e.add(t)}const Ne=new Map;function Ie(e){let t;return Ne.get(e)??(t=function(e){let t=!1;"@"===e[0]&&(e=e.slice(1),t=!0);const n=new Map,s=e.split("."),i=s.slice();let o;const r=[];let a=0,l=0,d="",u=0,c="none";for(let e=0;e<s.length;e++){const t=s[e];if("*"===t)o=Be(o,void 0),i[e]="*",a++,u++;else{const n=Number(t);Number.isNaN(n)||(o=Be(o,n),i[e]="*",l++,u++)}d+=t,r.push(d),d+=e<s.length-1?".":""}const p=i.join("."),h=Pe(p);let m=o;for(let e=h.wildcardPaths.length-1;e>=0;e--){if(void 0===m)throw new Error("_getPropInfo: tmpWildcardLoopIndexes is undefined.");n.set(h.wildcardPaths[e],m),m=m?.parentLoopIndexes}return(a>0||l>0)&&(c=a===u?"context":l===u?"all":"partial"),{name:e,expandable:t,pattern:p,elements:s,paths:r,wildcardCount:u,wildcardLoopIndexes:o,wildcardNamedLoopIndexes:n,patternElements:h.patternElements,patternPaths:h.patternPaths,wildcardPaths:h.wildcardPaths,wildcardType:c}}(e),Ne.set(e,t),t)}class Le{#y;#b;#x;#v;get pattern(){return this.#y}get patternInfo(){return void 0===this.#b&&(this.#b=Ie(this.#y)),this.#b}get loopIndexes(){return this.#x}get key(){return void 0===this.#v&&(this.#v=this.pattern+"\t"+(this.loopIndexes?.toString()??"")),this.#v}constructor(e,t=void 0){this.#y=e,this.#x=t}}function Te(e,t){return new Le(e,t)}const qe=[];function Ee(e=void 0){const t=qe.pop()??new Map;if(void 0===e)return t;const n=e.patternInfo.wildcardPaths;if(0===n.length||void 0===e.loopIndexes)return t;let s=e.loopIndexes;for(let e=0;e<n.length;e++){void 0===s&&c.raise("createNamedLoopIndexesFromAccessor: loopIndexes is undefined.");const i=n.at(-(e+1))??c.raise("createNamedLoopIndexesFromAccessor: wildcardPath is undefined.");t.set(i,s),s=s.parentLoopIndexes}return t}function Fe(e,t,n,s,i=new Set([])){const{pattern:o,loopIndexes:r}=n,a=o+"\t"+(r?.toString()??"");if(i.has(a))return[];i.add(a);const l=t[ie]().propsByRefProp[o];if(void 0===l)return[];const d=[],u=[],c=[];for(let e=0;e<(r?.size??0);e++)c.push(r?.at(e)),u.push(c.toString());for(const n of l){const o=Pe(n);if(!o.wildcardPaths.some(((e,t)=>{const n=Pe(e).patternPaths.at(-2)+"\t"+(u[t-1]??"");return s.has(n)}))){if((r?.size??0)<o.wildcardPaths.length){const s=$e(e,t,Te(n,r));d.push(...s.map((e=>Te(n,e))))}else{const e=r?.truncate(o.wildcardPaths.length);d.push(Te(n,e))}d.push(...Fe(e,t,Te(n,r),s,i))}}return d}function $e(e,t,n){const{pattern:s,loopIndexes:i}=n,o=void 0!==i,r=Ie(s);if(o&&r.wildcardCount===i.size)return[i];if(o&&r.wildcardCount<i.size)return[i.truncate(r.wildcardCount)];{const n=(n,s)=>{const i=Ee(Te(n,s)),o=Ie(n);return e.namedLoopIndexesStack?.setNamedLoopIndexes(i,(()=>t[re](o).length))},s=i?.size??0,o=(e,t,a)=>{const l=""!==e?e+".":e,d=r.elements[t];if(r.elements.length-1===t){if("*"===d){if(s>0&&s>(a?.size??0))return[i?.truncate((a?.size??0)+1)??Be(void 0,0)];{const t=[],s=n(e,a);for(let e=0;e<s;e++)t.push(Be(a,e));return t}}return void 0!==a?[a]:[]}{const r=l+d;if("*"===d){if(s>0&&s>(a?.size??0))return o(r,t+1,i?.truncate((a?.size??0)+1));{const s=[],i=n(e,a);for(let e=0;e<i;e++)s.push(...o(r,t+1,Be(a,e)));return s}}return o(r,t+1,a)}};return o("",0,void 0)}}function ke(e,t,n){const s=n.slice(0),i=new Set(n.map((e=>e.pattern+"\t"+(e.loopIndexes?.toString()??""))));for(let o=0;o<n.length;o++)s.push.apply(s,Fe(e,t,n[o],i));return s}const Me=(e,t)=>e.stateProperty.propInfo.wildcardCount-t.stateProperty.propInfo.wildcardCount;function Ve(e,t,n,s){for(let i=0;i<n.length;i++){const o=n[i],r=t.gatherBindings(o).toSorted(Me);for(let t=0;t<r.length;t++){const n=r[t];if(!n.expandable)continue;const i=n.stateProperty.name+".",a=s.some((e=>e.startsWith(i))),l=Ee(o);e.setFullRebuild(a,(()=>{e.namedLoopIndexesStack.setNamedLoopIndexes(l,(()=>{n.rebuild()}))}))}}}function Ae(e,t,n,s){t?.applyNodeUpdatesByBinding(e,(()=>{n.applyToChildNodes(s)}))}function Re(e,t,n){const s={},i={};for(const e of n){const t=e.patternInfo.patternElements;if("*"!==t[t.length-1])continue;const n=e.loopIndexes?.index;if(void 0===n)continue;const o=e.patternInfo.patternPaths,r=e.loopIndexes?.parentLoopIndexes,a=Te(o.at(-2)??"",r),l=a.key;i[l]?.add(n)??(i[l]=new Set([n])),s[l]=a}for(const[n,o]of Object.entries(i)){const i=s[n];t.gatherBindings(i).forEach((t=>{const n=Ee(i);e.namedLoopIndexesStack.setNamedLoopIndexes(n,(()=>{Ae(t,e,t.nodeProperty,o)}))}))}}function Ue(e,t,n){const s=[],i=(t,n)=>{const s=t.parentContentBindings.loopContext;if(void 0===s){const s=Ee(n);e.namedLoopIndexesStack.setNamedLoopIndexes(s,(()=>{t.updateNodeForNoRecursive()}))}else e.loopContextStack.setLoopContext(e.namedLoopIndexesStack,s,(async()=>{t.updateNodeForNoRecursive()}))};for(let e=0;e<n.length;e++){const o=n[e],r=Te(o.patternInfo.wildcardPaths.at(-1)??"",o.loopIndexes);for(const e of t.gatherBindings(o))e.expandable||(e.nodeProperty.isSelectValue?s.push({binding:e,propertyAccessor:o}):i(e,r))}for(let e=0;e<s.length;e++){const t=s[e],n=t.propertyAccessor,o=Te(n.patternInfo.wildcardPaths.at(-1)??"",n.loopIndexes);i(t.binding,o)}}class Oe{stack;async setLoopContext(e,t,n){e.stack.length>0&&c.raise("namedLoopIndexesStack is already set.");let s=t;const i={};for(;void 0!==s;){i[s.patternName]=s.serialLoopIndexes,s=s.parentLoopContext}this.stack=t;try{await e.asyncSetNamedLoopIndexes(i,(async()=>await n()))}finally{this.stack=void 0}}}class je{stack=[];get lastNamedLoopIndexes(){return this.stack[this.stack.length-1]}async asyncSetNamedLoopIndexes(e,t){const n=new Map(Object.entries(e));this.stack.push(n);try{return await t()}finally{this.stack.pop()}}setNamedLoopIndexes(e,t){this.stack.push(e);try{return t()}finally{this.stack.pop()}}setSubIndex(e,t,n,s){const i=this.lastNamedLoopIndexes;i?.set(t,i?.get(e??"")?.add(n)??Be(void 0,n));try{return s()}finally{i?.delete(t)}}getLoopIndexes(e){const t=this.lastNamedLoopIndexes;return t?.get(e)}}class He{#C;processQueue=[];updatedStateProperties=[];expandedStateProperties=[];updatedBindings=new Set;bindingsForUpdateNode=[];loopContextStack=function(){return new Oe}();namedLoopIndexesStack=function(){return new je}();executing=!1;get state(){return this.#C.quelState}get quelBindingSummary(){return this.#C.quelBindingSummary}get component(){return this.#C}constructor(e){this.#C=e}addProcess(e,t,n,s){this.processQueue.push({target:e,thisArgument:t,argumentList:n,loopContext:s}),this.executing||this.#P.resolve(void 0)}retrieveAllProcesses(){const e=this.processQueue;return this.processQueue=[],e}addUpdatedStateProperty(e){this.updatedStateProperties.push(e),this.executing||this.#P.resolve(void 0)}retrieveAllUpdatedStateProperties(){const e=this.updatedStateProperties;return this.updatedStateProperties=[],e}#w=[];get debugStacks(){return this.#w}async execCallbackWithPerformance(t){this.executing=!0;const n=this.#C.quelTemplate.dataset.uuid;e.debug&&performance.mark(`Updater#${n}.exec:start`);try{await t()}finally{e.debug&&(performance.mark(`Updater#${n}.exec:end`),performance.measure(`Updater#${n}.exec`,`Updater#${n}.exec:start`,`Updater#${n}.exec:end`),console.log(performance.getEntriesByType("measure")),performance.clearMeasures(`Updater#${n}.exec`),performance.clearMarks(`Updater#${n}.exec:start`),performance.clearMarks(`Updater#${n}.exec:end`)),this.executing=!1}}async start(e){return this.#S(e)}async terminate(){const e=Promise.withResolvers();return this.#P.resolve(e),e.promise}#P=Promise.withResolvers();async#S(e){for(;;)try{const[t]=await Promise.all([this.#P.promise,e.promise]);try{await this.exec()}finally{if(t){t.resolve();break}}}catch(e){console.error(e)}finally{this.#P=Promise.withResolvers(),this.#w.length>0&&(console.log(this.#w.join("\n")),this.#w=[])}}async exec(){try{await this.execCallbackWithPerformance((async()=>{for(;this.processQueue.length>0||this.updatedStateProperties.length>0;){this.updatedBindings.clear();const e=await ve(this,this.state),t=e.map((e=>e.pattern+"\t"+(e.loopIndexes?.toString()??""))),n=ke(this,this.state,e);Ve(this,this.quelBindingSummary,n,t),Re(this,this.quelBindingSummary,n),Ue(this,this.quelBindingSummary,n)}}))}finally{}}applyNodeUpdatesByBinding(e,t){if(!this.updatedBindings.has(e))try{t(this)}finally{this.updatedBindings.add(e)}}#B;get isFullRebuild(){return void 0===this.#B&&c.raise("fullRebuild is not set"),this.#B}setFullRebuild(e,t){this.#B=e;try{t()}finally{this.#B=void 0}}}class We{parentProp;thisProp;get key(){return`${this.parentProp}:${this.thisProp}`}constructor(e,t){this.parentProp=e,this.thisProp=t}}function De(e,t){return new We(e,t)}const _e="bindingProps",ze=Symbol.for(`${_e}.bindPropertySymbol`),Ke=Symbol.for(`${_e}.checkDuplicateSymbol`),Qe=Symbol.for(`${_e}.createBufferSymbol`),Ge=Symbol.for(`${_e}.getBufferSymbol`),Je=Symbol.for(`${_e}.flushBufferSymbol`),Ye=Symbol.for(`${_e}.setBufferSymbol`),Ze=Symbol.for(`${_e}.clearBufferSymbol`),Xe=RegExp(/^\$[0-9]+$/),et=(e,t,n,s)=>function(){const i=e(),o=i?.serialLoopIndexes;if(Xe.test(n.name)){const e=Number(n.name.slice(1));return o?.at(e)}const r=t.quelProps[Ge]();if(r)return r[s.name];const a=t.quelParentComponent??c.raise("quelParentComponent is undefined"),l=a.quelState,d=n.wildcardPaths.at(-1)??"",u=Ee(void 0!==d?Te(d,o):void 0);return a.quelUpdater.namedLoopIndexesStack.setNamedLoopIndexes(u,(()=>l[re](n)))},tt=RegExp(/^\$[0-9]+$/),nt=(e,t,n,s)=>function(i){tt.test(n.name)&&c.raise("Cannot set value to loop index");const o=t.quelProps[Ge]();if(o)return o[s.name]=i;const r=t.quelParentComponent??c.raise("quelParentComponent is undefined"),a=e();return r.quelUpdater?.addProcess(((e,t,n)=>e.quelState[ae](t,n)),void 0,[r,n,i],a),!0};class st{propsBindingInfos=[];propsBindingInfoKeys=new Set;parentProps=new Set;thisProps=new Set;loopContextByParentProp=new Map;#C;#N;get propBuffer(){return this.#N}constructor(e){this.#C=e}bindProperty(e,t,n){const s=this.#C,i=De(t,n);this.parentProps.has(t)&&c.raise(`Duplicate binding property: ${t}`),this.thisProps.has(n)&&c.raise(`Duplicate binding property: ${n}`);const o=Ie(n);"context"!==o.wildcardType&&"partial"!==o.wildcardType||c.raise(`Invalid prop name: ${n}`),this.propsBindingInfoKeys.has(i.key)&&c.raise(`Duplicate binding property: ${t}:${n}`);const r=Ie(t);this.propsBindingInfos.push(i),this.propsBindingInfoKeys.add(i.key),this.parentProps.add(t),this.thisProps.add(n),this.loopContextByParentProp.set(t,e);const a=s.quelState[ue](),l={enumerable:!0,configurable:!0,get:et(e,s,r,o),set:nt(e,s,r,o)};Object.defineProperty(a,n,l)}setBuffer(e){this.#N=e}getBuffer(){return this.#N}clearBuffer(){this.#N=void 0}createBuffer(){const e=this.#C;0===this.parentProps.size&&c.raise("No binding properties to buffer");const t={},n=e.quelParentComponent??c.raise("quelParentComponent is undefined"),s=n.quelState;for(const e of this.propsBindingInfos){const{parentProp:i,thisProp:o}=e,r=this.loopContextByParentProp.get(i),a=r?.(),l=a?.serialLoopIndexes,d=Ie(i),u=d.wildcardPaths.at(-1)??"",c=Ee(void 0!==u?Te(u,l):void 0),p=n.quelUpdater.namedLoopIndexesStack.setNamedLoopIndexes(c,(()=>s[re](d)));t[o]=p}return t}flushBuffer(){const e=this.#C;if(void 0===this.#N)return;const t=e.quelParentComponent??c.raise("quelParentComponent is undefined");for(const e of this.propsBindingInfos){const{parentProp:n,thisProp:s}=e,i=this.loopContextByParentProp.get(n),o=i?.(),r=Ie(n),a=this.#N[s],l=(e,t,n)=>e.quelState[ae](t,n);t.quelUpdater?.addProcess(l,void 0,[t,r,a],o)}}get(e,t,n){if(t===ze)return(e,t,n)=>this.bindProperty(n,e,t);if(t===Ye)return e=>this.setBuffer(e);if(t===Ge)return()=>this.getBuffer();if(t===Ze)return()=>this.clearBuffer();if(t===Qe)return()=>this.createBuffer();if(t===Je)return()=>this.flushBuffer();if(t===Ke)return(e,t)=>{const n=De(e,t);return this.propsBindingInfoKeys.has(n.key)};if("symbol"==typeof t||"number"==typeof t)return Reflect.get(e,t,n);const s=Ie(t);"context"!==s.wildcardType&&"partial"!==s.wildcardType||c.raise(`Invalid prop name: ${t}`);const i=this.#C,o=i.quelState;return i.quelUpdater.namedLoopIndexesStack.setNamedLoopIndexes(s.wildcardNamedLoopIndexes,(()=>o[re](s)))}set(e,t,n,s){if("symbol"==typeof t||"number"==typeof t)return Reflect.set(e,t,n,s);const i=Ie(t);"context"!==i.wildcardType&&"partial"!==i.wildcardType||c.raise(`Invalid prop name: ${t}`);const o=this.#C;return o.quelUpdater?.addProcess(((e,t,n)=>{const s=e.quelState;return e.quelUpdater.namedLoopIndexesStack.setNamedLoopIndexes(t.wildcardNamedLoopIndexes,(()=>s[ae](t,n)))}),void 0,[o,i,n],void 0),!0}ownKeys(e){return Array.from(this.thisProps)}getOwnPropertyDescriptor(e,t){return this.thisProps.has(t)?{enumerable:!0,configurable:!0}:{enumerable:!1,configurable:!0}}}const it=e=>e,ot={Text:e=>{const t=document.createTextNode("");return e.parentNode?.replaceChild(t,e),t},HTMLElement:it,SVGElement:it,Template:it};const rt=e=>{const t=e;return t.removeAttribute("data-bind"),t},at=e=>e,lt={HTMLElement:rt,SVGElement:rt,Text:at,Template:at};const dt=new Set(["button","image","hidden","reset","submit","unknown"]),ut=e=>!1,ct={HTMLElement:e=>e instanceof HTMLElement&&(e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement||e instanceof HTMLInputElement&&!dt.has(e.type)),SVGElement:ut,Text:ut,Template:ut};const pt=e=>e.trim(),ht=e=>e.length>0,mt=new RegExp(/^#(.*)#$/),ft=e=>{const t=mt.exec(e);return t?decodeURIComponent(t[1]):e},gt=e=>{const[t,...n]=e.split(",").map(pt);return{name:t,options:n.map(ft)}},yt=e=>{const[t,...n]=e.split("|").map(pt);return{property:t,filters:n.map(gt)}},bt=(e,t)=>e.split(";").map(pt).filter(ht).map((e=>{let{nodeProperty:n,stateProperty:s,inputFilters:i,outputFilters:o}=((e,t)=>{const[n,s]=[t].concat(...e.split(":").map(pt)).splice(-2),{property:i,filters:o}=yt(n),{property:r,filters:a}=yt(s);return{nodeProperty:i,stateProperty:r,inputFilters:o,outputFilters:a}})(e,"$");return s="@"===s?n:s,n="$"===n?t:n,{nodeProperty:n,stateProperty:s,inputFilters:i,outputFilters:o}})),xt={};const vt="textContent",Ct={radio:"checked",checkbox:"checked",button:"onclick"},Pt={},wt=e=>{},St={HTMLElement:e=>e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement||e instanceof HTMLOptionElement?"value":e instanceof HTMLButtonElement||e instanceof HTMLAnchorElement?"onclick":e instanceof HTMLFormElement?"onsubmit":e instanceof HTMLInputElement?Ct[e.type]??"value":vt,SVGElement:wt,Text:e=>vt,Template:wt};class Bt{#I;get node(){return this.#I}#L;get name(){return this.#L}#T;get nameElements(){return this.#T}getValue(){return this.node[this.name]}setValue(e){this.node[this.name]=e}#q;#E;get filters(){return void 0===this.#E&&(this.#E=E.create(this.#q,this.binding.inputFilterManager)),this.#E}getFilteredValue(){const e=this.getValue();return 0===this.filters.length?e:F.applyFilter(e,this.filters)}get applicable(){return!0}#F;get binding(){return this.#F}get expandable(){return!1}get isSelectValue(){return!1}get revisionForLoop(){return c.raise("not loopable")}get loopable(){return!1}constructor(e,t,n,s){t instanceof Node||c.raise("NodeProperty: not Node"),this.#F=e,this.#I=t,this.#L=n,this.#T=n.split("."),this.#q=s}initialize(){}postUpdate(e){}equals(e){return this.getValue()===e}applyToChildNodes(e){}dispose(){}revisionUpForLoop(){return 0}}class Nt extends Bt{#d;get template(){return void 0===this.#d&&(this.#d=H(this.uuid)??c.raise(`TemplateProperty: invalid uuid ${this.uuid}`)),this.#d}#a;get uuid(){var e;return void 0===this.#a&&(this.#a=(e=this.node,e.textContent?.slice(3)??c.raise("TemplateProperty: invalid node"))),this.#a}get expandable(){return!0}constructor(e,t,n,s){t instanceof Comment||c.raise("TemplateProperty: not Comment"),super(e,t,n,s)}}class It extends Nt{#$=0;get revisionForLoop(){return this.#$}get loopable(){return!0}dispose(){super.dispose(),this.#$++}revisionUpForLoop(){return++this.#$}}class Lt extends It{getValue(){return this.binding.childrenContentBindings}setValue(e){Array.isArray(e)||c.raise(`Repeat: ${this.binding.selectorName}.State['${this.binding.stateProperty.name}'] is not array`);const t=this.uuid,n=this.binding,s=this.getValue().length,i=this.binding.stateProperty.propInfo?.wildcardPaths,o=i?.[i.length-1],r=this.binding.statePropertyName+".*";if(this.revisionUpForLoop(),s<e.length){this.binding.childrenContentBindings.forEach(((e,t)=>{this.binding.updater?.namedLoopIndexesStack.setSubIndex(o,r,t,(()=>{e.rebuild()}))}));for(let i=s;i<e.length;i++){const e=Pn(t,n);this.binding.appendChildContentBindings(e),this.binding.updater?.namedLoopIndexesStack.setSubIndex(o,r,i,(()=>{e.rebuild()}))}}else if(s>e.length){const t=this.binding.childrenContentBindings.splice(e.length);this.binding.childrenContentBindings.forEach(((e,t)=>{this.binding.updater?.namedLoopIndexesStack.setSubIndex(o,r,t,(()=>{e.rebuild()}))})),t.forEach((e=>e.dispose()))}else this.binding.childrenContentBindings.forEach(((e,t)=>{this.binding.updater?.namedLoopIndexesStack.setSubIndex(o,r,t,(()=>{e.rebuild()}))}))}constructor(e,t,n,s){"loop"!==n&&c.raise(`Repeat: invalid property name '${n}'`),super(e,t,n,s)}equals(e){return!1}}class Tt extends Bt{get element(){return this.node}constructor(e,t,n,s){t instanceof Element||c.raise("ElementBase: not element"),super(e,t,n,s)}}class qt{value;enabled=!1;constructor(e,t){this.value=e,this.enabled=t}}class Et extends Tt{get inputElement(){return this.node}_value=new qt(void 0,!1);getValue(){return this._value.value=this.inputElement.value,this._value.enabled=this.inputElement.checked,this._value}setValue(e){Array.isArray(e)||c.raise(`Checkbox: ${this.binding.selectorName}.State['${this.binding.stateProperty.name}'] is not array`);const t=this.getFilteredValue();this.inputElement.checked=e.some((e=>e===t.value))}_filteredValue=new qt(void 0,!1);getFilteredValue(){const e=this.getValue();return this._filteredValue.value=this.filters.length>0?F.applyFilter(e.value,this.filters):e.value,this._filteredValue.enabled=e.enabled,this._filteredValue}constructor(e,t,n,s){t instanceof HTMLInputElement||c.raise("Checkbox: not htmlInputElement"),"checkbox"!==t.type&&c.raise("Checkbox: not checkbox"),super(e,t,n,s)}equals(e){return!1}}class Ft extends Tt{get inputElement(){return this.element}_value=new qt(void 0,!1);getValue(){return this._value.value=this.inputElement.value,this._value.enabled=this.inputElement.checked,this._value}setValue(e){const t=this.filteredValue;this.inputElement.checked=e===t.value}_filteredValue=new qt(void 0,!1);get filteredValue(){const e=this.getValue();return this._filteredValue.value=this.filters.length>0?F.applyFilter(e.value,this.filters):e.value,this._filteredValue.enabled=e.enabled,this._filteredValue}constructor(e,t,n,s){t instanceof HTMLInputElement||c.raise("Radio: not htmlInputElement");const i=t;"radio"!==i.type&&"checkbox"!==i.type&&c.raise("Radio: not radio or checkbox"),super(e,t,n,s)}equals(e){return!1}}class $t extends Tt{get eventType(){return this.name.slice(2)}get applicable(){return!1}#k;get handler(){return void 0===this.#k&&(this.#k=e=>this.eventHandler(e)),this.#k}#q;#M;get eventFilters(){return void 0===this.#M&&(this.#M=E.create(this.#q,this.binding.eventFilterManager)),this.#M}constructor(e,t,n,s){n.startsWith("on")||c.raise(`ElementEvent: invalid property name ${n}`),super(e,t,n,s),this.#q=s}initialize(){this.element.addEventListener(this.eventType,this.handler)}async directlyCall(e){if(this.binding.quelBindingSummary?.exists(this.binding))return this.binding.stateProperty.state[ne](this.binding.stateProperty.name,e,this.binding.parentContentBindings.currentLoopContext)}eventHandler(e){this.binding.quelBindingSummary?.exists(this.binding)&&(e=this.eventFilters.length>0?F.applyFilter(e,this.eventFilters):e,!1===(Reflect.get(e,"noStopPropagation")??!1)&&e.stopPropagation(),this.binding.updater?.addProcess(this.directlyCall,this,[e],this.binding.parentContentBindings?.currentLoopContext))}}class kt extends Tt{#V;get isSelectValue(){return void 0===this.#V&&(this.#V=this.node.constructor===HTMLSelectElement&&"value"===this.name),this.#V}}const Mt=new Set(["boolean","number","string"]);class Vt extends It{#A=new Map;#R=new Set;#U=new Set;#O=new Map;#j=[];getValue(){return this.#j}setValue(e){Array.isArray(e)||c.raise(`RepeatKeyed: ${this.binding.selectorName}.State['${this.binding.stateProperty.name}'] is not array`);const t=this.binding.stateProperty.propInfo?.wildcardPaths,n=t?.[t.length-1],s=this.binding.statePropertyName+".*";this.revisionUpForLoop(),this.#A.clear(),this.#R.clear(),this.#U.clear(),this.#O.clear();const i=this.binding.childrenContentBindings,o=e.length;let r=!0;for(let e=0;e<o;e++){const t=this.binding.stateProperty.getChildValue(e),n=this.#j.indexOf(t,this.#A.get(t)??0);-1===n?this.#U.add(e):(this.#A.set(t,n+1),this.#R.add(n),this.#O.set(e,i[n]),r=!1)}for(let e=0;e<i.length;e++)this.#R.has(e)||i[e].dispose();const a=this.uuid,l=this.binding;if(r){const e=this.node.nextSibling,t=this.node.parentNode??c.raise("parentNode is null");for(let r=0;r<o;r++){const o=Pn(a,l);i[r]=o,this.binding.updater?.namedLoopIndexesStack.setSubIndex(n,s,r,(()=>{o.rebuild()})),t.insertBefore(o.fragment,e)}}else{let e;const t=this.node.parentNode??c.raise("parentNode is null");for(let r=0;r<o;r++){const o=r;let d;const u=e?.lastChildNode??this.node;this.#U.has(o)?(d=Pn(a,l),i[o]=d,this.binding.updater?.namedLoopIndexesStack.setSubIndex(n,s,o,(()=>{d.rebuild()})),t.insertBefore(d.fragment,u.nextSibling)):(d=this.#O.get(o)??c.raise("contentBindings is undefined"),d.childNodes[0]?.previousSibling!==u?(d.removeChildNodes(),i[o]=d,this.binding.updater?.namedLoopIndexesStack.setSubIndex(n,s,o,(()=>{d.rebuild()})),t.insertBefore(d.fragment,u.nextSibling)):(i[o]=d,this.binding.updater?.isFullRebuild&&this.binding.updater?.namedLoopIndexesStack.setSubIndex(n,s,o,(()=>{d.rebuild()})))),e=d}}o<i.length&&(i.length=o),this.#j=e.slice()}applyToChildNodes(e){this.revisionUpForLoop();const t=this.uuid,n=this.binding,s=this.binding.stateProperty.propInfo?.wildcardPaths,i=s?.[s.length-1],o=this.binding.statePropertyName+".*",r=new Map;for(const t of e){const e=this.binding.childrenContentBindings[t];if(void 0===e)continue;const n=this.#j[t],s=typeof n;"undefined"!==s&&(Mt.has(s)||(e.removeChildNodes(),r.set(n,e)))}const a=[];for(const s of Array.from(e).sort()){const e=this.binding.stateProperty.getChildValue(s),l=typeof e;if("undefined"===l)continue;if(Mt.has(l))continue;let d=r.get(e);void 0===d?(d=Pn(t,n),this.binding.replaceChildContentBindings(d,s),this.binding.updater?.namedLoopIndexesStack.setSubIndex(i,o,s,(()=>{d?.rebuild()})),a.push(...d.allChildBindings)):(this.binding.replaceChildContentBindings(d,s),this.binding.updater?.namedLoopIndexesStack.setSubIndex(i,o,s,(()=>{d?.rebuild()})),a.push(...d.allChildBindings))}this.#j=this.binding.stateProperty.getValue().slice()}initialize(){super.initialize(),this.#j=[]}dispose(){super.dispose(),this.#j=[]}}function At(e,t){if(null==t)return null;if(":host"===t)return Wn(e);const n=Wn(e);if(null!=n){const e=n.quelQueryRoot.querySelector("#"+t);if(null!=e)return e}const s=document.getElementById(t);return null==s?null:s}class Rt extends Tt{#H="";get propertyName(){return this.nameElements[1]}get targetId(){return this.#H}get target(){const e=At(this.node,this.#H);return null!=e&&!0!==e?.quelIsQuelComponent&&c.raise("PopoverTarget: not Quel Component"),e}get button(){if(this.node instanceof HTMLButtonElement)return this.node;c.raise("PopoverTarget: not button element")}constructor(e,t,n,s){t instanceof HTMLButtonElement||c.raise("PopoverTarget: not button element"),t.hasAttribute("popovertarget")||c.raise("PopoverTarget: missing popovertarget attribute"),super(e,t,n,s),this.#H=t.getAttribute("popovertarget")}initialize(){var e;super.initialize(),this.binding.defaultEventHandler=(e=this,t=>e.registerCurrentButton())}get applicable(){const e=this.target?.matches(":popover-open")??!1;return!(this.binding.component?.quelPopoverInfo.currentButton!==this.button||!e)}registerCurrentButton(){this.binding.component?.quelPopoverInfo.addBinding(this.button,this.binding);(this.binding.component?.quelPopoverInfo??c.raise("PopoverTarget: no popoverInfo")).currentButton=this.button;const e=Array.from(this.binding.component?.quelBindingSummary?.allBindings??[]).filter((e=>e.nodeProperty instanceof Rt&&e.nodeProperty.node===this.node)),t=this.target?.quelProps??c.raise("PopoverTarget: no target or no target props");for(const n of e){const e=n.nodeProperty,s=e.binding,i=e.binding.statePropertyName,o=e.propertyName;if(!t[Ke](i,o)){const e=e=>()=>{const t=e.component??c.raise("PopoverTarget: no component"),n=t.quelPopoverInfo?.currentButton??c.raise("PopoverTarget: no currentButton"),s=t.quelPopoverInfo?.get(n);return s?.loopContext};t[ze](i,o,e(s))}}}}function Ut(e,t){if(null==t)return null;if(":host"===t)return Wn(e);const n=Wn(e);if(null!=n){const e=n.quelQueryRoot.querySelector("#"+t);if(null!=e)return e}const s=document.getElementById(t);return null==s?null:s}class Ot extends Tt{#W="";get propertyName(){return this.nameElements[1]}get commandFor(){return this.#W}get commandForElement(){const e=Ut(this.node,this.#W);return null!=e&&!0!==e?.quelIsQuelComponent&&c.raise("CommandForTarget: not Quel Component"),e}#D;get command(){return this.#D}get button(){if(this.node instanceof HTMLButtonElement)return this.node;c.raise("CommandForTarget: not button element")}constructor(e,t,n,s){t instanceof HTMLButtonElement||c.raise("CommandForTarget: not button element"),t.hasAttribute("commandfor")||c.raise("CommandForTarget: missing commandfor attribute"),t.hasAttribute("command")||c.raise("CommandForTarget: missing command attribute"),super(e,t,n,s),this.#W=t.getAttribute("commandfor"),this.#D=t.getAttribute("command")}initialize(){var e;super.initialize(),this.binding.defaultEventHandler=(e=this,t=>e.registerCurrentButton())}get applicable(){const e=this.commandForElement?.hasAttribute("open")??!1;return!(this.binding.component?.quelInvokerCommandsInfo.currentButton!==this.button||!e)}registerCurrentButton(){this.binding.component?.quelInvokerCommandsInfo.addBinding(this.button,this.binding);(this.binding.component?.quelInvokerCommandsInfo??c.raise("CommandForTarget: no invokerCommandsInfo")).currentButton=this.button;const e=Array.from(this.binding.component?.quelBindingSummary?.allBindings??[]).filter((e=>e.nodeProperty instanceof Ot&&e.nodeProperty.node===this.node)),t=this.commandForElement?.quelProps??c.raise("CommandForTarget: no target or no target props");for(const n of e){const e=n.nodeProperty,s=e.binding,i=e.binding.statePropertyName,o=e.propertyName;if(!t[Ke](i,o)){const e=e=>()=>{const t=e.component??c.raise("CommandForTarget: no component"),n=t.quelInvokerCommandsInfo?.currentButton??c.raise("CommandForTarget: no currentButton"),s=t.quelInvokerCommandsInfo?.get(n);return s?.loopContext};t[ze](i,o,e(s))}}}}const jt={0:{class:class extends Tt{getValue(){return this.element.className.length>0?this.element.className.split(" "):[]}setValue(e){Array.isArray(e)||c.raise(`ElementClassName: ${this.binding.selectorName}.State['${this.binding.stateProperty.name}'] is not array`),this.element.className=e.join(" ")}constructor(e,t,n,s){"class"!==n&&c.raise(`ElementClassName: invalid property name ${n}`),super(e,t,n,s)}},checkbox:Et,radio:Ft},1:{if:class extends Nt{getValue(){return this.binding.childrenContentBindings.length>0}setValue(e){"boolean"!=typeof e&&c.raise(`Branch: ${this.binding.selectorName}.State['${this.binding.stateProperty.name}'] is not boolean`);const t=this.getValue(),n=this.uuid,s=this.binding;if(t!==e)if(e){const e=Pn(n,s);this.binding.appendChildContentBindings(e),e.rebuild()}else this.binding.removeAllChildrenContentBindings();else this.binding.childrenContentBindings.forEach((e=>e.rebuild()))}constructor(e,t,n,s){"if"!==n&&c.raise(`Branch: invalid property name ${n}`),super(e,t,n,s)}equals(e){return!1}}}},Ht={class:class extends Tt{get className(){return this.nameElements[1]}getValue(){return this.element.classList.contains(this.className)}setValue(e){"boolean"!=typeof e&&c.raise(`ElementClass: ${this.binding.selectorName}.State['${this.binding.stateProperty.name}'] is not boolean`),e?this.element.classList.add(this.className):this.element.classList.remove(this.className)}constructor(e,t,n,s){n.startsWith("class.")||c.raise(`ElementClass: invalid property name ${n}`),super(e,t,n,s)}},attr:class extends Tt{get attributeName(){return this.nameElements[1]}getValue(){return this.element.getAttribute(this.attributeName)}setValue(e){this.element.setAttribute(this.attributeName,e)}},style:class extends Tt{get htmlElement(){return this.node}get styleName(){return this.nameElements[1]}getValue(){return this.htmlElement.style.getPropertyValue(this.styleName)}setValue(e){this.htmlElement.style.setProperty(this.styleName,e)}constructor(e,t,n,s){t instanceof HTMLElement||c.raise("ElementStyle: not htmlElement"),super(e,t,n,s)}},props:class extends Tt{get propertyName(){return this.nameElements[1]}get applicable(){return!0}get thisComponent(){return this.node}constructor(e,t,n,s){!0!==Reflect.get(t,"quelIsQuelComponent")&&c.raise("ComponentProperty: not Quel Component"),super(e,t,n,s)}getValue(){return super.getValue()}setValue(e){try{this.thisComponent.quelState[se](this.propertyName,void 0)}catch(e){console.log(e)}}initialize(){this.thisComponent.quelProps[ze](this.binding.stateProperty.name,this.propertyName,(()=>this.binding.parentContentBindings.currentLoopContext))}postUpdate(e){const t=this.binding.stateProperty.name;for(const[n,s]of e.entries()){const e=Pe(s.pattern);if(s.pattern===t||e.patternPaths.includes(t)){const e=s.pattern.slice(t.length);this.thisComponent.quelState[te]([{name:`${this.propertyName}${e}`,indexes:s.loopIndexes?.values}]),this.thisComponent.quelState[se](`${this.propertyName}${e}`,s.loopIndexes)}}}equals(e){return!1}},popover:Rt,commandfor:Ot};function Wt(e,t,n,s){let i;do{if(i=jt[e?1:0][n],void 0!==i)break;if(e&&"loop"===n){i=s?Vt:Lt;break}e&&c.raise(`NodePropertyCreateor: unknown node property ${n}`);const o=n.split(".");if(i=Ht[o[0]],void 0!==i)break;i=t?n.startsWith("on")?$t:kt:Bt}while(0);return o=i,(e,t,n,s)=>Reflect.construct(o,[e,t,n,s]);var o}const Dt={};function _t(e,t,n){const s=e instanceof Comment,i=e instanceof Element,o=s+"\t"+i+"\t"+t+"\t"+n;return Dt[o]??(Dt[o]=Wt(s,i,t,n))}class zt{get state(){return this.#F.state??c.raise("StateProperty: state is undefined")}#L;get name(){return this.#L}#_;get childName(){return this.#_}#z;get propInfo(){return this.#z}#K;get lastWildCard(){return this.#K}#Q;get level(){return this.#Q}get loopIndexes(){return this.binding.updater?.namedLoopIndexesStack?.getLoopIndexes(this.lastWildCard)}getValue(){return this.state[re](this.propInfo)}setValue(e){const t=e=>{this.state[ae](this.propInfo,e)};if(e instanceof qt){const n=this.getValue();if(Array.isArray(n)){const s=new Set(n);e.enabled?s.add(e.value):s.delete(e.value),t(Array.from(s))}else t(e.enabled?e.value:void 0)}else t(e)}#G;#E;get filters(){return void 0===this.#E&&(this.#E=E.create(this.#G,this.binding.outputFilterManager)),this.#E}getFilteredValue(){const e=this.getValue();return 0===this.filters.length?e:F.applyFilter(e,this.filters)}get applicable(){return!0}#F;get binding(){return this.#F}constructor(e,t,n){this.#F=e,this.#L=t,this.#_=t+".*",this.#z=Ie(t),this.#Q=this.#z.wildcardCount,this.#G=n,this.#K=this.#z.wildcardPaths[this.#z.wildcardPaths.length-1]}initialize(){}getChildValue(e){return this.binding.updater?.namedLoopIndexesStack?.setSubIndex(this.#L,this.#_,e,(()=>{const e=Ie(this.#_);return this.state[re](e)}))}setChildValue(e,t){return this.binding.updater?.namedLoopIndexesStack?.setSubIndex(this.#L,this.#_,e,(()=>{const e=Ie(this.#_);return this.state[ae](e,t)}))}dispose(){}}const Kt=RegExp(/^\$[0-9]+$/);class Qt extends zt{#g;get index(){return this.#g}getValue(){return this.binding.parentContentBindings?.currentLoopContext?.loopIndexes.at(this.index)??c.raise(`ContextIndex: invalid index ${this.name}`)}get loopIndexes(){}get indexes(){return[]}constructor(e,t,n){Kt.test(t)||c.raise(`ContextIndex: invalid name ${t}`),super(e,t,n),this.#g=Number(t.slice(1))-1}}const Gt=RegExp(/^\$[0-9]+$/);function Jt(e){const t=Gt.test(e)?Qt:zt;return n=t,(e,t,s)=>Reflect.construct(n,[e,t,s]);var n}function Yt(e,t,n,s){return{nodePropertyConstructor:_t(e,t,s),statePropertyConstructor:Jt(n)}}function Zt(e,t){t.applicable&&t.setValue(e.getFilteredValue())}function Xt(e,t,n,s){n.applicable&&t?.applyNodeUpdatesByBinding(e,(()=>{n.setValue(s.getFilteredValue()??"")}))}let en=1;class tn{#J;#Y;#Z;childrenContentBindings=[];#X;get id(){return this.#J.toString()}get nodeProperty(){return this.#Y}get stateProperty(){return this.#Z}get statePropertyName(){return this.#Z.name}get parentContentBindings(){return this.#X}get loopable(){return this.#Y.loopable}get expandable(){return this.#Y.expandable}get component(){return this.#X.component}get updater(){return this.component?.quelUpdater}get quelBindingSummary(){return this.component?.quelBindingSummary}get state(){return this.component?.quelState}get selectorName(){return this.component?.quelSelectorName}get eventFilterManager(){return this.component?.quelEventFilterManager??c.raise("Binding.eventFilterManager: undefined")}get inputFilterManager(){return this.component?.quelInputFilterManager??c.raise("Binding.inputFilterManager: undefined")}get outputFilterManager(){return this.component?.quelOutputFilterManager??c.raise("Binding.outputFilterManager: undefined")}constructor(e,t,n,s,i,o,r,a){this.#J=++en,this.#X=e,this.#Y=s(this,t,n,i),this.#Z=r(this,o,a)}execDefaultEventHandler(e){if(!this.quelBindingSummary?.exists(this))return;e.stopPropagation();const{nodeProperty:t,stateProperty:n}=this;this.updater?.addProcess(Zt,void 0,[t,n],this.parentContentBindings?.currentLoopContext)}#ee=void 0;get defaultEventHandler(){var e;return void 0===this.#ee&&(this.#ee=(e=this,t=>e.execDefaultEventHandler(t))),this.#ee}set defaultEventHandler(e){this.#ee=e}initialize(){this.nodeProperty.initialize(),this.stateProperty.initialize()}appendChildContentBindings(e){this.expandable||c.raise("Binding.appendChild: not expandable"),this.childrenContentBindings.push(e);const t=this.childrenContentBindings[this.childrenContentBindings.length-1],n=this.nodeProperty.node.parentNode,s=t?.lastChildNode??this.nodeProperty.node;n?.insertBefore(e.fragment,s.nextSibling??null)}replaceChildContentBindings(e,t){this.expandable||c.raise("Binding.replaceChild: not expandable"),this.childrenContentBindings[t]=e;const n=this.childrenContentBindings[t-1],s=this.nodeProperty.node.parentNode,i=n?.lastChildNode??this.nodeProperty.node;s?.insertBefore(e.fragment,i.nextSibling??null)}removeAllChildrenContentBindings(){const e=this.childrenContentBindings;this.childrenContentBindings=[];for(let t=0;t<e.length;t++)e[t].dispose();return e}dispose(){this.quelBindingSummary?.delete(this),this.nodeProperty.dispose(),this.stateProperty.dispose(),this.childrenContentBindings.forEach((e=>e.dispose())),this.childrenContentBindings=[]}rebuild(){const{updater:e,nodeProperty:t,stateProperty:n}=this;Xt(this,e,t,n)}updateNodeForNoRecursive(){if(!this.expandable){const{updater:e,nodeProperty:t,stateProperty:n}=this;Xt(this,e,t,n)}}}const nn=(e,t)=>(n,s)=>function(e,t,n,s,i,o,r,a){const l=new tn(e,t,n,s,i,o,r,a);return l.initialize(),l}(n,s,e.nodeProperty,t.nodePropertyConstructor,e.inputFilters,e.stateProperty,t.statePropertyConstructor,e.outputFilters);const sn=()=>{},on={HTMLElement:function(e,t,n,s){const i=e;let o=!1,r=null,a=null,l=null,d=null,u=null;for(let e=0;e<n.length;e++){const t=n[e];o||="oninput"===t.nodeProperty.name,a=t.nodeProperty.constructor===Ft?t:a,l=t.nodeProperty.constructor===Et?t:l,d=t.nodeProperty.constructor===Rt?t:d,u=t.nodeProperty.constructor===Ot?t:u,r=t.nodeProperty.name===s?t:r}if(!o){const e=(e=>(t,n="input")=>e.addEventListener(n,(e=>t.defaultEventHandler(e))))(i);a?e(a):l?e(l):d?e(d,"click"):u?e(u,"click"):r&&t&&e(r)}},SVGElement:sn,Text:sn,Template:sn};class rn{nodeType;nodeRoute;nodeRouteKey;bindTexts;acceptInput;defaultProperty;initializeForNode;constructor(e,t,n,s,i,o){var r;this.nodeType=e,this.nodeRoute=t,this.nodeRouteKey=n,this.bindTexts=s,this.acceptInput=i,this.defaultProperty=o,this.initializeForNode=(r=this,(e,t)=>on[r.nodeType](e,r.acceptInput,t,r.defaultProperty))}}function an(e,t,n,s){e=function(e,t){return ot[t](e)}(e,t),function(e,t){lt[t](e)}(e,t);const i=function(e,t){return ct[t](e)}(e,t),o=function(e,t){const n=e.constructor.name+"\t"+(e.type??"");return Pt[n]??(Pt[n]=St[t](e))}(e,t)??"",r=function(e,t){if(""===e.trim())return[];const n=e+"\t"+t;return xt[n]??(xt[n]=bt(e,t))}(n,o),a=[];for(let t=0;t<r.length;t++){const n=r[t],{nodeProperty:i,stateProperty:o}=n,l=Yt(e,i,o,s);a.push({...n,...l,createBinding:nn(n,l)})}const l=function(e){let t=[];for(;null!==e.parentNode;)t=[Array.from(e.parentNode.childNodes).indexOf(e),...t],e=e.parentNode;return t}(e),d=l.join(",");return new rn(t,l,d,a,i,o)}const ln="bind",dn={HTMLElement:e=>e.dataset[ln]??"",SVGElement:e=>e.dataset[ln]??"",Text:e=>e.textContent?.slice(3)??"",Template:e=>H(e.textContent?.slice(3)??"")?.dataset[ln]??""};function un(e,t){return dn[t](e)}function cn(e){return Array.from(e.childNodes).flatMap((e=>cn(e).concat((e=>e instanceof Comment&&((e.textContent?.startsWith("@@:")??!1)||(e.textContent?.startsWith("@@|")??!1)))(e)?e:[])))}const pn={};function hn(e,t=(e=>e.constructor.name+"\t"+(e instanceof Comment?e.textContent?.[2]??"":""))(e)){return pn[t]??(pn[t]=(e=>e instanceof Comment&&":"===e.textContent?.[2]?"Text":e instanceof HTMLElement?"HTMLElement":e instanceof Comment&&"|"===e.textContent?.[2]?"Template":e instanceof SVGElement?"SVGElement":c.raise(`Unknown NodeType: ${e.nodeType}`))(e))}function mn(e,t){for(let n=0;void 0!==e&&n<t.length;e=e.childNodes[t[n++]]);return e}const fn={};class gn{#d;#te;constructor(e,t){this.#d=e,this.#te=function(e,t){const n=[],s=e.content,i=Array.from(s.querySelectorAll("[data-bind]")).concat(cn(s));for(let e=0;e<i.length;e++){const s=i[e],o=hn(s),r=un(s,o);""!==r.trim()&&(n[n.length]=an(i[e],o,r,t))}return n}(this.#d,t)}createBindings(e,t){return function(e,t,n){const s=[];for(let i=0;i<n.length;i++){const o=n[i],r=mn(e,o.nodeRoute)??c.raise(`Node not found: ${o.nodeRoute}`),a=[];for(let e=0;e<o.bindTexts.length;e++)a[a.length]=o.bindTexts[e].createBinding(t,r);o.initializeForNode(r,a),s.push(...a)}return s}(e,t,this.#te)}}function yn(e){const t=e.detail?.target??null;if(null==t)return;const n=e.detail?.command??null;if(null==n)return;const s=n.split("-").map(((e,t)=>(void 0!==e[0]&&(e=e[0].toUpperCase()+e.slice(1)),e))).join(""),i=s.length>0?s[0].toLowerCase()+s.slice(1):s;if(Reflect.has(t,i)){const e=Reflect.get(t,i);Reflect.apply(e,t,[])}}function bn(e){const t=e.target;if(null==t)return;const n=t.getAttribute("command");if(null==n)return;const s=function(e){const t=e.getAttribute("commandfor");if(null==t)return null;if(":host"===t)return Wn(e);const n=Wn(e);if(null!=n){const e=n.quelQueryRoot.querySelector("#"+t);if(null!=e)return e}const s=document.getElementById(t);return null==s?null:s}(t);if(null==s)return;s.addEventListener("command",yn);const i={command:n,source:t,target:s};s.dispatchEvent(new CustomEvent("command",{detail:i}))}class xn{#ne;#se;#g;#x;#ie;#oe;#re={};#ae={};constructor(e){this.#se=e}get contentBindings(){return this.#se}get patternName(){return this.contentBindings.patternName}get parentPatternName(){return Pe(this.patternName).wildcardPaths.at(-2)}get parentNamedLoopContext(){const e=this.parentPatternName;if(void 0!==e)return this.namedLoopContexts[e]}get parentLoopContext(){let e=this.contentBindings.parentBinding?.parentContentBindings;for(;void 0!==e;){if(void 0!==e.loopContext&&e.loopContext!==this)return e.loopContext;e=e.parentBinding?.parentContentBindings}}get index(){return this.checkRevision(),void 0===this.#g&&(this.#g=this.contentBindings.parentBinding?.childrenContentBindings.indexOf(this.contentBindings)??c.raise("index is undefined")),this.#g}get serialLoopIndexes(){return this.checkRevision(),void 0===this.#ie&&(this.#ie=void 0===this.parentNamedLoopContext?Be(void 0,this.index):this.parentNamedLoopContext.loopIndexes.add(this.index)),this.#ie}get loopIndexes(){return this.checkRevision(),void 0===this.#x&&(this.#x=void 0===this.parentLoopContext?Be(void 0,this.index):this.parentLoopContext.loopIndexes.add(this.index)),this.#x}get namedLoopContexts(){return void 0===this.#oe&&(this.#oe=Object.assign(this.parentLoopContext?.namedLoopContexts??{},{[this.patternName]:this})),this.#oe}get loopTreeNodesByName(){return this.#re}get loopTreeLoopableNodesByName(){return this.#ae}checkRevision(){const e=this.contentBindings.parentBinding?.nodeProperty.revisionForLoop;return(void 0===this.#ne||this.#ne!==e)&&(this.#g=void 0,this.#x=void 0,this.#ie=void 0,this.#oe=void 0,!0)}dispose(){this.#g=void 0,this.#x=void 0,this.#ie=void 0,this.#oe=void 0}}class vn{#a;#C;#d;#le;#de;#ue;#ce;#pe;#he=!1;#me;#fe;#ge=new Set;get component(){return this.#C}set component(e){void 0!==e&&this.#me!==e.quelUseKeyed&&c.raise("useKeyed is different"),this.#C=e}get template(){return void 0===this.#d&&(this.#d=H(this.#a)??c.raise("template is undefined")),this.#d}get childBindings(){return void 0===this.#le&&c.raise("childBindings is undefined"),this.#le}get parentBinding(){return this.#de}set parentBinding(e){void 0!==e&&this.#he!==e.loopable&&c.raise("loopable is different"),this.#de=e}get loopContext(){return this.#ue}get childNodes(){return void 0===this.#ce&&c.raise("childNodes is undefined"),this.#ce}get lastChildNode(){return this.childNodes[this.childNodes.length-1]}get currentLoopContext(){return void 0===this.#ue?this.parentContentBindings?.loopContext:this.#ue}get parentContentBindings(){return this.parentBinding?.parentContentBindings}get fragment(){return void 0===this.#pe&&c.raise("fragment is undefined"),this.#pe}get allChildBindings(){const e=[];for(let t=0;t<this.childBindings.length;t++){e.push(this.childBindings[t]);for(let n=0;n<this.childBindings[t].childrenContentBindings.length;n++)e.push(...this.childBindings[t].childrenContentBindings[n].allChildBindings)}return e}get loopable(){return this.#he}get useKeyed(){return this.#me}get patternName(){return this.#fe}get localTreeNodes(){return this.#ge}constructor(e,t=!1,n=!1,s=!1,i=""){this.#a=e,this.#me=t,this.#he=s,this.#fe=i;const o=function(e,t){const n=e.dataset.uuid??c.raise("uuid not found");return fn[n]??(fn[n]=new gn(e,t))}(this.template,this.useKeyed);if(this.#pe=document.importNode(this.template.content,!0),this.#le=o.createBindings(this.#pe,this),n&&this.#pe.querySelectorAll("button[command]").forEach((e=>{e.addEventListener("click",bn)})),this.#ce=Array.from(this.#pe.childNodes),s){this.#ue=new xn(this);for(let e=0;e<this.childBindings.length;e++){const t=this.childBindings[e];t.stateProperty.lastWildCard===this.patternName&&(this.#ge.add(t),this.#ue?.loopTreeNodesByName[t.statePropertyName]?.add(t)??(this.#ue.loopTreeNodesByName[t.statePropertyName]=new Set([t])))}}}removeChildNodes(){this.fragment.append.apply(this.fragment,this.childNodes)}registerBindingsToSummary(){const e=this.component?.quelBindingSummary??c.raise("bindingSummary is undefined");for(let t=0;t<this.childBindings.length;t++)e.register(this.childBindings[t])}dispose(){this.childBindings.forEach((e=>e.dispose())),this.loopContext?.dispose(),this.#de=void 0,this.removeChildNodes();const e=`${this.#a}\t${this.#me}\t${this.#he}\t${this.#fe}`;Cn[e]?.push(this)??(Cn[e]=[this])}rebuild(){const e=[];for(let t=0;t<this.childBindings.length;t++){const n=this.childBindings[t];n.nodeProperty.isSelectValue?e.push(n):n.rebuild()}for(let t=0;t<e.length;t++)e[t].rebuild()}}const Cn={};function Pn(e,t){const n=t.component??c.raise("component is undefined"),s=n.quelUseKeyed,i=n.quelUseInvokeCommands,o=t.loopable,r=o?t.statePropertyName+".*":"",a=`${e}\t${s}\t${o}\t${r}`;let l=Cn[a]?.pop();return void 0===l&&(l=new vn(e,s,i,o,r)),l.component=n,l.parentBinding=t,l.registerBindingsToSummary(),l}const wn=e=>e.trim(),Sn=e=>e.length>0;class Bn{allBindings=new Set;noloopBindings={};rootLoopableBindings={};register(e){const t=e.parentContentBindings?.currentLoopContext;if(this.allBindings.add(e),e.loopable&&(void 0===t?this.rootLoopableBindings[e.statePropertyName]?.add(e)??(this.rootLoopableBindings[e.statePropertyName]=new Set([e])):t.loopTreeLoopableNodesByName[e.statePropertyName]?.add(e)??(t.loopTreeLoopableNodesByName[e.statePropertyName]=new Set([e]))),0===e.stateProperty.propInfo.wildcardCount)this.noloopBindings[e.statePropertyName]?.add(e)??(this.noloopBindings[e.statePropertyName]=new Set([e]));else if(!e.parentContentBindings.localTreeNodes.has(e)){const n=t?.namedLoopContexts[e.stateProperty.lastWildCard]??c.raise("loopContext is undefined");n.loopTreeNodesByName[e.statePropertyName]?.add(e)??(n.loopTreeNodesByName[e.statePropertyName]=new Set([e]))}}delete(e){const t=e.parentContentBindings?.currentLoopContext;if(this.allBindings.delete(e),e.loopable&&(void 0===t?this.rootLoopableBindings[e.statePropertyName]?.delete(e):t.loopTreeLoopableNodesByName[e.statePropertyName]?.delete(e)),0===e.stateProperty.propInfo.wildcardCount)this.noloopBindings[e.statePropertyName]?.delete(e);else if(!e.parentContentBindings.localTreeNodes.has(e)){const n=t?.namedLoopContexts[e.stateProperty.lastWildCard]??c.raise("loopContext is undefined");n.loopTreeNodesByName[e.statePropertyName]?.delete(e)}}exists(e){return this.allBindings.has(e)}_search(e,t,n,s,i,o){if(i<s.length){const r=Pe(s[i]),a=n.next().value??c.raise(`loopIndexes.at(${i}) is null`),l=r.patternPaths.at(-2)??"",d=void 0===e?Array.from(this.rootLoopableBindings[l]??[]):Array.from(e.loopTreeLoopableNodesByName[l]??[]);for(let e=0;e<d.length;e++)void 0!==d[e].childrenContentBindings[a]&&this._search(d[e].childrenContentBindings[a].loopContext,t,n,s,i+1,o)}else void 0===e||o.push(...Array.from(e.loopTreeNodesByName[t]??[]))}gatherBindings(e){let t;return void 0===e.loopIndexes||0===e.loopIndexes.size?t=Array.from(this.noloopBindings[e.pattern]??[]):(t=[],this._search(void 0,e.pattern,e.loopIndexes.forward(),e.patternInfo.wildcardPaths,0,t)),t}}const Nn={[ne]:({state:e,stateProxy:t,handler:n})=>async(n,s,i)=>e[n].apply(t,[s,...i?.loopIndexes.values??[]]),[se]:({handler:e})=>(t,n)=>e.updater.addUpdatedStateProperty(Te(t,n)),[ie]:({handler:e})=>()=>e.dependentProps,[oe]:({handler:e})=>()=>e.clearCache()};const In={[J]:(...e)=>({}),[Y]:(...e)=>({}),[Z]:(...e)=>({props:e})},Ln={[J]:"connected",[Y]:"disconnected",[Z]:"updated"};const Tn={[X]:"$connectedCallback",[ee]:"$disconnectedCallback",[te]:"$updatedCallback"},qn=new Set([X,ee,te]),En={[X]:J,[ee]:Y,[te]:Z},Fn=(e,t,n,s)=>async(...i)=>{const o=e[Tn[s]]?.apply(t,i);return function(e,t,n){const s=Ln[t]??c.raise(`Unknown event symbol: ${t.description} `),i=(In[t]??c.raise(`Unknown detail function for event symbol: ${t.description}`))(...n),o=new CustomEvent(s,{detail:i});e.dispatchEvent(o)}(n.element,En[s],i),o};const $n="$dependentProps",kn="$component",Mn="$addProcess",Vn={[$n]:({state:e})=>e[$n],[kn]:({handler:e})=>e.element,[Mn]:({handler:e,stateProxy:t})=>n=>e.updater.addProcess(n,t,[],e.loopContext)};function An(e,t){let n;const s=e.forward(),i=t.forward();for(;;){const e=s.next(),t=i.next();if(e.done||t.done)break;n=Be(n,t.value??e.value)}return n??c.raise("createOverrideLoopIndexes: loopIndexes is undefined.")}function Rn(e){const t=function(e){const t={};let n=e;for(;n!==Object.prototype;){const e=Object.getOwnPropertyDescriptors(n);for(const[n,s]of Object.entries(e))Reflect.has(t,n)||(t[n]=s);n=Object.getPrototypeOf(n)}return t}(e),n=[];for(const[e,s]of Object.entries(t))(s.get||s.set)&&n.push(e);return n}const Un=new Map;class On{defaultProps=new Set;propsByRefProp={};constructor(e){this.#ye(e)}setDefaultProp(e){if(this.defaultProps.has(e))return;const t=Pe(e);for(let e=t.patternPaths.length-1;e>=1;e--){const n=t.patternPaths[e-1],s=t.patternPaths[e];this.propsByRefProp[n]?.add(s)??(this.propsByRefProp[n]=new Set([s])),this.defaultProps.add(s)}}#ye(e){for(const[t,n]of Object.entries(e))for(const e of n)this.propsByRefProp[e]?.add(t)??(this.propsByRefProp[e]=new Set([t]))}}class jn{#C;#be;#xe;#ve;#Ce=!1;#Pe={};get accessorProperties(){return this.#be}get dependentProps(){return this.#xe}get element(){return this.#C}get component(){return this.#C}get updater(){return this.component.quelUpdater}get loopContext(){}get cache(){return this.#Pe}set cache(e){this.#Pe=e}get writable(){return this.#Ce}constructor(e,t){var n;this.#C=e,this.#be=new Set(function(e){let t=Un.get(e.constructor);return void 0===t&&(t=Rn(e),{}.constructor!==e.constructor&&Un.set(e.constructor,t)),t}(t)),this.#xe=(n=t.$dependentProps??{},new On(n)),this.#ve={[Q]:this.#be,[G]:this.#xe},this.#we.symbol=(e,t,n)=>this.#Se.apply(this,[e,t,n]),this.#we.string=(e,t,n)=>this.#Be.apply(this,[e,t,n])}getValue(e,t,n,s,i=t.paths.length-1,o=t.wildcardCount-1){let r,a,l,d,u=t.patternPaths[i];this.findPropertyCallback(u);const p=n?.get(t.wildcardPaths[o]);return this.writable?(r=Reflect.get(e,u,s))??(u in e||0===i?r:(a=t.patternElements[i],l="*"===a,this.getValue(e,t,n,s,i-1,o-(l?1:0))[l?p?.value??c.raise("wildcard is undefined"):a])):r=this.cache[d=u+":"+(p?.toString()??"")]??(d in this.cache?r:this.cache[d]=(r=Reflect.get(e,u,s))??(u in e||0===i?r:(a=t.patternElements[i],l="*"===a,this.getValue(e,t,n,s,i-1,o-(l?1:0))[l?p?.value??c.raise("wildcard is undefined"):a])))}getValueByPropInfo(e,t,n){let s;if(t.expandable)return this.getExpandValues(e,t,n);const i=()=>this.getValue(e,t,s,n),o=this.updater.namedLoopIndexesStack??c.raise("getValueFromPropInfoFn: namedLoopIndexesStack is undefined");if("context"===t.wildcardType||"none"===t.wildcardType)return s=o.lastNamedLoopIndexes,i();if("all"===t.wildcardType)return s=t.wildcardNamedLoopIndexes,o.setNamedLoopIndexes(s,i);{const e=An(o.lastNamedLoopIndexes?.get(t.pattern)??c.raise("getValueFromPropInfoFn: namedLoopIndexes is undefined"),t.wildcardNamedLoopIndexes.get(t.pattern)??c.raise("getValueFromPropInfoFn: namedLoopIndexes is undefined")),n=Te(t.pattern,e);return s=Ee(n),o.setNamedLoopIndexes(s,i)}}setValueByPropInfo(e,t,n,s){if(this.writable||c.raise("state is readonly"),t.expandable)return this.setExpandValues(e,t,n,s);let i;const o=()=>{try{if(1===t.elements.length)return Reflect.set(e,t.name,n,s);if(t.pattern in e)return Reflect.set(e,t.pattern,n,s);const o=Ie(t.patternPaths.at(-2)??c.raise("setValueFromPropInfoFn: parentPropInfo is undefined")),r=this.getValue(e,o,i,s),a=t.elements.at(-1)??c.raise("setValueFromPropInfoFn: lastElement is undefined"),l="*"===a;return Reflect.set(r,l?i?.get(t.pattern)?.value??c.raise("setValueFromPropInfoFn: wildcard index is undefined"):a,n)}finally{this.notifyCallback(t.pattern,i?.get(t.wildcardPaths.at(-1)??""))}},r=this.updater.namedLoopIndexesStack??c.raise("getValueFromPropInfoFn: namedLoopIndexesStack is undefined");if("context"===t.wildcardType||"none"===t.wildcardType)return i=r.lastNamedLoopIndexes,o();if("all"===t.wildcardType)return i=t.wildcardNamedLoopIndexes,r.setNamedLoopIndexes(i,o);{const e=An(r.lastNamedLoopIndexes?.get(t.pattern)??c.raise("getValueFromPropInfoFn: namedLoopIndexes is undefined"),t.wildcardNamedLoopIndexes.get(t.pattern)??c.raise("getValueFromPropInfoFn: namedLoopIndexes is undefined")),n=Te(t.pattern,e);return i=Ee(n),r.setNamedLoopIndexes(i,o)}}getExpandValues(e,t,n){"none"!==t.wildcardType&&"all"!==t.wildcardType||c.raise("wildcard type is invalid");const s=this.updater.namedLoopIndexesStack??c.raise("getExpandValuesFn: namedLoopIndexesStack is undefined"),i=s.lastNamedLoopIndexes??c.raise("getExpandValuesFn: namedLoopIndexes is undefined");let o,r;if("context"===t.wildcardType)if(t.wildcardCount>1){for(let e=t.wildcardPaths.length-1;e>=0;e--)if(i.has(t.wildcardPaths[e])){o=i.get(t.wildcardPaths[e])?.values;break}void 0===o&&c.raise("indexes is undefined"),o.length===t.wildcardCount?o[o.length-1]=void 0:o.length+1===t.wildcardCount?o.push(void 0):c.raise("indexes length is invalid"),r=o.length-1}else r=0,o=[void 0];else{let e=[];const n=t.wildcardLoopIndexes?.values??[];for(let s=n.length-1;s>=0&&(void 0===r&&void 0===n[s]&&(r=s),void 0===e&&i.has(t.wildcardPaths[s])&&(e=i.get(t.wildcardPaths[s])?.values??c.raise("loopIndexes is undefined")),void 0===r||void 0===e);s--);o=[];const s=t.wildcardLoopIndexes?.values??c.raise("wildcardIndexes is undefined");for(let n=0;n<t.wildcardCount;n++)n===r?o.push(void 0):o.push(s[n]??e[n])}void 0===r&&c.raise("lastIndex is undefined");const a=Ie(t.wildcardPaths[r]??c.raise("wildcard path is undefined")),l=Ie(a.paths.at(-2)??c.raise("wildcard parent path is undefined")),d=Se(o.slice(0,r)),u=Ee(Te(l.pattern,d)),p=this.getValue(e,l,u,n).length,h=[];for(let i=0;i<p;i++){o[r]=i;const a=Se(o),l=Ee(Te(t.pattern,a)),d=s.setNamedLoopIndexes(l,(()=>this.getValue(e,t,l,n)));h.push(d)}return h}setExpandValues(e,t,n,s){this.writable||c.raise("state is readonly"),"none"!==t.wildcardType&&"all"!==t.wildcardType||c.raise("wildcard type is invalid");const i=this.updater.namedLoopIndexesStack??c.raise("getExpandValuesFn: namedLoopIndexesStack is undefined"),o=i.lastNamedLoopIndexes??c.raise("getExpandValuesFn: namedLoopIndexes is undefined");let r,a;if("context"===t.wildcardType){a=(t.wildcardLoopIndexes?.size??0)-1;const e=t.wildcardPaths[a]??c.raise("lastWildcardPath is undefined");r=o.get(e)?.values??[void 0],r[r.length-1]=void 0}else{let e=[];const n=t.wildcardLoopIndexes?.values??[];for(let s=n.length-1;s>=0&&(void 0===a&&void 0===n[s]&&(a=s),void 0===e&&o.has(t.wildcardPaths[s])&&(e=o.get(t.wildcardPaths[s])?.values??c.raise("loopIndexes is undefined")),void 0===a||void 0===e);s--);r=[];const s=t.wildcardLoopIndexes?.values??c.raise("wildcardIndexes is undefined");for(let n=0;n<t.wildcardCount;n++)n===a?r.push(void 0):r.push(s[n]??e[n])}void 0===a&&c.raise("lastIndex is undefined");const l=Ie(t.wildcardPaths[a]??c.raise("wildcard path is undefined")),d=Ie(l.paths.at(-2)??c.raise("wildcard parent path is undefined")),u=Se(r.slice(0,a)),p=Ee(Te(d.pattern,u)),h=this.getValue(e,d,p,s).length;for(let o=0;o<h;o++){r[a]=o;const l=Ie(t.patternPaths.at(-2)??c.raise("setValueFromPropInfoFn: parentPropInfo is undefined")),d=Se(r.slice(0,l.wildcardCount)),u=Ee(Te(l.pattern,d)),p=i.setNamedLoopIndexes(u,(()=>this.getValue(e,l,u,s))),h=Se(r),m=t.elements.at(-1)??c.raise("setValueFromPropInfoFn: lastElement is undefined"),f="*"===m;Reflect.set(p,f?r.at(-1)??c.raise("setValueFromPropInfoFn: wildcard index is undefined"):m,Array.isArray(n)?n[o]:n),this.writable&&this.notifyCallback(t.pattern,h)}return!0}findPropertyCallback(e){const t=this.dependentProps;t.defaultProps.has(e)||t.setDefaultProp(e)}notifyCallback(e,t){this.updater.addUpdatedStateProperty(Te(e,t))}#Se(e,t,n){return this.#ve[t]??function(e,t,n,s){return qn.has(s)?(...i)=>Fn(e,t,n,s)(...i):void 0}(e,n,this,t)??function(e,t,n,s){return Nn[s]?.({state:e,stateProxy:t,handler:n})}(e,n,this,t)??void 0}#Be(e,t,n){return function(e,t,n,s){return Vn[s]?.({state:e,stateProxy:t,handler:n,prop:s})}(e,n,this,t)??void 0}#we={};clearCache(){this.cache={}}setWritable(e){this.writable&&c.raise("States: already writable"),this.#Ce=!0;try{return e()}finally{this.#Ce=!1,this.clearCache()}}async asyncSetWritable(e,t){this.writable&&c.raise("States: already writable"),this.#Ce=!0;try{return await t()}finally{this.#Ce=!1,this.clearCache()}}funcBySymbol={[re]:(e,t)=>n=>this.getValueByPropInfo(e,n,t),[ae]:(e,t)=>(n,s)=>this.setValueByPropInfo(e,n,s,t),[le]:(e,t)=>e=>this.setWritable(e),[de]:(e,t)=>async(e,t)=>{try{return await this.asyncSetWritable(e,t)}finally{}},[ue]:(e,t)=>()=>e};get(e,t,n){const s="string"==typeof t;do{const i=this.#we[typeof t]?.(e,t,n);if(void 0!==i)return i;if(s&&(t.startsWith("@@__")||"constructor"===t))break;if("symbol"==typeof t){let s=this.funcBySymbol[t]?.(e,n);if(void 0!==s)return s}if(!s)break;if("$"===t[0]){const e=Number(t.slice(1));if(isNaN(e))break;const n=(this.updater.namedLoopIndexesStack??c.raise("get: namedLoopIndexesStack is undefined")).lastNamedLoopIndexes??c.raise("get: namedLoopIndexes is undefined"),s=Array.from(n.values()).filter((t=>t.size===e));return 1!==s.length&&c.raise(`context index(${t}) is ambiguous or null`),s[0].value}const o=Ie(t);return this.getValueByPropInfo(e,o,n)}while(0);return Reflect.get(e,t,n)}set(e,t,n,s){this.writable||c.raise("state is readonly");const i="string"==typeof t;do{if(i&&t.startsWith("@@__"))break;if(!i)break;if("$"===t[0]){const e=Number(t.slice(1));if(isNaN(e))break;c.raise(`context index(${t}) is read only`)}const o=Ie(t);return this.setValueByPropInfo(e,o,n,s)}while(0);return Reflect.set(e,t,n,s)}}const Hn=new Map,Wn=e=>{let t=e;for(;;){if(t=t.parentNode,null==t)return;if(!0===Reflect.get(t,"quelIsQuelComponent"))return t;if(t instanceof ShadowRoot){if(!0===Reflect.get(t.host,"quelIsQuelComponent"))return t.host;t=t.host}const e=Hn.get(t);if(void 0!==e)return e}};const Dn=new Map;function _n(e){return class extends e{constructor(...e){var t,n;super(),this.#Ne=(t=this,n=Reflect.construct(this.quelStateClass,[]),new Proxy(n,new jn(t,n))),this.#Ie=new Bn,this.#Le=Promise.withResolvers(),this.#Te=function(e){return new He(e)}(this),this.#qe=function(e){return new Proxy({},new st(e))}(this)}#Ee;get quelParentComponent(){return void 0===this.#Ee&&(this.#Ee=Wn(this)),this.#Ee}#Le;get quelInitialPromises(){return this.#Le}#Fe;get quelAlivePromises(){return this.#Fe??c.raise("quelAlivePromises is undefined")}set quelAlivePromises(e){this.#Fe=e}#Ne;get quelState(){return this.#Ne??c.raise("quelState is undefined")}#$e;get quelViewRootElement(){return this.quelUseWebComponent?this.shadowRoot??this:this.quelPseudoParentNode}get quelQueryRoot(){return this.quelViewRootElement}#ke;get quelPseudoParentNode(){return this.quelUseWebComponent?c.raise("useWebComponent must be false"):this.#ke??c.raise("pseudoParentNode is undefined")}#Me;get quelPseudoNode(){return this.quelUseWebComponent?c.raise("useWebComponent must be false"):this.#Me??c.raise("pseudoNode is undefined")}#Ie;get quelBindingSummary(){return this.#Ie}#Te;get quelUpdater(){return this.#Te}#qe;get quelProps(){return this.#qe}#Ve;async#Ae(){if(this.quelUpdater.start(this.quelInitialPromises),((e=>-1!==e.indexOf("-"))(t=this.tagName.toLowerCase())||ce.has(t))&&this.quelUseShadowRoot&&this.quelUseWebComponent){const t=this.attachShadow({mode:"open"}),n=function(e){return e.map(fe).filter(ge)}((e=this,getComputedStyle(e)?.getPropertyValue("--adopted-css")?.split(" ").map(wn).filter(Sn)??[]));void 0!==this.quelStyleSheet&&n.push(this.quelStyleSheet),t.adoptedStyleSheets=n}else if(void 0!==this.quelStyleSheet){let e=this.quelStyleSheet;if(this.quelUseLocalSelector){const t=Dn.get(this.tagName);void 0!==t?e=t:(e=function(e,t){for(let n=0;n<e.cssRules.length;n++){const s=e.cssRules[n];if(s instanceof CSSStyleRule){const e=s.selectorText.split(",").map((e=>e.trim().startsWith(":host")?e.replace(":host",t):`${t} ${e}`)).join(",");s.selectorText=e}}return e}(this.quelStyleSheet,this.quelSelectorName),Dn.set(this.tagName,e))}const t=function(e){let t=e;for(;t;){if(t instanceof ShadowRoot)return t;t=t.parentNode}}(this.parentNode)??document,n=t.adoptedStyleSheets;n.includes(e)||(t.adoptedStyleSheets=n.concat(e))}var e,t;this.quelUseOverscrollBehavior&&("DIALOG"===this.tagName||this.hasAttribute("popover"))&&(this.style.overscrollBehavior="contain");try{await this.quelState[de](this.quelUpdater,(async()=>{await this.quelState[X]()}))}catch(e){console.error(e)}const n=this.quelTemplate.dataset.uuid??c.raise("uuid is undefined"),s=this.#$e=function(e,t){const n=e.quelUseKeyed,s=e.quelUseInvokeCommands,i=!1,o=`${t}\t${n}\tfalse\t`;let r=Cn[o]?.pop();return void 0===r&&(r=new vn(t,n,s,i)),r.component=e,r.registerBindingsToSummary(),r}(this,n);this.quelUpdater.namedLoopIndexesStack.setNamedLoopIndexes(Ee(),(()=>{s.rebuild()})),this.quelUseWebComponent?this.quelViewRootElement.appendChild(s.fragment):(this.quelViewRootElement.insertBefore(s.fragment,this.quelPseudoNode?.nextSibling??null),s.childNodes.forEach((e=>Hn.set(e,this))))}async connectedCallback(){await this.#Ve;try{if(this.quelParentComponent&&await this.quelParentComponent.quelInitialPromises.promise,!this.quelUseWebComponent){const e=document.createComment(`@@/${this.tagName}`),t=this.#ke=this.parentNode??c.raise("parentNode is undefined");this.#Me=e,t.replaceChild(e,this)}this.#Fe=Promise.withResolvers(),await this.#Ae()}finally{this.quelInitialPromises?.resolve&&this.quelInitialPromises.resolve()}}async disconnectedCallback(){this.quelUpdater.addProcess((async()=>{await this.quelState[ee]()}),void 0,[],void 0),this.#Ve=this.quelUpdater.terminate(),this.#Le=Promise.withResolvers()}}}class zn{#W;#Re;#Ue=new Set;get commandFor(){return this.#W}get button(){return this.#Re}get bindings(){return this.#Ue}get commandForElement(){return Ut(this.#Re,this.#W)}#D;get command(){return this.#D}get loopContext(){return this.#Ue.values().next().value?.parentContentBindings.loopContext}constructor(e){this.#Re=e,this.#W=e.getAttribute("commandfor")??"",this.#D=e.getAttribute("command")??""}addBinding(e){this.#Ue.add(e)}}class Kn{#Oe=new Map;#je;add(e){const t=new zn(e);return this.#Oe.set(e,t),t}addBinding(e,t){let n=this.#Oe.get(e);n||(n=this.add(e)),n.addBinding(t)}get(e){return this.#Oe.get(e)}get currentButton(){return this.#je}set currentButton(e){this.#je=e}}function Qn(e){return class extends e{#He;#We=function(){return new Kn}();get quelInvokerCommandsInfo(){return this.#We}constructor(...e){super(),this instanceof HTMLDialogElement&&this.addEventListener("close",(e=>{if(void 0!==this.#He){if(""===this.returnValue)this.#He.resolve(void 0);else{const e=this.quelProps[Ge]();this.#He.resolve(e)}this.#He=void 0}this.quelUseBufferedBind&&void 0!==this.quelParentComponent&&""!==this.returnValue&&this.quelCommitBufferedBindProps(),this.quelProps[Ze]()}))}#De(){if(this.quelUseBufferedBind&&void 0!==this.quelParentComponent){const e=this.quelProps[Qe]();this.quelProps[Ye](e)}for(const e in this.quelProps)this.quelState[se](e,void 0)}show(e=void 0,t=!1){!(this instanceof HTMLDialogElement)&&c.raise("This method can only be called from a dialog element.");const n=this.#He=t?Promise.withResolvers():void 0;if(e&&this.quelProps[Ye](e),this.#De(),HTMLDialogElement.prototype.show.apply(this),n)return n}showModal(e=void 0,t=!1){!(this instanceof HTMLDialogElement)&&c.raise("This method can only be called from a dialog element.");const n=this.#He=t?Promise.withResolvers():void 0;if(e&&this.quelProps[Ye](e),this.#De(),HTMLDialogElement.prototype.showModal.apply(this),n)return n}close(e=""){!(this instanceof HTMLDialogElement)&&c.raise("This method can only be called from a dialog element."),HTMLDialogElement.prototype.close.apply(this,[e])}}}class Gn{#H;#Re;#Ue=new Set;get targetId(){return this.#H}get button(){return this.#Re}get bindings(){return this.#Ue}get target(){return At(this.#Re,this.#H)}get loopContext(){return this.#Ue.values().next().value?.parentContentBindings.loopContext}constructor(e){this.#Re=e,this.#H=e.getAttribute("popovertarget")??""}addBinding(e){this.#Ue.add(e)}}class Jn{#_e=new Map;#je;add(e){const t=new Gn(e);return this.#_e.set(e,t),t}addBinding(e,t){let n=this.#_e.get(e);n||(n=this.add(e)),n.addBinding(t)}get(e){return this.#_e.get(e)}get currentButton(){return this.#je}set currentButton(e){this.#je=e}}function Yn(e){return class extends e{#ze;#Ke=function(){return new Jn}();get quelPopoverInfo(){return this.#Ke}get isPopover(){return this.hasAttribute("popover")}constructor(...e){super(),this.isPopover&&(this.addEventListener("hidden",(()=>{if(void 0!==this.#ze){const e=this.quelProps[Ge]();this.#ze.resolve(e),this.#ze=void 0}})),this.addEventListener("shown",(()=>{for(const e in this.quelProps)this.quelState[se](e,void 0)})),this.addEventListener("toggle",(e=>{const t=e;if("closed"===t.newState){const e=new CustomEvent("hidden");this.dispatchEvent(e)}else if("open"===t.newState){const e=new CustomEvent("shown");this.dispatchEvent(e)}})))}showPopover(e,t=!1){!this.isPopover&&c.raise("This method can only be called from a popover element.");const n=this.#ze=t?Promise.withResolvers():void 0;if(e&&this.quelProps[Ye](e),HTMLElement.prototype.showPopover.apply(this),n)return n}hidePopover(){!this.isPopover&&c.raise("This method can only be called from a popover element."),HTMLElement.prototype.hidePopover.apply(this)}}}function Zn(e){for(const[t,n]of Object.entries(e))ns(t,n)}const Xn=new Map,es=new Map,ts=t=>{const n=function(e){return Object.assign(new z,e)}(t);n.filters=Object.assign({},t.filters),n.config=Object.assign({},t.moduleConfig),n.options=Object.assign({},t.options);const s=n.config?.extends??n.options?.extends,i=function(t,n){const s=class extends n{#Qe=t;get quelIsQuelComponent(){return!0}#Ge;#Je(){let e=Xn.get(this.quelThisClass);if(void 0===e){const t=this.tagName.toLowerCase(),n=t.includes("-"),s=this.getAttribute("is");e={selectorName:n?t:`${t}[is="${s}"]`,lowerTagName:t,isAutonomousCustomElement:n,isCostomizedBuiltInElement:!!s},Xn.set(this.quelThisClass,e)}this.#Ge=e}get quelHtml(){return this.#Qe.html}set quelHtml(e){this.#Qe.html=e}get quelTemplate(){return this.#Qe.template}get quelCss(){return this.#Qe.css}set quelCss(e){this.#Qe.css=e}get quelStyleSheet(){return this.#Qe.styleSheet}get quelStateClass(){return this.#Qe.State}get quelUseShadowRoot(){return this.#Qe.moduleConfig.useShadowRoot??e.useShadowRoot}get quelUseWebComponent(){return this.#Qe.moduleConfig.useWebComponent??e.useWebComponent}get quelUseLocalTagName(){return this.#Qe.moduleConfig.useLocalTagName??e.useLocalTagName}get quelUseKeyed(){return this.#Qe.moduleConfig.useKeyed??e.useKeyed}get quelUseLocalSelector(){return this.#Qe.moduleConfig.useLocalSelector??e.useLocalSelector}get quelUseOverscrollBehavior(){return this.#Qe.moduleConfig.useOverscrollBehavior??e.useOverscrollBehavior}get quelUseInvokeCommands(){return this.#Qe.moduleConfig.useInvokerCommands??e.useInvokerCommands}get quelLowerTagName(){return this.#Ge?.lowerTagName??c.raise(`lowerTagName is not found for ${this.tagName}`)}get quelSelectorName(){return this.#Ge?.selectorName??c.raise(`selectorName is not found for ${this.tagName}`)}get quelIsAutonomousCustomElement(){return this.#Ge?.isAutonomousCustomElement??c.raise(`isAutonomousCustomElement is not found for ${this.tagName}`)}get quelIsCostomizedBuiltInElement(){return this.#Ge?.isCostomizedBuiltInElement??c.raise(`isCostomizedBuiltInElement is not found for ${this.tagName}`)}#a=c.createUUID();get quelUUID(){return this.#a}#Ye;#Ze(){let e=es.get(this.quelThisClass);if(void 0===e){e={inputFilterManager:new M,outputFilterManager:new $,eventFilterManager:new A};for(const[t,n]of Object.entries(this.#Qe.filters.input??{}))e.inputFilterManager.registerFilter(t,n);for(const[t,n]of Object.entries(this.#Qe.filters.output??{}))e.outputFilterManager.registerFilter(t,n);for(const[t,n]of Object.entries(this.#Qe.filters.event??{}))e.eventFilterManager.registerFilter(t,n);es.set(this.quelThisClass,e)}this.#Ye=e}get quelInputFilterManager(){return this.#Ye?.inputFilterManager??c.raise("inputFilterManager is not found")}get quelOutputFilterManager(){return this.#Ye?.outputFilterManager??c.raise("outputFilterManager is not found")}get quelEventFilterManager(){return this.#Ye?.eventFilterManager??c.raise("eventFilterManager is not found")}get quelElement(){return this}constructor(){super(),this.#Je(),this.#Ze()}static quelBaseClass=n;get quelBaseClass(){return Reflect.get(this.constructor,"quelBaseClass")}static quelThisClass;get quelThisClass(){return Reflect.get(this.constructor,"quelThisClass")}static _module=t;static get html(){return this._module.html}static set html(e){this._module.html=e}static get css(){return this._module.css}static set css(e){this._module.css=e}};return s.quelThisClass=s,s}(n,s?document.createElement(s).constructor:HTMLElement),o=Yn(Qn((r=_n(i),class extends r{get quelUseBufferedBind(){return this.hasAttribute("buffered-bind")}quelCommitBufferedBindProps(){this.quelUseBufferedBind&&this.quelProps[Je]()}})));var r;return Zn(n.componentModulesForRegister??{}),o};function ns(e,t){const n=c.toKebabCase(e),s=ts(t),i=t.moduleConfig?.extends??t.options?.extends;void 0===i?customElements.define(n,s):customElements.define(n,s,{extends:i})}const ss="*filter-";const is=p.create(((e,t)=>{if(e.startsWith(ss)){const n=e.slice(8),{output:s,input:i,event:o}=t;s&&$.registerFilter(n,s),i&&M.registerFilter(n,i),o&&A.registerFilter(n,o)}else!function(e,t){if("function"!=typeof e)return!1;let n=e;for(;n;){if(n===t)return!0;n=Object.getPrototypeOf(n)}return!1}(t,HTMLElement)?"State"in t&&"html"in t&&ns(e,t):customElements.define(e,t)}));async function os(t,n){const s=await fetch(t.resolve(n??"./quel.config.json")),i=await s.json();for(let[t,n]of Object.entries(e))e[t]=void 0!==i[t]?i[t]:n;await is.config(i).load()}function rs(e){return e.replaceAll(/<!--\{\{([^\}]+)\}\}-->/g,((e,t)=>`{{${t}}}`))}async function as(e){const t=document.createElement("template"),n=await fetch(function(e,t){return e.resolve(t)}(import.meta,e));let s;t.innerHTML=(await n.text()).replaceAll(/\{\{([^\}]+)\}\}/g,((e,t)=>`\x3c!--{{${t}}}--\x3e`));const i=t.content.querySelector("script");let o;i?(s=await import("data:text/javascript;charset=utf-8,"+i.text),i.remove()):s={State:class{}};const r=t.content.querySelector("style");r?(o={css:r.textContent},r.remove()):o={};const a={html:rs(t.innerHTML).trim()};return Object.assign({},s,a,o)}async function ls(e,t){ns(e,await as(t))}async function ds(e){for(const[t,n]of Object.entries(e??{}))await ls(t,n)}async function us(e){const t=await as(e);return ts(t)}function cs(e){Object.entries(e).forEach((([e,t])=>{const{input:n,output:s,event:i}=t;n&&M.registerFilter(e,n),s&&$.registerFilter(e,s),i&&A.registerFilter(e,i)}))}void 0===Map.groupBy&&(Map.groupBy=function(e,t){return e.reduce(((e,n,s)=>{const i=t(n,s);return e.has(i)||e.set(i,[]),e.get(i).push(n),e}),new Map)}),void 0===Object.groupBy&&(Object.groupBy=function(e,t){return e.reduce((function(e,n){return(e[n[t]]=e[n[t]]||[]).push(n),e}),{})}),void 0===Promise.withResolvers&&(Promise.withResolvers=function(){let e,t;return{promise:new Promise(((n,s)=>{e=n,t=s})),resolve:e,reject:t}}),void 0===Array.prototype.toSorted&&(Array.prototype.toSorted=function(e){return this.slice().sort(e)}),void 0===Array.prototype.toReversed&&(Array.prototype.toReversed=function(){return this.slice().reverse()});export{os as bootFromImportMeta,e as config,ts as generateComponentClass,us as generateSingleFileComponentClass,t as getCustomTagFromImportMeta,s as importCssFromImportMeta,n as importHtmlFromImportMeta,as as loadSingleFileComponent,is as loader,Zn as registerComponentModules,cs as registerFilters,ds as registerSingleFileComponents};
