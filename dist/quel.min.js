window.elapsedTimes={};class e{static raise(e){throw new Error(e)}static isFunction=e=>{const t=Object.prototype.toString.call(e).slice(8,-1).toLowerCase();return"function"===t||"asyncfunction"===t};static isInputableElement(e){return e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement||e instanceof HTMLInputElement&&"button"!==e.type}static toKebabCase=e=>"string"==typeof e?e.replaceAll(/_/g,"-").replaceAll(/([A-Z])/g,((e,t,s)=>(s>0?"-":"")+t.toLowerCase())):e;static createUUID(){return window?.crypto?.randomUUID?window.crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=((new Date).getTime()+16*Math.random())%16|0;return("x"==e?t:3&t|8).toString(16)}))}}const t=(e,t,s)=>{if(null==e)return e;const i=Number(e);return isNaN(i)?e:s(i,t)},s=(e,t,s)=>null==e?e:s(String(e),t),i=(e,t,s)=>Array.isArray(e)?s(e,t):e;class r{static styleDisplay=(e,t)=>e?t[0]??"":"none";static truthy=(e,t)=>!!e;static falsey=(e,t)=>!e;static not=this.falsey;static eq=(e,t)=>e==t[0];static ne=(e,t)=>e!=t[0];static lt=(e,t)=>Number(e)<Number(t[0]);static le=(e,t)=>Number(e)<=Number(t[0]);static gt=(e,t)=>Number(e)>Number(t[0]);static ge=(e,t)=>Number(e)>=Number(t[0]);static embed=(e,t)=>null!=e?decodeURIComponent((t[0]??"").replaceAll("%s",e)):null;static ifText=(e,t)=>e?t[0]??null:t[1]??null;static null=(e,t)=>null==e;static offset=(e,t)=>Number(e)+Number(t[0]);static unit=(e,t)=>String(e)+String(t[0]);static inc=this.offset;static mul=(e,t)=>Number(e)*Number(t[0]);static div=(e,t)=>Number(e)/Number(t[0]);static mod=(e,t)=>Number(e)%Number(t[0]);static"str.at"=(e,t)=>s(e,t,((e,t)=>e.at(...t)));static"str.charAt"=(e,t)=>s(e,t,((e,t)=>e.charAt(...t)));static"str.charCodeAt"=(e,t)=>s(e,t,((e,t)=>e.charCodeAt(...t)));static"str.codePointAt"=(e,t)=>s(e,t,((e,t)=>e.codePointAt(...t)));static"str.concat"=(e,t)=>s(e,t,((e,t)=>e.concat(...t)));static"str.endsWith"=(e,t)=>s(e,t,((e,t)=>e.endsWith(...t)));static"str.includes"=(e,t)=>s(e,t,((e,t)=>e.includes(...t)));static"str.indexOf"=(e,t)=>s(e,t,((e,t)=>e.indexOf(...t)));static"str.lastIndexOf"=(e,t)=>s(e,t,((e,t)=>e.lastIndexOf(...t)));static"str.localeCompare"=(e,t)=>s(e,t,((e,t)=>e.localeCompare(...t)));static"str.match"=(e,t)=>s(e,t,((e,t)=>e.match(...t)));static"str.normalize"=(e,t)=>s(e,t,((e,t)=>e.normalize(...t)));static"str.padEnd"=(e,t)=>s(e,t,((e,t)=>e.padEnd(...t)));static"str.padStart"=(e,t)=>s(e,t,((e,t)=>e.padStart(...t)));static"str.repeat"=(e,t)=>s(e,t,((e,t)=>e.repeat(...t)));static"str.replace"=(e,t)=>s(e,t,((e,t)=>e.replace(...t)));static"str.replaceAll"=(e,t)=>s(e,t,((e,t)=>e.replaceAll(...t)));static"str.search"=(e,t)=>s(e,t,((e,t)=>e.search(...t)));static"str.slice"=(e,t)=>s(e,t,((e,t)=>e.slice(...t)));static"str.split"=(e,t)=>s(e,t,((e,t)=>e.split(...t)));static"str.startsWith"=(e,t)=>s(e,t,((e,t)=>e.startsWith(...t)));static"str.substring"=(e,t)=>s(e,t,((e,t)=>e.substring(...t)));static"str.toLocaleLowerCase"=(e,t)=>s(e,t,((e,t)=>e.toLocaleLowerCase(...t)));static"str.toLocaleUpperCase"=(e,t)=>s(e,t,((e,t)=>e.toLocaleUpperCase(...t)));static"str.toLowerCase"=(e,t)=>s(e,t,((e,t)=>e.toLowerCase(...t)));static"str.toUpperCase"=(e,t)=>s(e,t,((e,t)=>e.toUpperCase(...t)));static"str.trim"=(e,t)=>s(e,t,((e,t)=>e.trim(...t)));static"str.trimEnd"=(e,t)=>s(e,t,((e,t)=>e.trimEnd(...t)));static"str.trimStart"=(e,t)=>s(e,t,((e,t)=>e.trimStart(...t)));static"num.toExponential"=(e,s)=>t(e,s,((e,t)=>e.toExponential(...t)));static"num.toFixed"=(e,s)=>t(e,s,((e,t)=>e.toFixed(...t)));static"num.toLocaleString"=(e,s)=>t(e,s,((e,t)=>e.toLocaleString(...t)));static"num.toPrecision"=(e,s)=>t(e,s,((e,t)=>e.toPrecision(...t)));static"arr.at"=(e,t)=>i(e,t,((e,t)=>e.at(...t)));static"arr.concat"=(e,t)=>i(e,t,((e,t)=>e.concat(...t)));static"arr.entries"=(e,t)=>i(e,t,((e,t)=>e.entries(...t)));static"arr.flat"=(e,t)=>i(e,t,((e,t)=>e.flat(...t)));static"arr.includes"=(e,t)=>i(e,t,((e,t)=>e.includes(...t)));static"arr.indexOf"=(e,t)=>i(e,t,((e,t)=>e.indexOf(...t)));static"arr.join"=(e,t)=>i(e,t,((e,t)=>e.join(...t)));static"arr.keys"=(e,t)=>i(e,t,((e,t)=>e.keys(...t)));static"arr.lastIndexOf"=(e,t)=>i(e,t,((e,t)=>e.lastIndexOf(...t)));static"arr.slice"=(e,t)=>i(e,t,((e,t)=>e.slice(...t)));static"arr.toLocaleString"=(e,t)=>i(e,t,((e,t)=>e.toLocaleString(...t)));static"arr.toReversed"=(e,t)=>i(e,t,((e,t)=>e.toReversed(...t)));static"arr.toSorted"=(e,t)=>i(e,t,((e,t)=>e.toSorted(...t)));static"arr.toSpliced"=(e,t)=>i(e,t,((e,t)=>e.toSpliced(...t)));static"arr.values"=(e,t)=>i(e,t,((e,t)=>e.values(...t)));static"arr.with"=(e,t)=>i(e,t,((e,t)=>e.with(...t)));static get at(){return(e,t)=>(Array.isArray(e)?this["arr.at"]:this["str.at"])(e,t)}static get charAt(){return this["str.charAt"]}static get charCodeAt(){return this["str.charCodeAt"]}static get codePointAt(){return this["str.codePointAt"]}static get concat(){return(e,t)=>(Array.isArray(e)?this["arr.concat"]:this["str.concat"])(e,t)}static get endsWith(){return this["str.endsWith"]}static get entries(){return this["arr.entries"]}static get flat(){return this["arr.flat"]}static get includes(){return(e,t)=>(Array.isArray(e)?this["arr.includes"]:this["str.includes"])(e,t)}static get indexOf(){return(e,t)=>(Array.isArray(e)?this["arr.indexOf"]:this["str.indexOf"])(e,t)}static get join(){return this["arr.join"]}static get keys(){return this["arr.keys"]}static get lastIndexOf(){return(e,t)=>(Array.isArray(e)?this["arr.lastIndexOf"]:this["str.lastIndexOf"])(e,t)}static get localeCompare(){return this["str.localeCompare"]}static get match(){return this["str.match"]}static get normalize(){return this["str.normalize"]}static get padEnd(){return this["str.padEnd"]}static get padStart(){return this["str.padStart"]}static get repeat(){return this["str.repeat"]}static get replace(){return this["str.replace"]}static get replaceAll(){return this["str.replaceAll"]}static get search(){return this["str.search"]}static get slice(){return(e,t)=>(Array.isArray(e)?this["arr.slice"]:this["str.slice"])(e,t)}static get split(){return this["str.split"]}static get startsWith(){return this["str.startsWith"]}static get substring(){return this["str.substring"]}static get toExponential(){return this["num.toExponential"]}static get toFixed(){return this["num.toFixed"]}static get toLocaleString(){return(e,t)=>(Array.isArray(e)?this["arr.toLocaleString"]:this["num.toLocaleString"])(e,t)}static get toLocaleLowerCase(){return this["str.toLocaleLowerCase"]}static get toLocaleUpperCase(){return this["str.toLocaleUpperCase"]}static get toLowerCase(){return this["str.toLowerCase"]}static get toPrecision(){return this["num.toPrecision"]}static get toReversed(){return this["arr.toReversed"]}static get toSorted(){return this["arr.toSorted"]}static get toSpliced(){return this["arr.toSpliced"]}static get toUpperCase(){return this["str.toUpperCase"]}static get trim(){return this["str.trim"]}static get trimEnd(){return this["str.trimEnd"]}static get trimStart(){return this["str.trimStart"]}static get values(){return this["arr.values"]}static get with(){return this["arr.with"]}}class o{static number=(e,t)=>""===e?null:Number(e);static boolean=(e,t)=>""===e?null:Boolean(e)}class n{name;options;static applyForInput(e,t,s){return t.reduceRight(((e,t)=>t.name in s?s[t.name](e,t.options):e),e)}static applyForOutput(e,t,s){return t.reduce(((e,t)=>t.name in s?s[t.name](e,t.options):e),e)}static regist(t,s,i){t in r&&e.raise(`regist filter error duplicate name (${t})`),t in o&&e.raise(`regist filter error duplicate name (${t})`),s&&(r[t]=s),i&&(o[t]=i)}}const a=1,l=10,c=20,d=21,p=22,h=23,u=30,m=40,f=91,y=92,g=95,w="if",x="loop",P="quel",v="*",b="dot-notation",N={directlyGet:Symbol.for(b+".direct_get"),directlySet:Symbol.for(b+".direct_set"),isSupportDotNotation:Symbol.for(b+".is_support_dot_notation")},M=new RegExp(/^\$([0-9]+)$/);class C{name;pathNames=[];parentPathNames=[];parentPath;parentPaths=[];setOfParentPaths;regexp;level=0;isPrimitive;constructor(e){if(this.name=e,this.pathNames=e.split("."),this.parentPathNames=this.pathNames.slice(0,-1),this.parentPaths=this.parentPathNames.reduce(((e,t)=>(e.push(e.at(-1)?.concat(t)??[t]),e)),[]).map((e=>e.join("."))),this.setOfParentPaths=new Set(this.parentPaths),this.parentPath=this.parentPathNames.join("."),this.lastPathName=this.pathNames.at(-1),this.regexp=new RegExp("^"+e.replaceAll(".","\\.").replaceAll("*","([0-9a-zA-Z_]*)")+"$"),this.level=this.pathNames.filter((e=>e===v)).length,this.isPrimitive=1===this.pathNames.length,this.nearestWildcardName=void 0,this.nearestWildcardParentName=void 0,this.level>0)for(let e=this.pathNames.length-1;e>=0;e--)if(this.pathNames[e]===v){this.nearestWildcardName=this.pathNames.slice(0,e+1).join("."),this.nearestWildcardParentName=this.pathNames.slice(0,e).join(".");break}}static create(e){const t=this.propertyNameByName.get(e);if(t)return t;const s=new C(e);return this.propertyNameByName.set(e,s),s}static propertyNameByName=new Map;static parse(e){const t=[],s=[];for(const i of e.split(".")){const e=Number(i);isNaN(e)?s.push(i):(t.push(e),s.push("*"))}return{propName:C.create(s.join(".")),indexes:t}}}let V=class{#e=[];#t=new Map;get lastIndexes(){return this.#e[this.#e.length-1]}get stackIndexes(){return this.#e}get matchByName(){return this.#t}getByPropertyName(e,{propName:t},s){let i;if(Reflect.has(e,t.name))i=Reflect.get(e,t.name,s);else if(""!==t.parentPath){const r=C.create(t.parentPath),o=this.getByPropertyName(e,{propName:r},s);if(void 0!==o){const e=t.lastPathName===v?this.lastIndexes[t.level-1]:t.lastPathName;i=Reflect.get(o,e)}}return i}setByPropertyName(e,{propName:t,value:s},i){let r=!1;if(Reflect.has(e,t.name)||t.isPrimitive)r=Reflect.set(e,t.name,s,i);else{const o=C.create(t.parentPath),n=this.getByPropertyName(e,{propName:o},i);if(void 0!==n){const e=t.lastPathName===v?this.lastIndexes[t.level-1]:t.lastPathName;r=Reflect.set(n,e,s)}}return r}pushIndexes(e,t){this.#e.push(e);try{return Reflect.apply(t,this,[])}finally{this.#e.pop()}}getFunc=(e,t)=>({propName:s,indexes:i})=>this.pushIndexes(i,(()=>this.getByPropertyName(e,{propName:s},t)));setFunc=(e,t)=>({propName:s,indexes:i},r)=>this.pushIndexes(i,(()=>this.setByPropertyName(e,{propName:s,value:r},t)));getExpandLastLevel(e,{propName:t,indexes:s},i){const r=this.getFunc(e,i);if(void 0===t.nearestWildcardName)throw new Error(`not found wildcard path of '${t.name}'`);const o=C.create(t.nearestWildcardParentName);return r({propName:o,indexes:s}).map(((e,i)=>r({propName:t,indexes:s.concat(i)})))}setExpandLastLevel(e,{propName:t,indexes:s,values:i},r){const o=this.getFunc(e,r),n=this.setFunc(e,r);if(void 0===t.nearestWildcardName)throw new Error(`not found wildcard path of '${t.name}'`);const a=C.create(t.nearestWildcardParentName),l=o({propName:a,indexes:s}),c=Array.isArray(i)?i:[...Array(l.length)].map((e=>i));if(t.nearestWildcardName===t.name)n({propName:a,indexes:s},c);else{if(c.length!==l.length)throw new Error(`not match array count '${t.name}'`);for(let e in l)n({propName:t,indexes:s.concat(Number(e))},c[e])}return!0}[N.directlyGet](e,{prop:t,indexes:s},i){const r=C.create(t);return this.pushIndexes(s,(()=>this.getByPropertyName(e,{propName:r},i)))}[N.directlySet](e,{prop:t,indexes:s,value:i},r){const o=C.create(t);return this.pushIndexes(s,(()=>this.setByPropertyName(e,{propName:o,value:i},r)))}get(e,t,s){const i="string"==typeof t;if(i&&(t.startsWith("@@__")||"constructor"===t))return Reflect.get(e,t,s);const r=this.getFunc(e,s),o=this.lastIndexes;let n;if(t===N.directlyGet)return(t,i)=>Reflect.apply(this[N.directlyGet],this,[e,{prop:t,indexes:i},s]);if(t===N.directlySet)return(t,i,r)=>Reflect.apply(this[N.directlySet],this,[e,{prop:t,indexes:i,value:r},s]);if(t===N.isSupportDotNotation)return!0;if(i){if(n=M.exec(t))return o?.[Number(n[1])-1]??void 0;if("@"===t.at(0)){const i=t.slice(1),r=C.create(i);if((o?.length??0)+1<r.level)throw new Error("array level not match");const n=o?.slice(0,r.level-1)??[];return this.getExpandLastLevel(e,{propName:r,indexes:n},s)}if(this.#t.has(t))return r(this.#t.get(t));const i=C.parse(t);return i.propName.level===i.indexes.length&&this.#t.set(t,i),r({propName:i.propName,indexes:i.indexes.concat(o?.slice(i.indexes.length)??[])})}return Reflect.get(e,t,s)}set(e,t,s,i){if("string"==typeof t){if(t.startsWith("@@__")||"constructor"===t)return Reflect.set(e,t,s,i);const r=this.setFunc(e,i),o=this.lastIndexes;if("@"===t.at(0)){const r=t.slice(1),o=C.create(r);if((this.lastIndexes?.length??0)+1<o.level)throw new Error("array level not match");const n=this.lastIndexes?.slice(0,o.level-1)??[];return this.setExpandLastLevel(e,{propName:o,indexes:n,values:s},i)}if(this.#t.has(t))return r(this.#t.get(t),s);const n=C.parse(t);return n.propName.level===n.indexes.length&&this.#t.set(t,n),r({propName:n.propName,indexes:n.indexes.concat(o?.slice(n.indexes.length)??[])},s)}return Reflect.set(e,t,s,i)}};const E=Object.assign({connectedCallback:Symbol.for(`${P}:viewModel.connectedCallback`),disconnectedCallback:Symbol.for(`${P}:viewModel.disconnectedCallback`),initCallback:Symbol.for(`${P}:viewModel.initCallback`),writeCallback:Symbol.for(`${P}:viewModel.writeCallback`),getDependentProps:Symbol.for(`${P}:viewModel.getDependentProps`),getHandler:Symbol.for(`${P}:viewModel.getHandler`),addNotify:Symbol.for(`${P}:viewModel.addNotify`),beCacheable:Symbol.for(`${P}:viewModel.beCacheable`),beUncacheable:Symbol.for(`${P}:viewModel.beUncacheable`),boundByComponent:Symbol.for(`${P}:globalData.boundByComponent`),directlyCall:Symbol.for(`${P}:viewModel.directCall`),bindTo:Symbol.for(`${P}:componentModule.bindTo`),notifyForDependentProps:Symbol.for(`${P}:viewModel.notifyForDependentProps`),bindProperty:Symbol.for(`${P}:props.bindProperty`),toObject:Symbol.for(`${P}:props.toObject`),isComponent:Symbol.for(`${P}:component.isComponent`)},N);class S{type;nodePropertyElements=[];eventType;static nodePropertyInfoByKey={};static get(t,s){const i=new S,r=`${t.constructor.name}\t${t.textContent[2]}\t${t[E.isComponent]}\t${s}`,o=this.nodePropertyInfoByKey[r];if(void 0!==o)return i.type=o.type,i.nodePropertyElements=o.nodePropertyElements.slice(0),i.eventType=o.eventType,i;do{if(i.nodePropertyElements=s.split("."),t instanceof Comment&&"|"===t.textContent[2]){if(s===w||s===x){i.type=g;break}e.raise(`template illegal property ${s}`)}if(t[E.isComponent]&&"props"===i.nodePropertyElements[0]){i.type=y;break}if(t instanceof HTMLElement||t instanceof SVGElement)1===i.nodePropertyElements.length?i.nodePropertyElements[0].startsWith("on")?(i.type=f,i.eventType=i.nodePropertyElements[0].slice("on".length)):"class"===i.nodePropertyElements[0]?i.type=h:"radio"===i.nodePropertyElements[0]?i.type=u:"checkbox"===i.nodePropertyElements[0]?i.type=m:i.type=l:2===i.nodePropertyElements.length?"class"===i.nodePropertyElements[0]?i.type=p:"style"===i.nodePropertyElements[0]?i.type=d:"attr"===i.nodePropertyElements[0]?i.type=c:e.raise(`unknown property ${s}`):e.raise(`unknown property ${s}`);else if(1===i.nodePropertyElements.length&&"textContent"===i.nodePropertyElements[0])i.type=a;else{const i=Object.prototype.toString.call(t).slice(8,-1).toLowerCase();e.raise(`unknown node ${i} or property ${s}`)}}while(0);return this.nodePropertyInfoByKey[r]=i,i}}class k{#s;get node(){return this.#s}set node(e){this.#s=e}get element(){return this.node instanceof Element?this.node:e.raise("not Element")}get htmlElement(){return this.node instanceof HTMLElement?this.node:e.raise("not HTMLElement")}get svgElement(){return this.node instanceof SVGElement?this.node:e.raise("not SVGElement")}#i;get nodeProperty(){return this.#i}set nodeProperty(e){this.#i=e}#r;get nodePropertyElements(){return this.#r}set nodePropertyElements(e){this.#r=e}component;viewModel;#o;get viewModelProperty(){return this.#o}set viewModelProperty(e){this.#o=e,this.#n=void 0,this.#a=void 0,this.#l=void 0,this.#c=void 0}#n;get viewModelPropertyName(){return void 0===this.#n&&(this.#n=C.create(this.#o)),this.#n}#l;get contextIndex(){return void 0===this.#l&&!0===this.isContextIndex&&(this.#l=Number(this.viewModelProperty.slice(1))-1),this.#l}#a;get isContextIndex(){return void 0===this.#a&&(this.#a=!!M.exec(this.viewModelProperty)),this.#a}filters;#c;get contextParam(){if(void 0===this.#c){const e=this.viewModelPropertyName;e.level>0&&(this.#c=this.context.stack.find((t=>t.propName.name===e.nearestWildcardParentName)))}return this.#c}get indexes(){return this.contextParam?.indexes??[]}get indexesString(){return this.indexes.toString()}get viewModelPropertyKey(){return this.viewModelProperty+"\t"+this.indexesString}get contextIndexes(){return this.context.indexes}lastNodeValue;lastViewModelValue;lastViewModelFilteredValue;#d;get context(){return this.#d}set context(e){this.#d=e,this.#c=void 0}eventType;defaultEventHandler;defaultEventType;getViewModelValue(){return this.isContextIndex?this.contextIndexes[this.contextIndex]:this.viewModel[E.directlyGet](this.viewModelProperty,this.indexes)}setViewModelValue(e){this.isContextIndex||this.viewModel[E.directlySet](this.viewModelProperty,this.indexes,e)}updateNode(){}forceUpdateNode(){}updateViewModel(){}changeIndexes(e,t){}removeFromParent(){}}const T=1,I=2,O=3,F=4,R=5,A=6;class U{node;property;viewModelProperty;value;updateFunc;constructor(e,t,s,i,r){this.node=e,this.property=t,this.viewModelProperty=s,this.value=i,this.updateFunc=r}}class ${queue=[];#p;constructor(e){this.#p=e}reorder(e){return e.sort(((e,t)=>e.node instanceof HTMLTemplateElement&&t.node instanceof HTMLTemplateElement?0:t.node instanceof HTMLTemplateElement?1:e.node instanceof HTMLTemplateElement?-1:e.node instanceof HTMLSelectElement&&"value"===e.property&&t.node instanceof HTMLSelectElement&&"value"===t.property?0:e.node instanceof HTMLSelectElement&&"value"===e.property?1:t.node instanceof HTMLSelectElement&&"value"===t.property?-1:0)),e}async exec(){this.#p&&this.#p(R);try{for(;this.queue.length>0;){const e=this.queue.splice(0),t=this.reorder(e);for(const e of t)Reflect.apply(e.updateFunc,e,[])}}finally{this.#p&&this.#p(A)}}get isEmpty(){return 0===this.queue.length}}const B="className";class L extends k{get radio(){const t=(s=this.element)instanceof HTMLInputElement?s:e.raise();var s;return"radio"===t.type?t:e.raise("not radio")}updateNode(){const{component:e,node:t,radio:s,nodeProperty:i,viewModelProperty:r,filters:o}=this,a=this.getViewModelValue();if(this.lastViewModelValue!==a){const l=o.length>0?n.applyForOutput(a,o,e.filters.out):a;this.lastViewModelFilteredValue!==l&&(e.updateSlot.addNodeUpdate(new U(t,i,r,l,(()=>{s.checked=l===s.value}))),this.lastViewModelFilteredValue=l),this.lastViewModelValue=a}}forceUpdateNode(){const{component:e,node:t,radio:s,nodeProperty:i,viewModelProperty:r,filters:o}=this,a=this.getViewModelValue(),l=o.length?n.applyForOutput(a,o,e.filters.out):a,c=l===s.value;s.checked!==c&&e.updateSlot.addNodeUpdate(new U(t,i,r,l,(()=>{s.checked=c}))),this.lastViewModelFilteredValue=l,this.lastViewModelValue=a}updateViewModel(){const{component:e,filters:t,radio:s}=this;if(s.checked){const i=n.applyForInput(s.value,t,e.filters.in);this.setViewModelValue(i)}}}class j extends k{get checkbox(){const t=(s=this.element)instanceof HTMLInputElement?s:e.raise("not HTMLInputElement");var s;return"checkbox"===t.type?t:e.raise("not checkbox")}updateNode(){const{component:e,node:t,checkbox:s,nodeProperty:i,viewModelProperty:r,filters:o}=this,a=this.getViewModelValue();if(this.lastViewModelValue!==a){const l=o.length>0?n.applyForOutput(a,o,e.filters.out):a;this.lastViewModelFilteredValue!==l&&(e.updateSlot.addNodeUpdate(new U(t,i,r,l,(()=>{s.checked=l.find((e=>e===s.value))}))),this.lastViewModelFilteredValue=a),this.lastViewModelValue=a}}forceUpdateNode(){const{component:e,node:t,checkbox:s,nodeProperty:i,viewModelProperty:r,filters:o}=this,a=this.getViewModelValue(),l=o.length>0?n.applyForOutput(a,o,e.filters.out):a,c=l.find((e=>e===s.value));s.checked!==c&&e.updateSlot.addNodeUpdate(new U(t,i,r,l,(()=>{s.checked=c}))),this.lastViewModelFilteredValue=a,this.lastViewModelValue=a}updateViewModel(){const{component:e,node:t,filters:s,checkbox:i}=this,r=n.applyForInput(i.value,s,e.filters.in),o=new Set(this.getViewModelValue());i.checked?o.add(r):o.delete(r);const a=Array.from(o);this.setViewModelValue(a)}}const _=e=>Array.from(e.childNodes).flatMap((e=>_(e).concat((e=>e instanceof Comment&&(e.textContent.startsWith("@@:")||e.textContent.startsWith("@@|")))(e)?e:null))).filter((e=>e));class D{static listOfRouteIndexesByTemplate=new Map;static getTargetNodes(e,t){let s;if(this.listOfRouteIndexesByTemplate.has(e)){s=this.listOfRouteIndexesByTemplate.get(e).map((e=>((e,t)=>{for(let s=0;s<t.length;s++)e=e.childNodes[t[s]];return e})(t,e)))}else s=Array.from(t.querySelectorAll("[data-bind]")).concat(_(t)),this.listOfRouteIndexesByTemplate.set(e,s.map((e=>(e=>{let t=[];for(;null!=e.parentNode;)t=[Array.from(e.parentNode.childNodes).indexOf(e)].concat(t),e=e.parentNode;return t})(e))));return s}}class H{static create(){return{indexes:[],stack:[]}}static clone(e){const t=this.create();t.indexes=e.indexes.slice();for(const s of e.stack){const e={};e.indexes=s.indexes.slice(),e.pos=s.pos,e.propName=s.propName,t.stack.push(e)}return t}}class W{static templateByUUID=new Map}class G{binds;childNodes;fragment;context;uuid;get lastNode(){return this.childNodes[this.childNodes.length-1]}get nodesForAppend(){return this.fragment.childNodes.length>0?[this.fragment]:this.childNodes}removeFromParent(){this.childNodes.forEach((e=>this.fragment.appendChild(e))),this.binds.forEach((e=>e.removeFromParent()))}updateNode(){this.binds.forEach((e=>{e.updateNode()}))}forceUpdateNode(){this.binds.forEach((e=>{e.forceUpdateNode()}))}changeIndexes(e,t){const s=this.context.stack.find((t=>t.propName.name===e.name));if(s){this.context.indexes[s.pos]+=t;const i=s.indexes.length-1;s.indexes[i]+=t,this.context.stack.filter((t=>t.propName.setOfParentPaths.has(e.name))).forEach((e=>{e.indexes[i]+=t}))}this.binds.forEach((s=>s.changeIndexes(e,t)))}static create(e,t){const{component:s,template:i,uuid:r}=e,o=this.templateChildrenByUUID.get(r);if(void 0===o||0===o.length){const{binds:e,content:o}=fe.render(s,i,t),n=Array.from(o.childNodes);return Object.assign(new G,{binds:e,childNodes:n,fragment:o,context:t,uuid:r})}{const e=o.pop();return e.binds.forEach((e=>{e.context=t})),e}}static templateChildrenByUUID=new Map;static dispose(e){const t=this.templateChildrenByUUID.get(e.uuid);void 0===t?this.templateChildrenByUUID.set(e.uuid,[e]):t.push(e)}}class q extends k{templateChildren=[];#h;get template(){return void 0===this.#h&&(this.#h=W.templateByUUID.get(this.uuid)),this.#h}#u;get uuid(){return void 0===this.#u&&(this.#u=this.node.textContent.slice(3)),this.#u}get lastChild(){return this.templateChildren[this.templateChildren.length-1]}updateNode(){this.nodeProperty===x?this.expandLoop():this.nodeProperty===w?this.expandIf():e.raise(`unknown property ${this.nodeProperty}`)}forceUpdateNode(){this.nodeProperty===x?this.expandLoop():this.nodeProperty===w?this.forceExpandIf():e.raise(`unknown property ${this.nodeProperty}`)}removeFromParent(){this.templateChildren.forEach((e=>{e.removeFromParent(),G.dispose(e)})),this.templateChildren=[],this.lastViewModelValue=void 0,this.lastViewModelFilteredValue=void 0}appendToParent(e){const t=document.createDocumentFragment();e.forEach((e=>t.appendChild(...e.nodesForAppend))),(this.lastChild?.lastNode??this.node).after(t)}expandIf(){const{component:e,filters:t,context:s}=this,i=this.getViewModelValue();if(this.lastViewModelValue!==i){const r=t.length>0?n.applyForOutput(i,t,e.filters.out):i;if(this.lastViewModelFilteredValue!==r){if(this.removeFromParent(),r){this.templateChildren=[];const e=[G.create(this,H.clone(s))];this.appendToParent(e),this.templateChildren=e}else this.templateChildren=[];this.lastViewModelFilteredValue=r}this.lastViewModelValue=i}this.templateChildren.forEach((e=>e.forceUpdateNode()))}forceExpandIf(){const{component:e,filters:t,context:s}=this,i=this.getViewModelValue(),r=t.length>0?n.applyForOutput(i,t,e.filters.out):i;if(this.removeFromParent(),r){this.templateChildren=[];const e=[G.create(this,H.clone(s))];this.appendToParent(e),this.templateChildren=e}else this.templateChildren=[];this.lastViewModelFilteredValue=r,this.lastViewModelValue=i,this.templateChildren.forEach((e=>e.forceUpdateNode()))}expandLoop(){const{component:e,filters:t,templateChildren:s,context:i}=this,r=this.lastViewModelValue??[],o=n.applyForOutput(this.getViewModelValue(),t,e.filters.out)??[];if(r.length>o.length){this.templateChildren.splice(o.length).forEach((e=>{e.removeFromParent(),G.dispose(e)}))}else if(r.length<o.length){const e=i.indexes.length,t=this.viewModelPropertyName,s=this.contextParam?.indexes??[],n=[];for(let a=r.length;a<o.length;a++){const r=a,o=H.clone(i);o.indexes.push(r),o.stack.push({propName:t,indexes:s.concat(r),pos:e}),n.push(G.create(this,o))}this.appendToParent(n),this.templateChildren=this.templateChildren.concat(n)}this.templateChildren.forEach((e=>e.forceUpdateNode())),this.lastViewModelValue=o.slice()}changeIndexes(e,t){super.changeIndexes(e,t),this.templateChildren.forEach((s=>s.changeIndexes(e,t)))}}class K{target;thisArgument;argumentsList;constructor(e,t,s){this.target=e,this.thisArgument=t,this.argumentsList=s}}class z{queue=[];#p;constructor(e){this.#p=e}async exec(){this.#p&&this.#p(T);try{for(;this.queue.length>0;){const e=this.queue.splice(0);for(const t of e)await Reflect.apply(t.target,t.thisArgument,t.argumentsList)}}finally{this.#p&&this.#p(I)}}get isEmpty(){return 0===this.queue.length}}class Z extends k{#m;get eventType(){return this.#m}set eventType(e){this.#m=e}addEventListener(){const{component:e,element:t,eventType:s,viewModel:i,viewModelProperty:r}=this;t.addEventListener(s,(t=>{t.stopPropagation();const s=this.context,o=new K(i[E.directlyCall],i,[r,s,t]);e.updateSlot.addProcess(o)}))}}class J extends k{get node(){return super.node}set node(t){this.thisComponent=(t=>t[E.isComponent]?t:e.raise("not Component"))(t),super.node=t}#f(){return void 0!==this.viewModelProperty&&void 0!==this.nodePropertyElements}get viewModelProperty(){return super.viewModelProperty}set viewModelProperty(e){super.viewModelProperty=e,this.#f()&&this.bindProperty()}get nodePropertyElements(){return super.nodePropertyElements}set nodePropertyElements(e){super.nodePropertyElements=e,this.#f()&&this.bindProperty()}get dataNameProperty(){return this.nodePropertyElements[0]}get dataProperty(){return this.nodePropertyElements[1]}#y;get thisComponent(){return this.#y}set thisComponent(e){this.#y=e}bindProperty(){this.thisComponent.props[E.bindProperty](this.dataProperty,this.viewModelProperty,this.indexes);const e=this.dataProperty;Object.defineProperty(this.thisComponent.viewModel,e,{get:function(){return this.$props[e]},set:function(t){this.$props[e]=t}})}applyToNode(e){const{viewModelProperty:t,dataProperty:s}=this;for(const i of e){const[e,r]=i.split("\t"),o=C.create(e);if(e===t||o.setOfParentPaths.has(t)){const i=e.slice(t.length),o=((r||null)?.split(",")??[]).map((e=>Number(e)));this.thisComponent.viewModel?.[E.writeCallback](`$props.${s}${i}`,o),this.thisComponent.viewModel?.[E.writeCallback](`${s}${i}`,o),this.thisComponent.viewModel?.[E.notifyForDependentProps](`$props.${s}${i}`,o),this.thisComponent.viewModel?.[E.notifyForDependentProps](`${s}${i}`,o)}}}}const Q="style";const X="textContent";const Y={};Y[l]=class extends k{get propName(){return this.nodePropertyElements[0]}updateNode(){const{component:e,node:t,propName:s,viewModelProperty:i,filters:r}=this,o=this.getViewModelValue();if(this.lastViewModelValue!==o){const a=r.length>0?n.applyForOutput(o,r,e.filters.out):o;this.lastViewModelFilteredValue!==a&&(e.updateSlot.addNodeUpdate(new U(t,s,i,a,(()=>{t[s]=a??""}))),this.lastViewModelFilteredValue=a),this.lastViewModelValue=o}}forceUpdateNode(){const{component:e,node:t,propName:s,viewModelProperty:i,filters:r}=this,o=this.getViewModelValue(),a=r.length>0?n.applyForOutput(o,r,e.filters.out):o;t[s]!==(a??"")&&e.updateSlot.addNodeUpdate(new U(t,s,i,a,(()=>{t[s]=a??""}))),this.lastViewModelFilteredValue=a,this.lastViewModelValue=o}updateViewModel(){const{component:e,node:t,propName:s,filters:i}=this,r=n.applyForInput(t[s],i,e.filters.in);this.setViewModelValue(r)}},Y[c]=class extends k{get attrName(){return this.nodePropertyElements[1]}updateNode(){const{component:e,node:t,element:s,attrName:i,viewModelProperty:r,filters:o}=this,a=this.getViewModelValue();if(this.lastViewModelValue!==a){const l=o.length>0?n.applyForOutput(a,o,e.filters.out):a;this.lastViewModelFilteredValue!==l&&(e.updateSlot.addNodeUpdate(new U(t,i,r,l,(()=>{s.setAttribute(i,l??"")}))),this.lastViewModelFilteredValue=l),this.lastViewModelValue=a}}forceUpdateNode(){const{component:e,node:t,element:s,attrName:i,viewModelProperty:r,filters:o}=this,a=this.getViewModelValue(),l=o.length>0?n.applyForOutput(a,o,e.filters.out):a;s.getAttribute(i)!==(l??"")&&e.updateSlot.addNodeUpdate(new U(t,i,r,l,(()=>{s.setAttribute(i,l??"")}))),this.lastViewModelFilteredValue=l,this.lastViewModelValue=a}updateViewModel(){const{component:e,element:t,attrName:s,filters:i}=this,r=n.applyForInput(t.getAttribute(s),i,e.filters.in);this.setViewModelValue(r)}},Y[p]=class extends k{get className(){return this.nodePropertyElements[1]}updateNode(){const{component:e,node:t,element:s,nodeProperty:i,viewModelProperty:r,filters:o,className:a}=this,l=this.getViewModelValue();if(this.lastViewModelValue!==l){const c=o.length>0?n.applyForOutput(l,o,e.filters.out):l;this.lastViewModelFilteredValue!==c&&(e.updateSlot.addNodeUpdate(new U(t,i,r,c,(()=>{c?s.classList.add(a):s.classList.remove(a)}))),this.lastViewModelFilteredValue=l),this.lastViewModelValue=l}}forceUpdateNode(){const{component:e,node:t,element:s,nodeProperty:i,viewModelProperty:r,filters:o,className:a}=this,l=this.getViewModelValue(),c=o.length>0?n.applyForOutput(l,o,e.filters.out):l,d=s.classList.contains(a);c!==d&&e.updateSlot.addNodeUpdate(new U(t,i,r,c,(()=>{c?s.classList.add(a):s.classList.remove(a)}))),this.lastViewModelFilteredValue=l,this.lastViewModelValue=l}updateViewModel(){const{component:e,node:t,element:s,filters:i,className:r}=this,o=n.applyForInput(s.classList.contains(r),i,e.filters.in);this.setViewModelValue(o)}},Y[h]=class extends k{updateNode(){const{component:e,node:t,element:s,viewModelProperty:i,filters:r}=this,o=this.getViewModelValue();if(this.lastViewModelValue!==o){const a=r.length>0?n.applyForOutput(o,r,e.filters.out):o;this.lastViewModelFilteredValue!==a&&(e.updateSlot.addNodeUpdate(new U(t,B,i,a,(()=>{s[B]=a.join(" ")}))),this.lastViewModelFilteredValue=a),this.lastViewModelValue=o}}forceUpdateNode(){const{component:e,node:t,element:s,viewModelProperty:i,filters:r}=this,o=this.getViewModelValue(),a=r.length>0?n.applyForOutput(o,r,e.filters.out):o,l=a.join(" ");s[B]!==l&&e.updateSlot.addNodeUpdate(new U(t,B,i,a,(()=>{s[B]=l}))),this.lastViewModelFilteredValue=a,this.lastViewModelValue=o}updateViewModel(){const{component:e,node:t,element:s,filters:i,className:r}=this,o=n.applyForInput(s[B]?s[B].split(" "):[],i,e.filters.in);this.setViewModelValue(o)}},Y[u]=L,Y[m]=j,Y[g]=q,Y[f]=Z,Y[y]=J,Y[d]=class extends k{get styleName(){return this.nodePropertyElements[1]}updateNode(){const{component:e,node:t,htmlElement:s,styleName:i,viewModelProperty:r,filters:o}=this,a=this.getViewModelValue();if(this.lastViewModelValue!==a){const l=o.length>0?n.applyForOutput(a,o,e.filters.out):a;this.lastViewModelFilteredValue!==l&&(e.updateSlot.addNodeUpdate(new U(t,Q,r,l,(()=>{s[Q][i]=l}))),this.lastViewModelFilteredValue=l),this.lastViewModelValue=a}}forceUpdateNode(){const{component:e,node:t,htmlElement:s,styleName:i,viewModelProperty:r,filters:o}=this,a=this.getViewModelValue(),l=o.length>0?n.applyForOutput(a,o,e.filters.out):a;s[Q][i]!==l&&e.updateSlot.addNodeUpdate(new U(t,Q,r,l,(()=>{s[Q][i]=l}))),this.lastViewModelFilteredValue=l,this.lastViewModelValue=a}updateViewModel(){const{component:e,htmlElement:t,styleName:s,filters:i}=this,r=n.applyForInput(t[Q][s],i,e.filters.in);this.setViewModelValue(r)}},Y[a]=class extends k{updateNode(){const{component:e,node:t,viewModelProperty:s,filters:i}=this,r=this.getViewModelValue();if(this.lastViewModelValue!==r){const o=i.length>0?n.applyForOutput(r,i,e.filters.out):r;this.lastViewModelFilteredValue!==o&&(e.updateSlot.addNodeUpdate(new U(t,X,s,o,(()=>{t[X]=o??""}))),this.lastViewModelFilteredValue=o),this.lastViewModelValue=r}}forceUpdateNode(){const{component:e,node:t,viewModelProperty:s,filters:i}=this,r=this.getViewModelValue(),o=i.length>0?n.applyForOutput(r,i,e.filters.out):r;t[X]!==(o??"")&&e.updateSlot.addNodeUpdate(new U(t,X,s,o,(()=>{t[X]=o??""}))),this.lastViewModelFilteredValue=o,this.lastViewModelValue=r}updateViewModel(){const{component:e,node:t,filters:s}=this,i=n.applyForInput(t[X],s,e.filters.in);this.setViewModelValue(i)}};class ee{static create(t,s,i,r,o,n,a){const l=S.get(s,i),c=new Y[l.type];return c.component=t,c.node=s,c.nodeProperty=i,c.viewModel=r,c.viewModelProperty=o,c.filters=n,c.context=a,c.nodePropertyElements=l.nodePropertyElements,c.eventType=l.eventType,c.viewModelPropertyName.level>0&&0===c.indexes.length&&e.raise(`${c.viewModelPropertyName.name} is outside loop`),c}}class te{nodeProperty;viewModelProperty;filters}const se=e=>e.trim(),ie=e=>e.length>0,re=e=>{const[t,...s]=e.split("|").map(se);return{viewModelProperty:t,filters:s.map((e=>(e=>{const[t,...s]=e.split(",").map(se);return Object.assign(new n,{name:t,options:s})})(e)))}},oe=(t,s)=>t.split(";").map(se).filter(ie).map((t=>{let{nodeProperty:i,viewModelProperty:r,filters:o}=((e,t)=>{const[s,i]=[t].concat(...e.split(":").map(se)).splice(-2),{viewModelProperty:r,filters:o}=re(i);return{nodeProperty:s,viewModelProperty:r,filters:o}})(t,"$");return r="@"===r?i:r,i="$"===i?s:i,void 0===i&&e.raise("default property undefined"),{nodeProperty:i,viewModelProperty:r,filters:o}}));class ne{static bindTextsByKey={};static parse(e,t){const s=e+"\t"+t;let i=this.bindTextsByKey[s];return void 0===i&&(i=oe(e,t).map((e=>Object.assign(new te,e))),this.bindTextsByKey[s]=i),i}}class ae{static parseBindText=(e,t,s,i,r,o)=>ne.parse(r,o).map((r=>ee.create(t,e,r.nodeProperty,s,r.viewModelProperty,r.filters,i)));static applyUpdateNode=e=>e.updateNode()}const le="oninput",ce=le.slice(2);class de{static bind(t,s,i){const r=s.viewModel,o=(t=>t instanceof HTMLElement?t:e.raise("not HTMLElement"))(t),n=o.getAttribute("data-bind"),a=(e=>e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement||e instanceof HTMLOptionElement?"value":e instanceof HTMLInputElement?"radio"===e.type||"checkbox"===e.type?"checked":"value":"textContent")(o),l=ae.parseBindText(t,s,r,i,n,a);l.forEach(ae.applyUpdateNode);let c=!1,d=null,p=null,h=null;l.forEach((e=>{c||=e.nodeProperty===le,p=e instanceof L?e:p,h=e instanceof j?e:h,d=e.nodeProperty===a?e:d,(e=>e instanceof Z?e:void 0)(e)?.addEventListener()}));const u=e=>{const t=t=>{t.stopPropagation();const i=new K(e.updateViewModel,e,[]);s.updateSlot.addProcess(i)};o.addEventListener(ce,t),e.defaultEventHandler=t,e.defaultEventType=ce};return p?u(p):h?u(h):d&&!c&&(e=>e instanceof HTMLElement&&(e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement||e instanceof HTMLInputElement))(t)&&u(d),l}}class pe{static bind(t,s,i){const r=s.viewModel,o=(t=>t instanceof SVGElement?t:e.raise("not SVGElement"))(t),n=o.getAttribute("data-bind"),a=ae.parseBindText(t,s,r,i,n,undefined);return a.forEach(ae.applyUpdateNode),a.forEach((e=>{(e=>e instanceof Z?e:void 0)(e)?.addEventListener()})),a}}class he{static bind(t,s,i){const r=s.viewModel,o=(t=>t instanceof Comment?t:e.raise("not Comment"))(t),n=o.textContent.slice(3),a=document.createTextNode("");o.parentNode.replaceChild(a,o);const l=ae.parseBindText(a,s,r,i,n,"textContent");return l.forEach(ae.applyUpdateNode),l}}class ue{static bind(t,s,i){const r=s.viewModel,o=(t=>t instanceof Comment?t:e.raise("not Comment"))(t),n=o.textContent.slice(3),a=W.templateByUUID.get(n).getAttribute("data-bind");let l=ae.parseBindText(t,s,r,i,a,void 0);return l=l.length>0?[l[0]]:[],l.forEach(ae.applyUpdateNode),l}}class me{static bind(t,s,i){return t.flatMap((t=>t instanceof Comment&&":"==t.textContent[2]?he.bind(t,s,i):t instanceof HTMLElement?de.bind(t,s,i):t instanceof Comment&&"|"==t.textContent[2]?ue.bind(t,s,i):t instanceof SVGElement?pe.bind(t,s,i):e.raise("unknown node type")))}}class fe{static render(e,t,s){const i=document.importNode(t.content,!0),r=D.getTargetNodes(t,i);return{binds:me.bind(r,e,s),content:i}}}class ye{static render(e,t,s){const{binds:i,content:r}=fe.render(t,s,H.create());return e.appendChild(r),i}}class ge{#g=new Map;get(e,t){const s=this.#g.get(e);return s?s.get(t.toString()):void 0}set(e,t,s){let i=this.#g.get(e);return i||(i=new Map,this.#g.set(e,i)),i.set(t.toString(),s),s}clear(){this.#g.clear()}}class we{static getDescByName(e){const t=new Map;let s=e;for(;s!==Object.prototype;){const e=Object.getOwnPropertyDescriptors(s);for(const[s,i]of Object.entries(e))t.has(s)||t.set(s,i);s=Object.getPrototypeOf(s)}return t}static getMethods(e,t){return e.filter((([e,s])=>s.value!==t&&"function"==typeof s.value))}static getProperties(e,t){return e.filter((([e,s])=>s.value!==t&&"function"!=typeof s.value))}static viewModelize(e){const t=e.constructor;let s=this.viewModelInfoByConstructor.get(t);if(!s){const i=this.getDescByName(e),r=Array.from(i.entries()),o=[],n=[],a=[],l=this.getMethods(r,e.constructor).map((([e,t])=>e));this.getProperties(r,e.constructor).forEach((([e,t])=>{n.push(e);C.create(e).isPrimitive||"value"in t&&void 0===t.value&&o.push(e),"get"in t&&void 0!==t.get&&a.push(e)})),s={removeProps:o,definedProps:n,methods:l,accessorProps:a},this.viewModelInfoByConstructor.set(t,s)}return s.removeProps.forEach((t=>Reflect.deleteProperty(e,t))),{definedProps:s.definedProps,methods:s.methods,accessorProps:s.accessorProps,viewModel:e}}static viewModelInfoByConstructor=new Map}class xe{#w=new Set;#x=new Map;get setOfPropsByRefProp(){return this.#x}hasDefaultProp(e){return this.#w.has(e)}addDefaultProp(e){let t=C.create(e);for(;""!==t.parentPath;){const e=C.create(t.parentPath);this.#w.has(t.name)||(this.#x.get(e.name)?.add(t.name)??this.#x.set(e.name,new Set([t.name])),this.#w.add(t.name)),t=e}}setDependentProps(e){for(const[t,s]of Object.entries(e))for(const e of s)this.#x.get(e)?.add(t)??this.#x.set(e,new Set([t]))}}const Pe={[E.connectedCallback]:"$connectedCallback",[E.disconnectedCallback]:"$disconnectedCallback",[E.writeCallback]:"$writeCallback",[E.initCallback]:"$initCallback"},ve=new Set([E.connectedCallback,E.disconnectedCallback,E.writeCallback,E.initCallback]),be=new Set([E.directlyCall,E.getDependentProps,E.notifyForDependentProps,E.getHandler,E.beCacheable,E.beUncacheable]),Ne="$props",Me="$globals",Ce="$dependentProps",Ve="$openDialog",Ee=new Set([Ne,Me,Ce,Ve,"$closeDialog"]);class Se extends V{#P;get component(){return this.#P}#v=new ge;get cache(){return this.#v}#b;get methods(){return this.#b}#N;get accessorProperties(){return this.#N}#M;get setOfAccessorProperties(){return this.#M}#C=new xe;get dependentProps(){return this.#C}#V=!1;get cacheable(){return this.#V}set cacheable(e){this.#V=e}#d;get context(){return this.#d}set context(e){this.#d=e}constructor(e,t,s,i){super(),this.#P=e,this.#b=s,this.#N=t,this.#M=new Set(this.#N),this.#C.setDependentProps(i??{})}getByPropertyName(e,{propName:t},s){let i;if(t.isPrimitive||!this.#C.hasDefaultProp(t.name)&&this.#C.addDefaultProp(t.name),Ee.has(t.name))return t.name===Ne?this.component.props:t.name===Me?this.component.globals:t.name===Ce?Reflect.get(e,Ce,s):t.name===Ve?(t,i={},r={})=>Reflect.apply(this.#E,this,[e,{name:t,data:i,attributes:r},s]):(t={})=>Reflect.apply(this.#S,this,[e,t,s]);if(this.#M.has(t.name)&&this.#V){const r=t.level>0?this.lastIndexes.slice(0,t.level):[];i=this.#v.get(t,r),void 0===i&&(i=super.getByPropertyName(e,{propName:t},s),this.#v.set(t,r,i))}else i=super.getByPropertyName(e,{propName:t},s);return i}setByPropertyName(e,{propName:t,value:s},i){t.isPrimitive||!this.#C.hasDefaultProp(t.name)&&this.#C.addDefaultProp(t.name);const r=this.lastIndexes,o={propName:t,indexes:r},n=super.setByPropertyName(e,{propName:t,value:s},i);return i[E.writeCallback](t.name,r),this.#k(e,o,i),n}#T(e,t,s){this.#P.updateSlot.addProcess(new K(e,t,s))}#k(e,t,s){this.#P.updateSlot.addNotify(t)}async#E(t,{name:s,data:i,attributes:r},o){const n=e.toKebabCase(s),a=document.createElement(n);return Object.entries(r).forEach((([e,t])=>{a.setAttribute(e,t)})),Object.entries(i).forEach((([e,t])=>{a.props[E.bindProperty](e,e,[]),a.props[e]=t})),document.body.appendChild(a),a.alivePromise}#S(e,t,s){const i=this.#P;Object.entries(t).forEach((([e,t])=>{i.props[e]=t})),i.parentNode.removeChild(i)}[E.directlyGet](e,{prop:t,indexes:s},i){return super[E.directlyGet](e,{prop:t,indexes:s},i)}[E.beCacheable](e,t){return this.cacheable=!0,this.#v.clear(),this.cacheable}[E.beUncacheable](e,t){return this.cacheable=!1,this.cacheable}async#I(t,{propName:s,context:i,event:r},o){void 0!==this.context&&e.raise("directCall already called"),this.context=i,this.stackIndexes.push(void 0);try{return await Reflect.apply(t[s.name],o,[r,...i.indexes])}finally{this.stackIndexes.pop(),this.context=void 0}}get(t,s,i){if(ve.has(s)){const e=Pe[s],r=(...s)=>async()=>Reflect.apply(t[e],i,s);return s===E.initCallback?e in t?(...e)=>r(...e)():()=>{}:e in t?(...e)=>this.#T(r(...e),i,[]):()=>{}}if(be.has(s))return s===E.directlyCall?async(e,s,r)=>this.#I(t,{propName:C.create(e),context:s,event:r},i):s===E.notifyForDependentProps?(e,s)=>{const r={propName:C.create(e),indexes:s};this.#k(t,r,i)}:s===E.getDependentProps?()=>this.dependentProps:s===E.getHandler?()=>this:s===E.beCacheable?()=>Reflect.apply(this[E.beCacheable],this,[t,i]):()=>Reflect.apply(this[E.beUncacheable],this,[t,i]);{let r;do{if("string"==typeof s&&!s.startsWith("@@__")&&"constructor"!==s){const o=C.create(s);if(void 0!==this.context&&o.level>0&&"@"!==s.at(0)){const n=this.context.stack.find((e=>e.propName.name===o.nearestWildcardParentName));void 0===n&&e.raise(`${s} is outside loop`),r=this[E.directlyGet](t,{prop:s,indexes:n.indexes},i);break}}r=super.get(t,s,i)}while(0);return r}}set(t,s,i,r){let o;do{if("string"==typeof s&&!s.startsWith("@@__")&&"constructor"!==s){const n=C.create(s);if(void 0!==this.context&&n.level>0&&"@"!==s.at(0)){const a=this.context.stack.find((e=>e.propName.name===n.nearestWildcardParentName));void 0===a&&e.raise(`${s} is outside loop`),o=this[E.directlySet](t,{prop:s,indexes:a.indexes,value:i},r);break}}o=super.set(t,s,i,r)}while(0);return o}static makeNotifyForDependentProps(e,t,s=new Set([])){const{propName:i,indexes:r}=t,o=i.name+"\t"+r.toString();if(s.has(o))return[];s.add(o);const n=e[E.getDependentProps]().setOfPropsByRefProp.get(i.name),a=[];if(void 0===n)return[];for(const t of n){const i=C.create(t);if(r.length<i.level){const t=Se.expandIndexes(e,{propName:i,indexes:r});a.push(...t.map((e=>({propName:i,indexes:e}))))}else{const e=r.slice(0,i.level);a.push({propName:i,indexes:e})}a.push(...this.makeNotifyForDependentProps(e,{propName:i,indexes:r},s))}return a}static expandIndexes(e,t){const{propName:s,indexes:i}=t;if(s.level===i.length)return[i];if(s.level<i.length)return[i.slice(0,s.level)];{const t=(r,o,n)=>{const a=""!==r?r+".":r,l=s.pathNames[o],c=s.pathNames.length-1===o,d=a+l;let p;return p=c?"*"===l?e[E.directlyGet](r,n).flatMap(((e,t)=>[n.concat(t)])):[n]:"*"===l?n.length<i.length?t(d,o+1,i.slice(0,n.length+1)):e[E.directlyGet](r,n).flatMap(((e,s)=>t(d,o+1,n.concat(s)))):t(d,o+1,n),p};return t("",0,[])}}}const ke=e=>e instanceof q?e:void 0;class Te{static getTemplateBinds(e,t){const s=[],i=[{binds:e,children:null,index:-1}];for(;i.length>0;){const e=i[i.length-1];if(e.index++,e.binds)if(e.index<e.binds.length){const r=ke(e.binds[e.index]);r&&(t.has(r.viewModelPropertyKey)?s.push(r):r.templateChildren.length>0&&i.push({binds:null,children:r.templateChildren,index:-1}))}else i.pop();else if(e.index<e.children.length){const t=e.children[e.index];t.binds.length>0&&i.push({binds:t.binds,children:null,index:-1})}else i.pop()}return s}static applyToNode(e,t){const s=new Set(this.getTemplateBinds(e,t));if(s.size>0)for(const e of s)e.updateNode();const i=e=>{e.forEach((e=>{s.has(e)||(e instanceof J?e.applyToNode(t):t.has(e.viewModelPropertyKey)&&e.updateNode()),ke(e)?.templateChildren.forEach((e=>i(e.binds)))}))};i(e)}}let Ie=class{#P;#O=new Map;#F=new Proxy({},new V);get hasParent(){return null!=this.#P?.parentComponent?.viewModel}get data(){return this.hasParent?this.#P.parentComponent.viewModel:this.#F}get object(){const e={};if(this.hasParent){const t=this.#P.parentComponent.viewModel;for(const[s,i]of this.#O.entries()){const{bindProp:r,bindIndexes:o}=i;e[s]=t[E.directlyGet](r,o)}}else for(const[t,s]of Object.entries(this.#F))e[t]=s;return e}constructor(e){this.#P=e}get(e,t,s){if(t===E.bindProperty)return(e,t,s)=>this.#O.set(e,{bindProp:t,bindIndexes:s});if(t===E.toObject)return()=>this.object;const{data:i}=this;if(this.hasParent){const{bindProp:e,bindIndexes:s}=this.#O.get(t)??{};return e?i[E.directlyGet](e,s):void console.error(`undefined property ${t}`)}return Reflect.get(i,t)}set(e,t,s,i){const{data:r}=this;if(this.hasParent){const{bindProp:e,bindIndexes:i}=this.#O.get(t)??{};return e?r[E.directlySet](e,i,s):(console.error(`undefined property ${t}`),!1)}return Reflect.set(r,t,s)}};class Oe extends V{#R=new Map;get(e,t,s){return t===E.boundByComponent?(e,t)=>{let s=this.#R.get(t);null==s?this.#R.set(t,new Set([e])):s.add(e)}:super.get(e,t,s)}set(e,t,s,i){const{propName:r,indexes:o}=C.parse(t),n=i[E.directlySet](r.name,o,s);let a=this.#R.get(r.name);if(a)for(const e of a)e.viewModel[E.notifyForDependentProps]("$globals."+r.name,o);return n}}class Fe{static create(){return new Proxy({},new Oe)}static data=this.create()}class Re{#P;setOfProps=new Set;constructor(e){this.#P=e}bindProperty(e){Fe.data[E.boundByComponent](this.#P,e),this.setOfProps.add(e)}directGet=(e,t)=>(this.setOfProps.has(e)||this.bindProperty(e),Fe.data[E.directlyGet](e,t));directSet=(e,t,s)=>(this.setOfProps.has(e)||this.bindProperty(e),Fe.data[E.directlySet](e,t,s));get(e,t,s){if(t===E.directlyGet)return this.directGet;if(t===E.directlySet)return this.directSet;if(t===E.isSupportDotNotation)return!0;const{propName:i,indexes:r}=C.parse(t);return this.directGet(i.name,r)}set(e,t,s,i){const{propName:r,indexes:o}=C.parse(t);return this.directSet(r.name,o,s)}}const Ae="data-bind";class Ue{html;css;ViewModel;extendClass;extendTag;inputFilters;outputFilters;componentModules;#h;get template(){return void 0===this.#h&&(this.#h=Ue.htmlToTemplate(this.html,this.css)),this.#h}static replaceTag(t){const s=[],i=t.replaceAll(/\{\{([^\}]+)\}\}/g,((e,t)=>{if((t=t.trim()).startsWith("loop:")||t.startsWith("if:"))return s.push(t),`<template data-bind="${t}">`;if(t.startsWith("else:")){return`</template><template data-bind="${s.at(-1)}|not">`}return t.startsWith("end:")?(s.pop(),"</template>"):`\x3c!--@@:${t}--\x3e`})),r=document.createElement("template");r.innerHTML=i;const o=t=>{let s;for(;s=t.querySelector("template");){const t=e.createUUID(),i=document.createComment(`@@|${t}`);if(s.parentNode.replaceChild(i,s),!(s instanceof HTMLTemplateElement)){const e=document.createElement("template");for(let t of Array.from(s.childNodes))e.content.appendChild(t);e.setAttribute(Ae,s.getAttribute(Ae)),s=e}s.setAttribute("data-uuid",t),o(s.content),W.templateByUUID.set(t,s)}};return o(r.content),r.innerHTML}static htmlToTemplate(e,t){const s=document.createElement("template");return s.innerHTML=(t?`<style>\n${t}\n</style>`:"")+(e?Ue.replaceTag(e):""),s}}class $e{static#A={debug:!1};static components(t){return Object.entries(t).forEach((([t,s])=>{const i=e.toKebabCase(t);customElements.define(i,s)})),this}static registComponentModule(t,s){const i=e.toKebabCase(t),r=We.generate(s);s.extendTag?customElements.define(i,r,{extends:s.extendTag}):void 0===s?.extendClass?customElements.define(i,r):e.raise("extendTag should be set"),s.componentModules&&this.componentModules(s.componentModules)}static componentModules(e){return Object.entries(e).forEach((([e,t])=>{this.registComponentModule(e,t)})),this}static filters(e){return Object.entries(e).forEach((([e,t])=>{const{input:s,output:i}=t;n.regist(e,i,s)})),this}static globals(e){Object.assign(Fe.data,e)}static config({debug:e=!1}){return this.#A=Object.assign(this.#A,{debug:e}),this}static get debug(){return this.#A.debug}}class Be extends Error{}class Le{#U;#$;#B=!0;get alive(){return this.#B}constructor(){this.main()}async#L(){return new Promise(((e,t)=>{this.#U=e,this.#$=t}))}stop(){this.#$(new Be("stop"))}wakeup(e){this.#U(e)}async main(){for(;;)try{const e=await this.#L();await e.waiting(),$e.debug&&performance.mark("slot-exec:start");try{await e.exec(),$e.debug&&(performance.mark("slot-exec:end"),performance.measure("slot-exec","slot-exec:start","slot-exec:end"),console.log(performance.getEntriesByType("measure")),performance.clearMeasures(),performance.clearMarks())}finally{e.callback()}}catch(e){if(e instanceof Be)break;if(console.error(e),!confirm("致命的なエラーが発生しました。続行しますか？"))break}this.#B=!1}}class je{queue=[];#p;#P;constructor(e,t){this.#P=e,this.#p=t}async exec(){this.#p&&this.#p(O);try{for(;this.queue.length>0;){const e=this.queue.splice(0),t=[];for(const s of e)t.push(...Se.makeNotifyForDependentProps(this.#P.viewModel,s));const s=new Set(e.concat(t).map((e=>e.propName.name+"\t"+e.indexes.toString())));this.#P.applyToNode(s)}}finally{this.#p&&this.#p(F)}}get isEmpty(){return 0===this.queue.length}}class _e{#j;get viewModelUpdator(){return this.#j}#_;get notifyReceiver(){return this.#_}#D;get nodeUpdator(){return this.#D}#H;#W;#G;#q;#K;#z;#Z;constructor(e,t=null,s=null){this.#j=new z(s),this.#_=new je(e,s),this.#D=new $(s),this.#H=t,this.#W=new Promise(((e,t)=>{this.#q=e,this.#K=t})),this.#G=new Promise(((e,t)=>{this.#z=e,this.#Z=t}))}async waiting(){return this.#W}waitResolve(e){this.#q(e)}waitReject(){this.#K()}async alive(){return this.#G}async exec(){do{await this.#j.exec(),await this.#_.exec(),await this.#D.exec()}while(!this.#j.isEmpty||!this.#_.isEmpty||!this.#D.isEmpty);this.#z()}async addProcess(e){this.#j.queue.push(e),this.#q(!0)}async addNotify(e){this.#_.queue.push(e),this.#q(!0)}async addNodeUpdate(e){this.#D.queue.push(e),this.#q(!0)}callback(){this.#H&&this.#H()}static create(e,t,s){return new _e(e,t,s)}}class De{static setOfAttachableTags=new Set(["articles","aside","blockquote","body","div","footer","h1","h2","h3","h4","h5","h6","header","main","nav","p","section","span"]);static isCustomTag(e){return-1!==e.indexOf("-")}static isAttachable(e){return this.isCustomTag(e)||this.setOfAttachableTags.has(e)}}const He={get viewModel(){return this._viewModel},set viewModel(e){this._viewModel=e},get binds(){return this._binds},set binds(e){this._binds=e},get thread(){return this._thread},set thread(e){this._thread=e},get updateSlot(){return void 0===this._updateSlot&&(this._updateSlot=_e.create(this,(()=>{this._updateSlot=void 0}),(e=>{e===T||e===O?this.viewModel[E.beUncacheable]():e===R&&this.viewModel[E.beCacheable]()})),this.thread.wakeup(this._updateSlot)),this._updateSlot},set updateSlot(e){this._updateSlot=e},get props(){return this._props},get globals(){return this._globals},get initialResolve(){return this._initialResolve},set initialResolve(e){this._initialResolve=e},get initialReject(){return this._initialReject},set initialReject(e){this._initialReject=e},get initialPromise(){return this._initialPromise},set initialPromise(e){this._initialPromise=e},get aliveResolve(){return this._aliveResolve},set aliveResolve(e){this._aliveResolve=e},get aliveReject(){return this._aliveReject},set aliveReject(e){this._aliveReject=e},get alivePromise(){return this._alivePromise},set alivePromise(e){this._alivePromise=e},get parentComponent(){return void 0===this._parentComponent&&(this._parentComponent=(e=>{for(;;){if(null==(e=e.parentNode))return null;if(e[E.isComponent])return e;if(e instanceof ShadowRoot){if(e.host[E.isComponent])return e.host;e=e.host}}})(this)),this._parentComponent},get withShadowRoot(){return this.hasAttribute("with-shadow-root")},get viewRootElement(){return this.shadowRoot??this},get filters(){return this._filters},initialize(){this._viewModel=function(e,t){const s=we.viewModelize(Reflect.construct(t,[])),{viewModel:i,accessorProps:r,methods:o}=s;return new Proxy(i,new Se(e,r,o,i[Ce]))}(this,this.constructor.ViewModel),this._binds=void 0,this._thread=void 0,this._updateSlot=void 0,this._props=new Proxy({},new Ie(this)),this._globals=function(e){return new Proxy({},new Re(e))}(),this._initialPromise=void 0,this._initialResolve=void 0,this._initialReject=void 0,this._alivePromise=void 0,this._aliveResolve=void 0,this._aliveReject=void 0,this._parentComponent=void 0,this._filters={in:class extends o{},out:class extends r{}},this.initialPromise=new Promise(((e,t)=>{this.initialResolve=e,this.initialReject=t}))},async build(){const{template:t,ViewModel:s,inputFilters:i,outputFilters:r}=this.constructor;if(void 0!==i)for(const[t,s]of Object.entries(i))t in this.filters.in&&e.raise(`already exists filter ${t}`),this.filters.in[t]=s;if(void 0!==r)for(const[t,s]of Object.entries(r))t in this.filters.out&&e.raise(`already exists filter ${t}`),this.filters.out[t]=s;De.isAttachable(this.tagName.toLowerCase())&&this.withShadowRoot&&this.attachShadow({mode:"open"}),this.thread=new Le,await this.viewModel[E.initCallback]();const o=this.updateSlot;o.addProcess(new K((async()=>(this.binds=ye.render(this.viewRootElement,this,t),this.viewModel[E.connectedCallback]())),this,[])),await o.alive()},async connectedCallback(){try{this.parentComponent&&await this.parentComponent.initialPromise,this.alivePromise=new Promise(((e,t)=>{this.aliveResolve=e,this.aliveReject=t})),await this.build()}finally{this.initialResolve&&this.initialResolve()}},disconnectedCallback(){this.aliveResolve&&this.aliveResolve(this.props[E.toObject]())},applyToNode(e){this.binds&&Te.applyToNode(this.binds,e)}};class We{static generate(e){const t=Object.assign(new Ue,e),s=function(e){return class extends HTMLElement{static template=e.template;static ViewModel=e.ViewModel;static inputFilters=e.inputFilters;static outputFilters=e.outputFilters;get[E.isComponent](){return!0}constructor(){super(),this.initialize()}}}(t);if(void 0===t.extendClass&&void 0===t.extendTag);else{const e=t.extendClass??document.createElement(t.extendTag).constructor;s.prototype.__proto__=e.prototype,s.__proto__=e}for(let[e,t]of Object.entries(Object.getOwnPropertyDescriptors(He)))Object.defineProperty(s.prototype,e,t);return s}}function Ge(e){return We.generate(e)}class qe{static regist(e,t){}}class Ke{static toKebabCase=e=>"string"==typeof e?e.replaceAll(/[\._]/g,"-").replaceAll(/([A-Z])/g,((e,t,s)=>(s>0?"-":"")+t.toLowerCase())):e}const ze="kebab",Ze="snake",Je="uppercamel",Qe="lowercamel",Xe="dotted";class Ye{static getNames(e){const t=Ke.toKebabCase(e),s=t.replaceAll("-","_"),i=t.replaceAll("-","."),r=t.split("-").map(((e,t)=>(void 0!==e[0]&&(e=e[0].toUpperCase()+e.slice(1)),e))).join(""),o=r.length>0?r[0].toLowerCase()+r.slice(1):r;return{[ze]:t,[Ze]:s,[Je]:r,[Qe]:o,[Xe]:i}}}const et=Qe;class tt{defaultNameType=et;defaultPath="./";loadNames=[];prefixMap}class st{prefix;path;get matchPrefix(){return`${this.prefix}-`}isMatch(e){return e.startsWith(this.matchPrefix)}getNames(e){const{prefix:t,path:s}=this;if(e.startsWith(this.matchPrefix)){return{prefixName:t,subName:e.slice(this.matchPrefix.length),path:s}}}}const it=Ye.getNames("prefix-name"),rt=Ye.getNames("sub-name");class ot{static getPathInfo(e,t,s,i){const[r,o]=e.split("#");let n=r,a=o;const l=Ye.getNames(t),c=Ye.getNames(s);return n=n.replaceAll(`{${it[ze]}}`,l[ze]),n=n.replaceAll(`{${it[Ze]}}`,l[Ze]),n=n.replaceAll(`{${it[Qe]}}`,l[Qe]),n=n.replaceAll(`{${it[Je]}}`,l[Je]),n=n.replaceAll(`{${it[Xe]}}`,l[Xe]),n=n.replaceAll(`{${rt[ze]}}`,c[ze]),n=n.replaceAll(`{${rt[Ze]}}`,c[Ze]),n=n.replaceAll(`{${rt[Qe]}}`,c[Qe]),n=n.replaceAll(`{${rt[Je]}}`,c[Je]),n=n.replaceAll(`{${rt[Xe]}}`,c[Xe]),r===n&&".js"!==n.slice(-3)&&(n=n+("/"!==e.slice(-1)?"/":"")+c[i]+".js"),a&&(a=a.replaceAll(`{${rt[ze]}}`,c[ze]),a=a.replaceAll(`{${rt[Ze]}}`,c[Ze]),a=a.replaceAll(`{${rt[Qe]}}`,c[Qe]),a=a.replaceAll(`{${rt[Je]}}`,c[Je]),a=a.replaceAll(`{${rt[Xe]}}`,c[Xe])),{filePath:n,exportName:a}}}class nt{#J;#A;#Q;#X;#Y;constructor(e){this.#X=e,this.#Y=window.location,this.setConfig(new tt)}setConfig(e){this.#A=Object.assign(new tt,e),"prefixMap"in e&&void 0!==e.prefixMap&&this.setPrefixMap(e.prefixMap)}getConfig(){return this.#A}setPrefixMap(e){this.#Q=new Map(Object.entries(e).map((([e,t])=>[e=Ke.toKebabCase(e),Object.assign(new st,{prefix:e,path:t})])))}getPrefixMap(){return this.#Q}configFile(e){return this.#J=e,this}config(e){return this.setConfig(e),this}prefixMap(e){return this.setPrefixMap(e),this}get registrar(){return this.#X}async loadConfig(e){const t=this.#Y.pathname.split("/");t[t.length-1]=e;const s=this.#Y.origin+t.join("/");try{const e=await fetch(s),t=await e.json();return Object.assign(new tt,t)}catch(e){throw new Error(e)}}async load(...e){if(void 0!==this.#J){const e=await this.loadConfig(this.#J);this.setConfig(e)}if(void 0===this.#Q)throw new Error("prefixMap is not defined");if(void 0===this.#X)throw new Error("registrar is not defined");const t=Array.from(this.#Q.values()),{defaultNameType:s,defaultPath:i}=this.#A;e=e.length>0?e:this.#A.loadNames;for(let r of e){let e;r=Ke.toKebabCase(r);const o=t.find((e=>e.isMatch(r)));if(void 0!==o){const t=o.getNames(r);e=ot.getPathInfo(t.path,t.prefixName,t.subName,s)}if(void 0===e&&void 0!==i&&(e=ot.getPathInfo(i,"",r,s)),void 0===e)throw new Error(`unmatch prefix and no defaultPath (loadName:${r})`);const n=this.#Y.pathname.split("/");n[n.length-1]=e.filePath;const a=this.#Y.origin+n.join("/");let l,c;try{l=await import(a)}catch(e){throw new Error(e)}if(void 0!==e.exportName){if(!(e.exportName in l))throw new Error(`${e.exportName} not found in module (exportName:${e.exportName}, ${e.filePath})`);c=l[e.exportName]}else c=l.default;this.#X.regist(r,c)}return this}static create(e){return new nt(e)}}const at=nt.create(class extends qe{static regist(e,t){if(e.startsWith("filter-")){const s=e.slice("filter-".length),{output:i,input:r}=t;n.regist(s,i,r)}else $e.registComponentModule(e,t)}});export{$e as default,Ge as generateComponentClass,at as loader};
